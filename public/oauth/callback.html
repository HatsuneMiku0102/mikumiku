<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finish sign-in</title>

<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:#e5e7eb;
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
    background:
      radial-gradient(1200px 600px at 20% 10%,#0b1730,#070b15 65%),
      radial-gradient(1000px 400px at 90% 110%,#0a1228,#070b15 60%);
  }
  .container{max-width:1000px;margin:6vh auto;padding:24px}
  .card{
    background:linear-gradient(180deg,#111827cc,#0b1324cc);
    border:1px solid #1f2937;border-radius:18px;overflow:hidden;
    box-shadow:0 10px 40px #0006
  }
  .header{padding:22px;border-bottom:1px solid #1f2937}
  .title{margin:0;font-size:20px;display:flex;gap:10px;align-items:center}
  .dot{width:10px;height:10px;border-radius:999px;background:#34d399;box-shadow:0 0 20px #34d39955}
  .sub{margin:6px 0 0;color:#9ca3af;font-size:14px}
  .body{padding:22px}
  .row{margin:12px 0}
  .flex{display:flex;align-items:center;gap:12px;flex-wrap:wrap}

  .spinner{width:32px;height:32px;border:3px solid #34d39933;border-top-color:#34d399;border-radius:999px;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .input,select,button{font:inherit}
  .input,select{
    width:100%;background:#0b1220;color:#e5e7eb;border:1px solid #334155;border-radius:12px;
    padding:12px 14px;outline:none;transition:border .15s ease,box-shadow .15s ease;font-size:15px
  }
  .input:focus,select:focus{border-color:#34d399;box-shadow:0 0 0 4px #34d39933}

  .btn{
    appearance:none;border:1px solid #10b981;background:linear-gradient(180deg,#34d399,#10b981);color:#fff;
    padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;transition:transform .08s ease,box-shadow .2s ease;
    box-shadow:0 8px 24px #10b98144;text-decoration:none;display:inline-flex;align-items:center;gap:8px
  }
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.secondary{background:none;color:#e5e7eb;border-color:#334155;box-shadow:none}

  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:960px){.grid{grid-template-columns:2fr 3fr}}

  .badge{display:inline-block;padding:6px 10px;border:1px solid #38485f;border-radius:999px;font-size:12px;color:#c7d2fe;background:#0b1220}
  .err{color:#fca5a5}
  .ok{color:#86efac}
  .panel{background:#0a0f1d;border:1px solid #1f2937;border-radius:14px;padding:14px}

  .card-mini{display:flex;gap:14px;align-items:center}
  .avatar{width:72px;height:72px;border-radius:12px;object-fit:cover;background:#0b1220;border:1px solid #1f2937}
  .meta{display:grid;gap:4px}
  .kv{display:flex;gap:8px;flex-wrap:wrap}
  .kv span{padding:4px 8px;border:1px solid #334155;border-radius:999px;font-size:12px;color:#cbd5e1}
  .muted{color:#9ca3af}

  .skel{position:relative;overflow:hidden;background:#0b1220;border:1px solid #1f2937;border-radius:12px}
  .skel::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.05),transparent);animation:sh 1.2s infinite}
  @keyframes sh{from{transform:translateX(-100%)}to{transform:translateX(100%)}}

  .shortcuts{font-size:12px;color:#9ca3af}
  .note{padding:12px 14px;border:1px solid #78350f;background:#111827;border-radius:12px}

  .steps{display:grid;gap:8px}
  .step{display:flex;align-items:center;gap:8px;font-size:14px}
  .chk{width:18px;height:18px;border-radius:999px;border:2px solid #334155;display:inline-grid;place-items:center;font-size:12px}
  .chk.ok{border-color:#34d399;background:#34d399;color:#052e25}
  .small{font-size:12px;color:#9ca3af}
</style>

<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1 class="title"><span class="dot"></span>Finishing sign-in</h1>
        <p class="sub">Pick your character and submit</p>
      </div>
      <div class="body">

        <!-- STEP: loading -->
        <div id="step-loading" class="row flex">
          <div class="spinner"></div><div>Talking to server…</div>
        </div>

        <!-- STEP: error -->
        <div id="step-error" class="row" style="display:none">
          <div class="row err" id="err-text"></div>
          <div class="row"><a class="btn secondary" href="/">Return</a> <button id="retry" class="btn secondary">Retry</button></div>
        </div>

        <!-- STEP: select -->
        <div id="step-select" style="display:none">
          <div class="row flex">
            <span class="badge" id="who"></span>
            <span class="shortcuts">Enter to submit • ↑/↓ to move • Double-click to quick submit</span>
          </div>

          <div class="grid">
            <div class="panel">
              <div class="row"><input id="q" class="input" placeholder="Search name or realm"></div>
              <div class="row"><select id="choice" size="12" style="height:360px"></select></div>
              <div class="row"><span class="badge" id="count"></span></div>
            </div>

            <div class="panel" id="preview">
              <div id="pv-skel" class="skel" style="height:160px;display:none"></div>
              <div id="pv-empty" class="muted">Select a character to see details</div>
              <div id="pv-card" style="display:none">
                <div class="card-mini">
                  <img id="pv-avatar" class="avatar" src="" alt="">
                  <div class="meta">
                    <div id="pv-title" style="font-weight:800"></div>
                    <div class="kv">
                      <span id="pv-class"></span>
                      <span id="pv-ilvl"></span>
                      <span id="pv-faction"></span>
                      <span id="pv-score"></span>
                    </div>
                    <div class="kv">
                      <span id="pv-raid"></span>
                    </div>
                    <div><a id="pv-rio" class="btn secondary" target="_blank" rel="noopener">Open Raider.IO</a></div>
                    <div class="note muted" id="pv-note" style="display:none"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <button id="submit" class="btn" disabled>Submit application</button>
            <a class="btn secondary" href="/">Cancel</a>
          </div>
        </div>

        <!-- STEP: done -->
        <div id="step-done" class="row" style="display:none">
          <div class="row ok" id="done-text"></div>

          <!-- other guild CTA + live status -->
          <div class="row" id="other-guild-cta" style="display:none">
            <div class="row muted" id="other-guild-text"></div>
            <div class="row">
              <button id="notify-ready" class="btn">I’ve left my guild — notify officers</button>
              <a id="join-btn" class="btn secondary" target="_blank" rel="noopener">Open Discord</a>
            </div>
            <div id="notify-panel" class="panel" style="display:none">
              <div class="row small">We’ll ping officers and show live status here.</div>
              <div class="steps">
                <div class="step"><span id="st-queued" class="chk">•</span><span>Queued</span></div>
                <div class="step"><span id="st-seen" class="chk">•</span><span>Seen by officer</span></div>
                <div class="step"><span id="st-invite" class="chk">•</span><span>Invite sent</span></div>
                <div class="step"><span id="st-done" class="chk">•</span><span>Completed</span></div>
              </div>
              <div class="row small" id="notify-foot"></div>
            </div>
          </div>

          <div class="row"><a class="btn secondary" href="https://discord.com/app">Return to Discord</a></div>
        </div>

      </div>
    </div>
  </div>

<script>
  // Use same origin (Heroku proxies /oauth/* and /notify-*)
  const API_BASE = "https://mikumikudev-c530e6b3e669.herokuapp.com"; 
  const REGION_DEFAULT = "eu";

  // --- Parse & clean URL params (then hide them)
  const params = new URLSearchParams(location.search);
  let code  = params.get("code")  || "";
  let state = params.get("state") || "";
  if (code || state) history.replaceState(null, "", location.pathname);

  // --- UI refs
  const loading  = document.getElementById("step-loading");
  const stepErr  = document.getElementById("step-error");
  const errText  = document.getElementById("err-text");
  const retryBtn = document.getElementById("retry");
  const stepSel  = document.getElementById("step-select");
  const stepDone = document.getElementById("step-done");
  const who      = document.getElementById("who");
  const q        = document.getElementById("q");
  const sel      = document.getElementById("choice");
  const btn      = document.getElementById("submit");
  const count    = document.getElementById("count");

  const pvSkel   = document.getElementById("pv-skel");
  const pvEmpty  = document.getElementById("pv-empty");
  const pvCard   = document.getElementById("pv-card");
  const pvAvatar = document.getElementById("pv-avatar");
  const pvTitle  = document.getElementById("pv-title");
  const pvClass  = document.getElementById("pv-class");
  const pvIlvl   = document.getElementById("pv-ilvl");
  const pvFaction= document.getElementById("pv-faction");
  const pvScore  = document.getElementById("pv-score");
  const pvRaid   = document.getElementById("pv-raid");
  const pvRio    = document.getElementById("pv-rio");
  const pvNote   = document.getElementById("pv-note");

  const doneText = document.getElementById("done-text");
  const otherCta = document.getElementById("other-guild-cta");
  const otherText= document.getElementById("other-guild-text");
  const joinBtn  = document.getElementById("join-btn");

  const notifyBtn   = document.getElementById("notify-ready");
  const notifyPanel = document.getElementById("notify-panel");
  const stQueued = document.getElementById("st-queued");
  const stSeen   = document.getElementById("st-seen");
  const stInvite = document.getElementById("st-invite");
  const stDone   = document.getElementById("st-done");
  const notifyFoot= document.getElementById("notify-foot");

  // --- State
  const RAID_KEYS = ["manaforge-omega","manaforge","mfo","liberation-of-undermine","liberation","nerubar-palace","nerubar","amirdrassil","aberrus","vault"];
  let allChoices = [];
  let lastSelected = "";
  let lastSubmitted = null;
  let USER_ID = ""; // always a STRING

  function show(node){
    loading.style.display="none"; stepErr.style.display="none"; stepSel.style.display="none"; stepDone.style.display="none";
    node.style.display="block";
  }

  function render(list){
    sel.innerHTML="";
    list.forEach(o=>{
      const opt=document.createElement("option");
      opt.value=JSON.stringify(o);
      opt.textContent=o.name+" — "+o.realm;
      sel.appendChild(opt);
    });
    count.textContent=list.length+" character(s)";
    if(lastSelected){
      const i=[...sel.options].findIndex(o=>o.value===lastSelected);
      if(i>=0) sel.selectedIndex=i;
    }
    btn.disabled = sel.selectedOptions.length===0;
  }

  function skel(on){ pvSkel.style.display=on?"block":"none"; pvEmpty.style.display=on?"none":"block"; pvCard.style.display="none"; }
  function clearPreview(){
    pvAvatar.src=""; pvTitle.textContent=""; pvClass.textContent="";
    pvIlvl.textContent=""; pvFaction.textContent=""; pvScore.textContent="";
    pvRaid.textContent=""; pvRio.href="#"; pvNote.style.display="none"; pvNote.textContent="";
    pvCard.style.display="none"; pvEmpty.style.display="block"; pvSkel.style.display="none";
  }

  function pickLatestRaidName(prog){
    const keys=Object.keys(prog||{});
    for(const want of RAID_KEYS){
      const hit = keys.find(k=>k.toLowerCase().includes(want));
      if(hit) return hit;
    }
    let maxKey=null,maxScore=-1;
    for(const k of keys){
      const p=prog[k]||{};
      const s=(p.mythic_bosses_killed||0)*3+(p.heroic_bosses_killed||0)*2+(p.normal_bosses_killed||0);
      if(s>maxScore){maxScore=s;maxKey=k;}
    }
    return maxKey;
  }
  function raidSummary(prog){
    const name=pickLatestRaidName(prog);
    if(!name) return "";
    const p=prog[name]||{};
    const t=p.total_bosses||0, m=p.mythic_bosses_killed||0, h=p.heroic_bosses_killed||0, n=p.normal_bosses_killed||0;
    if(m>0) return "M "+m+"/"+t+" • Manaforge Omega";
    if(h>0) return "HC "+h+"/"+t;
    if(n>0) return "N "+n+"/"+t;
    return "0/"+t;
  }

  function currentChoice(){
    if(!sel.value) return null;
    try{ return JSON.parse(sel.value); }catch{ return null; }
  }

  async function fillPreview(region,realm,name){
    skel(true);
    try{
      const u="https://raider.io/api/v1/characters/profile?"+new URLSearchParams({
        region, realm, name,
        fields:"gear,raid_progression,mythic_plus_scores_by_season:current"
      });
      const r=await fetch(u);
      if(!r.ok){ clearPreview(); return; }
      const d=await r.json();

      const cls  = d.class || "";
      const spec = (d.active_spec_name||"") + (d.active_spec_role?(" • "+d.active_spec_role):"");
      const ilvl = d.gear && d.gear.item_level_equipped ? Math.round(Number(d.gear.item_level_equipped)) : null;

      let score = 0;
      if (Array.isArray(d.mythic_plus_scores_by_season) && d.mythic_plus_scores_by_season.length) {
        const s0 = d.mythic_plus_scores_by_season[0] || {};
        if (s0.scores && s0.scores.all != null) score = Math.round(Number(s0.scores.all) || 0);
      }
      const raid = raidSummary(d.raid_progression||{});

      pvAvatar.src = d.thumbnail_url || "";
      pvTitle.textContent = name+" — "+realm;
      pvClass.textContent = spec ? (spec+" • "+cls) : cls;
      pvIlvl.textContent  = ilvl ? ("iLvl "+ilvl) : "";
      pvFaction.textContent = d.faction || "";
      pvScore.textContent = score ? ("M+ "+score) : "No current M+ score";
      pvRaid.textContent  = raid || "";
      pvRio.href = d.profile_url || ("https://raider.io/characters/"+region+"/"+realm.toLowerCase().replace(/\s+/g,"-")+"/"+name);

      pvEmpty.style.display="none"; pvSkel.style.display="none"; pvCard.style.display="block";
      pvNote.style.display = (!score) ? "block" : "none";
      pvNote.textContent   = (!score) ? "This character has no current-season Mythic+ score on Raider.IO." : "";
    }catch{ clearPreview(); }
  }

  async function intake(){
    if(!code||!state){ errText.textContent="Missing code or state."; show(stepErr); return; }
    try{
      const r=await fetch(API_BASE + "/oauth/intake", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({state,code})
      });
      if(!r.ok){
        const t = await r.text();
        errText.textContent = "Intake failed: " + t;
        show(stepErr); return;
      }
      const data=await r.json();
      if(!data.ok){
        errText.textContent="Server error: "+(data.error||"unknown");
        show(stepErr); return;
      }

      // --- KEEP DISCORD ID AS STRING
      USER_ID = ((data.user_id_str ?? data.user_id) ?? "").toString();
      who.textContent = "Discord: " + USER_ID;

      allChoices=(data.choices||[]).map(o=>({
        name:o.name, realm:o.realm, realm_slug:o.realm_slug, name_slug:o.name_slug,
        region:(o.region||REGION_DEFAULT).toLowerCase()
      }));

      render(allChoices);
      show(stepSel);

      if(sel.options.length){
        sel.selectedIndex=0; lastSelected=sel.value;
        const c=currentChoice(); if(c) fillPreview(c.region.toUpperCase(),c.realm,c.name);
      }
    }catch(e){
      errText.textContent="Network error.";
      show(stepErr);
    }
  }

  function filterNow(){
    const s=q.value.toLowerCase();
    const f=!s?allChoices:allChoices.filter(o=>o.name.toLowerCase().includes(s)||o.realm.toLowerCase().includes(s));
    render(f);
    if(sel.options.length){
      sel.selectedIndex=0; lastSelected=sel.value;
      const c=currentChoice(); if(c) fillPreview(c.region.toUpperCase(),c.realm,c.name);
    }else{ clearPreview(); }
  }

  q.addEventListener("input",filterNow);
  sel.addEventListener("change",()=>{ btn.disabled=sel.selectedOptions.length===0; lastSelected=sel.value; const c=currentChoice(); if(c) fillPreview(c.region.toUpperCase(),c.realm,c.name); });
  sel.addEventListener("dblclick",()=>{ if(!btn.disabled) submitApp(); });

  document.addEventListener("keydown",e=>{
    if(e.key==="Enter" && document.activeElement!==q && !btn.disabled){ submitApp(); }
    if(e.key==="ArrowDown"){ if(sel.selectedIndex<sel.options.length-1){ sel.selectedIndex++; sel.dispatchEvent(new Event("change")); } e.preventDefault(); }
    if(e.key==="ArrowUp"){ if(sel.selectedIndex>0){ sel.selectedIndex--; sel.dispatchEvent(new Event("change")); } e.preventDefault(); }
  });

  async function submitApp(){
    if(sel.selectedOptions.length===0) return;
    btn.disabled=true; const prev=btn.textContent; btn.textContent="Submitting…";
    try{
      const r=await fetch(API_BASE + "/oauth/submit", {
        method:"POST",
        body:new URLSearchParams({state,choice:sel.value})
      });
      if(!r.ok){
        errText.textContent="Submit failed: "+(await r.text()); show(stepErr);
        btn.disabled=false; btn.textContent=prev; return;
      }
      const data=await r.json();
      if(!data.ok){
        errText.textContent="Submit error: "+(data.error||data.status||"unknown"); show(stepErr);
        btn.disabled=false; btn.textContent=prev; return;
      }

      const picked = JSON.parse(sel.value);
      lastSubmitted = { name:picked.name, realm:picked.realm };

      if(data.status==="other_guild"){
        doneText.textContent="This character is currently in "+(data.guild||"another guild")+". Please leave your current guild, then click the button below so officers can invite you.";
        otherText.textContent="When you’ve left your current guild, press the button to notify officers. Keep this page open to watch progress.";
        if(data.join_url){ joinBtn.href=data.join_url; joinBtn.textContent="Open Timeskip Discord"; }
        otherCta.style.display="block";
        show(stepDone);
        return;
      }

      const m={auto_accepted:"You’re all set — you were auto-accepted.",queued:"Thanks! Your application is pending officer review.",linked_alt:"Alt linked to your profile."};
      doneText.textContent=m[data.status]||("Status: "+data.status);
      otherCta.style.display="none";
      show(stepDone);
    }catch{
      errText.textContent="Network error."; show(stepErr);
      btn.disabled=false; btn.textContent=prev;
    }
  }
  btn.addEventListener("click",submitApp);
  retryBtn.addEventListener("click",()=>{ show(loading); clearPreview(); intake(); });

  // ----- Notify officers flow -----
  let pollId=null, currentTicket=null;
  function mark(el, ok){ el.classList.toggle("ok", !!ok); el.textContent = ok ? "✓" : "•"; }
  function setStatus(status){
    mark(stQueued, status==="queued" || status==="seen" || status==="invite_sent" || status==="completed");
    mark(stSeen,   status==="seen" || status==="invite_sent" || status==="completed");
    mark(stInvite, status==="invite_sent" || status==="completed");
    mark(stDone,   status==="completed");
    const now=new Date().toUTCString();
    notifyFoot.textContent = "Last update: "+now+" • Status: "+status;
  }
  async function pollStatus(){
    if(!currentTicket) return;
    try{
      const u=new URL(API_BASE + "/notify-status", location.origin);
      u.searchParams.set("ticket_id", currentTicket);
      const r=await fetch(u);
      if(!r.ok) return;
      const data=await r.json();
      if(!data.ok) return;
      const st=data.status||"queued";
      setStatus(st);
      if(st==="completed" && pollId){ clearInterval(pollId); pollId=null; }
    }catch{}
  }

  notifyBtn.addEventListener("click", async ()=>{
    const name  = lastSubmitted?.name  || prompt("Character name");
    const realm = lastSubmitted?.realm || prompt("Realm");
    const user_id = USER_ID; // STRING, do not coerce

    notifyBtn.disabled = true; notifyBtn.textContent = "Notifying…";
    try{
      const r = await fetch(API_BASE + "/notify-ready", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ user_id, name, realm, note:"Left previous guild" }) // user_id kept as string
      });
      const data = await r.json();
      if(!r.ok || !data.ok){
        notifyBtn.disabled=false; notifyBtn.textContent="I’ve left my guild — notify officers";
        alert("Failed to notify: "+(data.error||"server")); return;
      }
      currentTicket = data.ticket_id;
      notifyPanel.style.display="block";
      setStatus("queued");
      if(pollId) clearInterval(pollId);
      pollId = setInterval(pollStatus, 4000);
      notifyBtn.textContent = "Notification sent";
    }catch{
      notifyBtn.disabled=false; notifyBtn.textContent="I’ve left my guild — notify officers";
      alert("Network error while notifying officers.");
    }
  });

  // Kick it off
  intake();
</script>
</body>
</html>
