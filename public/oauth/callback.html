<!doctype html><html lang="en"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Finish sign-in</title>
<style>
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1200px 600px at 20% 10%,#0b1730,#070b15 65%);color:#e5e7eb;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
.container{max-width:1040px;margin:6vh auto;padding:24px}
.card{background:linear-gradient(180deg,#111827cc,#0b1324cc);border:1px solid #1f2937;border-radius:18px;overflow:hidden;box-shadow:0 10px 40px #0006}
.header{padding:22px;border-bottom:1px solid #1f2937}
.title{margin:0;font-size:20px;display:flex;gap:10px;align-items:center}
.dot{width:10px;height:10px;border-radius:999px;background:#34d399;box-shadow:0 0 20px #34d39955}
.sub{margin:6px 0 0;color:#9ca3af;font-size:14px}
.body{padding:22px}
.row{margin:12px 0}
.flex{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.spinner{width:32px;height:32px;border:3px solid #34d39933;border-top-color:#34d399;border-radius:999px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.input,select,button{font:inherit}
.input,select{width:100%;background:#0b1220;color:#e5e7eb;border:1px solid #334155;border-radius:12px;padding:12px 14px;outline:none;transition:border .15s ease,box-shadow .15s ease;font-size:15px}
.input:focus,select:focus{border-color:#34d399;box-shadow:0 0 0 4px #34d39933}
.btn{appearance:none;border:1px solid #10b981;background:linear-gradient(180deg,#34d399,#10b981);color:#fff;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;transition:transform .08s ease,box-shadow .2s ease;box-shadow:0 8px 24px #10b98144;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn.secondary{background:none;color:#e5e7eb;border-color:#334155;box-shadow:none}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:960px){.grid{grid-template-columns:2fr 3fr}}
.badge{display:inline-block;padding:4px 8px;border:1px solid #334155;border-radius:999px;font-size:12px;color:#9ca3af}
.err{color:#fca5a5}
.ok{color:#86efac}
.panel{background:#0a0f1d;border:1px solid #1f2937;border-radius:14px;padding:14px}
.card-mini{display:flex;gap:14px;align-items:center}
.avatar{width:72px;height:72px;border-radius:12px;object-fit:cover;background:#0b1220;border:1px solid #1f2937}
.meta{display:grid;gap:4px}
.kv{display:flex;gap:8px;flex-wrap:wrap}
.kv span{padding:4px 8px;border:1px solid #334155;border-radius:999px;font-size:12px;color:#cbd5e1}
.muted{color:#9ca3af}
.skel{position:relative;overflow:hidden;background:#0b1220;border:1px solid #1f2937;border-radius:12px}
.skel::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.05),transparent);animation:sh 1.2s infinite}
@keyframes sh{from{transform:translateX(-100%)}to{transform:translateX(100%)}}
.shortcuts{font-size:12px;color:#9ca3af}
.note{padding:12px 14px;border:1px solid #78350f;background:#111827;border-radius:12px}
.hidden{display:none}
.stepper{display:grid;gap:10px;margin-top:10px}
.step{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:#0b1324;border:1px solid #1f2937}
.ico{width:22px;height:22px;border-radius:50%;display:grid;place-items:center;font-size:12px}
.ico.idle{border:2px solid #475569;color:#94a3b8}
.ico.run{border:2px solid #38bdf8}
.ico.ok{background:#16a34a;color:#fff}
.spin{width:14px;height:14px;border-radius:50%;border:2px solid transparent;border-top-color:#38bdf8;animation:spin .9s linear infinite}
.toast{position:fixed;right:12px;bottom:12px;background:#0b1220;border:1px solid #334155;color:#e5e7eb;padding:10px 14px;border-radius:10px}
.small{font-size:.9em}
</style>
<body><div class="container"><div class="card">
  <div class="header">
    <h1 class="title"><span class="dot"></span>Finishing sign-in</h1>
    <p class="sub">Pick your character and submit</p>
  </div>
  <div class="body">
    <div id="step-loading" class="row flex"><div class="spinner"></div><div>Talking to serverâ€¦</div></div>

    <div id="step-error" class="row hidden">
      <div class="row err" id="err-text"></div>
      <div class="row"><a class="btn secondary" href="/">Return</a> <button id="retry" class="btn secondary">Retry</button></div>
    </div>

    <div id="step-select" class="hidden">
      <div class="row flex"><span class="badge" id="who"></span><span class="shortcuts">Enter to submit â€¢ â†‘/â†“ to move â€¢ Double-click to quick submit</span></div>
      <div class="grid">
        <div class="panel">
          <div class="row"><input id="q" class="input" placeholder="Search name or realm"></div>
          <div class="row"><select id="choice" size="12" style="height:360px"></select></div>
          <div class="row"><span class="badge" id="count"></span></div>
        </div>
        <div class="panel" id="preview">
          <div id="pv-skel" class="skel" style="height:160px;display:none"></div>
          <div id="pv-empty" class="muted">Select a character to see details</div>
          <div id="pv-card" class="hidden">
            <div class="card-mini">
              <img id="pv-avatar" class="avatar" src="" alt="">
              <div class="meta">
                <div id="pv-title" style="font-weight:800"></div>
                <div class="kv">
                  <span id="pv-class"></span>
                  <span id="pv-ilvl"></span>
                  <span id="pv-faction"></span>
                  <span id="pv-score"></span>
                </div>
                <div class="kv">
                  <span id="pv-raid"></span>
                </div>
                <div><a id="pv-rio" class="btn secondary" target="_blank" rel="noopener">Open Raider.IO</a></div>
                <div class="note muted hidden" id="pv-note"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row"><button id="submit" class="btn" disabled>Submit application</button> <a class="btn secondary" href="/">Cancel</a></div>
    </div>

    <div id="step-done" class="row hidden">
      <div class="row ok" id="done-text"></div>

      <!-- Other guild flow w/ live officer notifications -->
      <div id="other-guild-panel" class="panel hidden">
        <h3 style="margin:6px 0 2px">Youâ€™re currently in <span id="curGuildName"></span></h3>
        <p class="muted">To join <b>Timeskip</b> in-game, please:</p>
        <ol class="muted" style="margin-top:0">
          <li>Log in and <b>/gquit</b> your current guild.</li>
          <li>Open <b>Guilds &amp; Communities â†’ Find a Guild</b>, search <b>Timeskip</b>, and click <b>Apply</b>.</li>
        </ol>
        <div class="row flex">
          <button id="copyNoteBtn" class="btn">Copy application note</button>
          <button id="notifyBtn" class="btn">Iâ€™ve left my guild â€” notify officers</button>
        </div>
        <div class="stepper">
          <div class="step"><div class="ico ok" id="s1Ico">âœ“</div><div><b>Confirmed you left your guild</b><div class="muted small">Clicking the button confirms this step.</div></div></div>
          <div class="step"><div class="ico idle" id="s2Ico"></div><div><b>Officers notified</b><div class="muted small" id="s2Sub">Weâ€™ll ping officers in the review channel.</div></div></div>
          <div class="step"><div class="ico idle" id="s3Ico"></div><div><b>Officer acknowledged</b><div class="muted small" id="s3Sub">Waiting for an officer to pick it up.</div></div></div>
          <div class="step"><div class="ico idle" id="s4Ico"></div><div><b>Invite sent in-game</b><div class="muted small" id="s4Sub">Youâ€™ll see the guild invite pop up.</div></div></div>
          <div class="step"><div class="ico idle" id="s5Ico"></div><div><b>Completed</b><div class="muted small" id="s5Sub">Welcome to Timeskip ðŸŽ‰</div></div></div>
        </div>
        <p class="small muted" style="margin-top:10px">Officer quick command: <code id="ginviteCmd"></code></p>
      </div>

      <div class="row"><a class="btn secondary" href="https://discord.com/app">Return to Discord</a></div>
    </div>
  </div>
</div></div>

<div id="toast" class="toast hidden"></div>

<script>
const API_BASE = "https://mikumikudev-c530e6b3e669.herokuapp.com";
const REGION_DEFAULT = "eu";
const params = new URLSearchParams(location.search);
let code  = params.get("code")  || "";
let state = params.get("state") || "";
// Hide code/state from URL
if (code || state) { history.replaceState(null, "", location.pathname); }

const el = (id)=>document.getElementById(id);
const showOnly = (id)=>["step-loading","step-error","step-select","step-done"].forEach(x=>el(x).classList.toggle("hidden", x!==id));

const q=el("q"), sel=el("choice"), btn=el("submit"), count=el("count");
const pvSkel=el("pv-skel"), pvEmpty=el("pv-empty"), pvCard=el("pv-card");
const pvAvatar=el("pv-avatar"), pvTitle=el("pv-title"), pvClass=el("pv-class");
const pvIlvl=el("pv-ilvl"), pvFaction=el("pv-faction"), pvScore=el("pv-score"), pvRaid=el("pv-raid"), pvRio=el("pv-rio"), pvNote=el("pv-note");

const doneText=el("done-text");
const otherPanel=el("other-guild-panel"), curGuildName=el("curGuildName"), copyNoteBtn=el("copyNoteBtn"), notifyBtn=el("notifyBtn");
const s2Ico=el("s2Ico"), s3Ico=el("s3Ico"), s4Ico=el("s4Ico"), s5Ico=el("s5Ico");
const s2Sub=el("s2Sub"), s3Sub=el("s3Sub"), s4Sub=el("s4Sub"), ginviteCmd=el("ginviteCmd");
const toastEl=el("toast");

const RAID_KEYS=["manaforge-omega","manaforge","mfo","liberation-of-undermine","liberation","nerubar-palace","nerubar","amirdrassil","aberrus","vault"];

let allChoices=[], lastSelected="", intakeUserId=0, pollTimer=null;

function toast(msg){ toastEl.textContent = msg; toastEl.classList.remove("hidden"); setTimeout(()=>toastEl.classList.add("hidden"), 2000); }

function icoRun(x){ x.className="ico run"; x.innerHTML='<div class="spin"></div>'; }
function icoOk(x){ x.className="ico ok"; x.textContent="âœ“"; }
function icoIdle(x){ x.className="ico idle"; x.textContent=""; }

function render(list){
  sel.innerHTML="";
  list.forEach(o=>{
    const opt=document.createElement("option");
    opt.value=JSON.stringify(o);
    opt.textContent=`${o.name} â€” ${o.realm}`;
    sel.appendChild(opt);
  });
  count.textContent = `${list.length} character(s)`;
  if (lastSelected){
    const i=[...sel.options].findIndex(o=>o.value===lastSelected);
    if (i>=0) sel.selectedIndex=i;
  }
  btn.disabled = sel.selectedOptions.length===0;
}

function skel(on){ pvSkel.style.display=on?"block":"none"; pvEmpty.classList.toggle("hidden", on); pvCard.classList.add("hidden"); }
function clearPreview(){
  pvAvatar.src=""; pvTitle.textContent=""; pvClass.textContent="";
  pvIlvl.textContent=""; pvFaction.textContent=""; pvScore.textContent="";
  pvRaid.textContent=""; pvRio.href="#"; pvNote.classList.add("hidden"); pvNote.textContent="";
  pvCard.classList.add("hidden"); pvEmpty.classList.remove("hidden"); pvSkel.style.display="none";
}

function pickLatestRaidName(prog){
  const keys=Object.keys(prog||{});
  for (const want of RAID_KEYS){
    const hit=keys.find(k=>k.toLowerCase().includes(want));
    if (hit) return hit;
  }
  // fallback = most progressed
  let maxKey=null, maxScore=-1;
  for (const k of keys){
    const p=prog[k]||{};
    const s=(p.mythic_bosses_killed||0)*3+(p.heroic_bosses_killed||0)*2+(p.normal_bosses_killed||0);
    if (s>maxScore){maxScore=s;maxKey=k;}
  }
  return maxKey;
}
function raidSummary(prog){
  const name=pickLatestRaidName(prog);
  if(!name) return "";
  const p=prog[name]||{};
  const t=p.total_bosses||0, m=p.mythic_bosses_killed||0, h=p.heroic_bosses_killed||0, n=p.normal_bosses_killed||0;
  if(m>0) return `M ${m}/${t} â€¢ Manaforge Omega`;
  if(h>0) return `HC ${h}/${t}`;
  if(n>0) return `N ${n}/${t}`;
  return `0/${t}`;
}

function currentChoice(){ if(!sel.value) return null; try{ return JSON.parse(sel.value);}catch{return null;} }

async function fillPreview(region, realm, name){
  skel(true);
  try{
    const u="https://raider.io/api/v1/characters/profile?"+new URLSearchParams({
      region, realm, name, fields:"gear,raid_progression,mythic_plus_scores_by_season:current"
    });
    const r=await fetch(u);
    if(!r.ok){ clearPreview(); return; }
    const d=await r.json();
    const cls=d.class||"";
    const spec=(d.active_spec_name||"")+(d.active_spec_role?(" â€¢ "+d.active_spec_role):"");
    const ilvl=d.gear?.item_level_equipped ? Math.round(d.gear.item_level_equipped) : null;
    const seasons=d.mythic_plus_scores_by_season||[];
    const score=seasons.length && seasons[0].scores?.all ? Math.round(seasons[0].scores.all) : 0;
    const raid=raidSummary(d.raid_progression||{});

    pvAvatar.src=d.thumbnail_url||"";
    pvTitle.textContent=`${name} â€” ${realm}`;
    pvClass.textContent=spec ? `${spec} â€¢ ${cls}` : cls;
    pvIlvl.textContent=ilvl?(`iLvl ${ilvl}`):"";
    pvFaction.textContent=d.faction||"";
    pvScore.textContent = score ? `M+ ${score}` : "No current M+ score";
    pvRaid.textContent=raid||"";
    pvRio.href=d.profile_url || `https://raider.io/characters/${region}/${realm.toLowerCase().replace(/\s+/g,"-")}/${name}`;

    pvEmpty.classList.add("hidden");
    pvSkel.style.display="none";
    pvCard.classList.remove("hidden");

    if(!score){
      pvNote.classList.remove("hidden");
      pvNote.textContent="This character has no current Mythic+ score. Officers may ask for additional info.";
    }
  }catch{ clearPreview(); }
}

async function intake(){
  if(!code||!state){ el("err-text").textContent="Missing code or state."; showOnly("step-error"); return; }
  try{
    const r=await fetch(`${API_BASE}/oauth/intake`, {
      method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({ state, code })
    });
    if(!r.ok){ el("err-text").textContent = "Intake failed."; showOnly("step-error"); return; }
    const data=await r.json();
    if(!data.ok){ el("err-text").textContent = "Server error: "+(data.error||"unknown"); showOnly("step-error"); return; }

    intakeUserId = data.user_id;
    el("who").textContent = "User ID: "+intakeUserId;

    allChoices=(data.choices||[]).map(o=>({
      name:o.name, realm:o.realm, realm_slug:o.realm_slug, name_slug:o.name_slug,
      region:(o.region||REGION_DEFAULT).toLowerCase()
    }));
    render(allChoices);
    showOnly("step-select");
    if(sel.options.length){
      sel.selectedIndex=0; lastSelected=sel.value;
      const c=currentChoice(); if(c) fillPreview(c.region.toUpperCase(), c.realm, c.name);
    }
  }catch{ el("err-text").textContent = "Network error."; showOnly("step-error"); }
}

function filterNow(){
  const s=q.value.toLowerCase();
  const f=!s ? allChoices : allChoices.filter(o => o.name.toLowerCase().includes(s) || o.realm.toLowerCase().includes(s));
  render(f);
  if(sel.options.length){
    sel.selectedIndex=0; lastSelected=sel.value;
    const c=currentChoice(); if(c) fillPreview(c.region.toUpperCase(), c.realm, c.name);
  }else{ clearPreview(); }
}

q.addEventListener("input",filterNow);
sel.addEventListener("change",()=>{ btn.disabled=sel.selectedOptions.length===0; lastSelected=sel.value; const c=currentChoice(); if(c) fillPreview(c.region.toUpperCase(), c.realm, c.name); });
sel.addEventListener("dblclick",()=>{ if(!btn.disabled) submitApp(); });
document.addEventListener("keydown",e=>{
  if(e.key==="Enter" && document.activeElement!==q && !btn.disabled){ submitApp(); }
  if(e.key==="ArrowDown"){ if(sel.selectedIndex<sel.options.length-1){ sel.selectedIndex++; sel.dispatchEvent(new Event("change")); } e.preventDefault(); }
  if(e.key==="ArrowUp"){ if(sel.selectedIndex>0){ sel.selectedIndex--; sel.dispatchEvent(new Event("change")); } e.preventDefault(); }
});

async function submitApp(){
  if(sel.selectedOptions.length===0) return;
  btn.disabled=true; const prev=btn.textContent; btn.textContent="Submittingâ€¦";
  try{
    const r=await fetch(`${API_BASE}/oauth/submit`, { method:"POST", body:new URLSearchParams({ state, choice: sel.value }) });
    if(!r.ok){ el("err-text").textContent="Submit failed."; showOnly("step-error"); btn.disabled=false; btn.textContent=prev; return; }
    const data=await r.json();
    if(!data.ok){ el("err-text").textContent="Submit error: "+(data.error||data.status||"unknown"); showOnly("step-error"); btn.disabled=false; btn.textContent=prev; return; }

    if(data.status==="other_guild"){
      // Show the interactive notify flow
      doneText.textContent="This character is currently in "+(data.guild||"another guild")+". Please leave your current guild, then let us know and weâ€™ll send an invite.";
      otherPanel.classList.remove("hidden");
      curGuildName.textContent = data.guild || "another guild";
      const c=currentChoice(); if(c){ ginviteCmd.textContent=`/ginvite ${c.name}-${c.realm}`; }
      showOnly("step-done");

      // Wire up actions
      const note = [
        `Discord: ${window.DISCORD_HANDLE || ""}`,
        c ? `Character: ${c.name}-${c.realm}` : "",
      ].filter(Boolean).join(" â€¢ ");
      copyNoteBtn.onclick = async () => {
        await navigator.clipboard.writeText(note || "Application: Timeskip");
        toast("Application note copied");
      };
      notifyBtn.onclick = async ()=>{
        notifyBtn.disabled=true; icoRun(s2Ico);
        try{
          const rr = await fetch(`${API_BASE}/notify-ready`, {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ user_id:intakeUserId, name:c.name, realm:c.realm, note })
          });
          const dj = await rr.json();
          if(dj.ok){
            icoOk(s2Ico); toast("Officers notified");
            startPolling(dj.ticket_id);
          }else{
            icoIdle(s2Ico); toast("Couldnâ€™t notify officers. Try again.");
            notifyBtn.disabled=false;
          }
        }catch{
          icoIdle(s2Ico); toast("Network error. Try again.");
          notifyBtn.disabled=false;
        }
      };
      return;
    }

    const m={ auto_accepted:"Youâ€™re all set. You were auto-accepted.", queued:"Thanks. Your application is pending officer review.", linked_alt:"Alt linked to your profile." };
    doneText.textContent = m[data.status] || ("Status: "+data.status);
    otherPanel.classList.add("hidden");
    showOnly("step-done");
  }catch{
    el("err-text").textContent="Network error."; showOnly("step-error"); btn.disabled=false; btn.textContent=prev;
  }
}

async function startPolling(ticketId){
  if (pollTimer) clearInterval(pollTimer);
  icoRun(s2Ico);
  const poll = async ()=>{
    try{
      const r = await fetch(`${API_BASE}/notify-status?ticket_id=${encodeURIComponent(ticketId)}`);
      const d = await r.json();
      if(!d.ok) return;
      if(d.status==="queued"){ icoOk(s2Ico); icoRun(s3Ico); s2Sub.textContent="Your request has been posted to officers."; }
      if(d.status==="seen"){  icoOk(s2Ico); icoOk(s3Ico); icoRun(s4Ico); s3Sub.textContent="An officer is on it."; }
      if(d.status==="invite_sent"){ icoOk(s2Ico); icoOk(s3Ico); icoOk(s4Ico); icoRun(s5Ico); s4Sub.textContent="Check for the guild invite in-game."; }
      if(d.status==="completed"){ icoOk(s2Ico); icoOk(s3Ico); icoOk(s4Ico); icoOk(s5Ico); clearInterval(pollTimer); toast("All done â€” welcome!"); }
    }catch{}
  };
  await poll();
  pollTimer = setInterval(poll, 5000);
}

el("retry").addEventListener("click", ()=>{ showOnly("step-loading"); clearPreview(); intake(); });

// Go!
showOnly("step-loading");
intake();
</script>
</body></html>
