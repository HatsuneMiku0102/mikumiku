<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finish sign-in</title>
<style>
:root{--bg1:#0b1020;--bg2:#0a0f1f;--bg3:#070b15;--panel:#0b1220;--panel2:#0a0f1d;--line:#182235;--muted:#9ca3af;--text:#e6eaf2;--brand:#34d399;--brand2:#10b981;--accent:#60a5fa;--warn:#fca5a5}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;background:linear-gradient(140deg,var(--bg1),var(--bg2) 40%,var(--bg3) 80%);background-attachment:fixed;position:relative;overflow-x:hidden}
.hero{position:fixed;inset:-20vh -10vw auto -10vw;height:60vh;pointer-events:none;filter:blur(80px);opacity:.4;background:radial-gradient(600px 400px at 15% 20%,#16a34a33,transparent 60%),radial-gradient(500px 420px at 85% 10%,#2563eb33,transparent 60%),radial-gradient(800px 420px at 50% 100%,#7c3aed22,transparent 60%)}
.container{max-width:1040px;margin:6vh auto;padding:24px}
.card{background:linear-gradient(180deg,#0c1326cc,#0a1226cc);border:1px solid var(--line);border-radius:20px;box-shadow:0 10px 40px #0006;overflow:hidden;backdrop-filter:blur(8px)}
.header{padding:22px 22px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px}
.title{display:flex;align-items:center;gap:10px;margin:0;font-weight:800;font-size:20px}
.dot{width:10px;height:10px;border-radius:999px;background:var(--brand);box-shadow:0 0 20px #34d39966}
.sub{margin:0;color:var(--muted);font-size:14px}
.body{padding:22px}
.row{margin:12px 0}
.flex{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.grid{display:grid;gap:18px;grid-template-columns:1fr}
@media(min-width:980px){.grid{grid-template-columns:2fr 3fr}}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
.panel.alt{background:var(--panel2)}
.input,select,button{font:inherit}
.input,select{width:100%;background:#0a1426;color:var(--text);border:1px solid #23314a;border-radius:14px;padding:12px 14px;outline:none;transition:border .15s ease,box-shadow .15s ease}
.input:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 4px #34d39933}
select{height:360px}
.btn{appearance:none;border:1px solid var(--brand2);background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;transition:transform .08s ease,box-shadow .2s ease;box-shadow:0 8px 24px #10b98144;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.btn:hover{transform:translateY(-1px)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn.secondary{background:none;color:var(--text);border-color:#2a3a58;box-shadow:none}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #2a3a58;border-radius:999px;font-size:12px;color:#cbd5e1}
.badge .pill{display:inline-grid;place-items:center;width:18px;height:18px;border-radius:999px;background:#0d1b2e;border:1px solid #2a3a58;font-size:11px}
.spinner{width:28px;height:28px;border:3px solid #34d3992e;border-top-color:var(--brand);border-radius:999px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.muted{color:var(--muted)}
.err{color:var(--warn)}
.ok{color:#86efac}
.card-mini{display:flex;gap:14px;align-items:center}
.avatar{width:80px;height:80px;border-radius:14px;object-fit:cover;background:#0b1220;border:1px solid var(--line)}
.meta{display:grid;gap:6px}
.kv{display:flex;gap:8px;flex-wrap:wrap}
.kv span{padding:4px 8px;border:1px solid #2a3a58;border-radius:999px;font-size:12px;color:#d5deea}
.skel{position:relative;overflow:hidden;background:#0b1220;border:1px solid var(--line);border-radius:14px}
.skel::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.05),transparent);animation:sh 1.2s infinite}
@keyframes sh{from{transform:translateX(-100%)}to{transform:translateX(100%)}
}
.shortcuts{font-size:12px;color:var(--muted)}
.note{padding:12px 14px;border:1px solid #7c2d1255;background:#111827;border-radius:12px;color:#f1c9b2}
.steps{display:grid;gap:8px}
.step{display:flex;align-items:center;gap:8px;font-size:14px}
.chk{width:18px;height:18px;border-radius:999px;border:2px solid #334155;display:inline-grid;place-items:center;font-size:12px}
.chk.ok{border-color:var(--brand);background:var(--brand);color:#052e25}
.small{font-size:12px;color:var(--muted)}
.header-right{display:flex;align-items:center;gap:10px}
.promo{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px dashed #2a3a58;border-radius:999px;color:#cbd5e1;font-size:12px}
</style>
<body>
<div class="hero"></div>
<div class="container">
  <div class="card">
    <div class="header">
      <h1 class="title"><span class="dot"></span>Finishing sign-in</h1>
      <div class="header-right">
        <span class="promo">Secure OAuth</span>
      </div>
    </div>
    <div class="body">
      <div id="step-loading" class="row flex"><div class="spinner"></div><div>Talking to server…</div></div>
      <div id="step-error" class="row" style="display:none">
        <div class="row err" id="err-text"></div>
        <div class="row"><a class="btn secondary" href="/">Return</a> <button id="retry" class="btn secondary">Retry</button></div>
      </div>
      <div id="step-select" style="display:none">
        <div class="row flex"><span class="badge" id="who"><span class="pill">ID</span>Discord</span><span class="shortcuts">Enter to submit • ↑/↓ to move • Double-click to quick submit</span></div>
        <div class="grid">
          <div class="panel alt">
            <div class="row"><input id="q" class="input" placeholder="Search name or realm"></div>
            <div class="row"><select id="choice" size="12"></select></div>
            <div class="row"><span class="badge" id="count"><span class="pill">#</span>0 character(s)</span></div>
          </div>
          <div class="panel">
            <div id="pv-skel" class="skel" style="height:176px;display:none"></div>
            <div id="pv-empty" class="muted">Select a character to see details</div>
            <div id="pv-card" style="display:none">
              <div class="card-mini">
                <img id="pv-avatar" class="avatar" src="" alt="">
                <div class="meta">
                  <div id="pv-title" style="font-weight:800"></div>
                  <div class="kv">
                    <span id="pv-class"></span>
                    <span id="pv-ilvl"></span>
                    <span id="pv-faction"></span>
                    <span id="pv-score"></span>
                  </div>
                  <div class="kv"><span id="pv-raid"></span></div>
                  <div><a id="pv-rio" class="btn secondary" target="_blank" rel="noopener">Open Raider.IO</a></div>
                  <div class="note" id="pv-note" style="display:none"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row"><button id="submit" class="btn" disabled>Submit application</button> <a class="btn secondary" href="/">Cancel</a></div>
      </div>
      <div id="step-done" class="row" style="display:none">
        <div class="row ok" id="done-text"></div>
        <div class="row" id="other-guild-cta" style="display:none">
          <div class="row muted" id="other-guild-text"></div>
          <div class="row">
            <button id="notify-ready" class="btn">I’ve left my guild — notify officers</button>
            <a id="join-btn" class="btn secondary" target="_blank" rel="noopener">Open Discord</a>
          </div>
          <div id="notify-panel" class="panel" style="display:none">
            <div class="row small">We’ll ping officers and show live status here.</div>
            <div class="steps">
              <div class="step"><span id="st-queued" class="chk">•</span><span>Queued</span></div>
              <div class="step"><span id="st-seen" class="chk">•</span><span>Seen by officer</span></div>
              <div class="step"><span id="st-invite" class="chk">•</span><span>Invite sent</span></div>
              <div class="step"><span id="st-done" class="chk">•</span><span>Completed</span></div>
            </div>
            <div class="row small" id="notify-foot"></div>
          </div>
        </div>
        <div class="row"><a class="btn secondary" href="https://discord.com/app">Return to Discord</a></div>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE="https://mikumikudev-c530e6b3e669.herokuapp.com";
const ROLE_ID="1300649111317643354";
const REGION_DEFAULT="eu";
const params=new URLSearchParams(location.search);
let code=params.get("code")||"";
let state=params.get("state")||"";
if(code||state){history.replaceState(null,"",location.pathname)}
const loading=document.getElementById("step-loading");
const stepErr=document.getElementById("step-error");
const errText=document.getElementById("err-text");
const stepSel=document.getElementById("step-select");
const stepDone=document.getElementById("step-done");
const who=document.getElementById("who");
const q=document.getElementById("q");
const sel=document.getElementById("choice");
const btn=document.getElementById("submit");
const count=document.getElementById("count");
const pvSkel=document.getElementById("pv-skel");
const pvEmpty=document.getElementById("pv-empty");
const pvCard=document.getElementById("pv-card");
const pvAvatar=document.getElementById("pv-avatar");
const pvTitle=document.getElementById("pv-title");
const pvClass=document.getElementById("pv-class");
const pvIlvl=document.getElementById("pv-ilvl");
const pvFaction=document.getElementById("pv-faction");
const pvScore=document.getElementById("pv-score");
const pvRaid=document.getElementById("pv-raid");
const pvRio=document.getElementById("pv-rio");
const pvNote=document.getElementById("pv-note");
const doneText=document.getElementById("done-text");
const otherCta=document.getElementById("other-guild-cta");
const otherText=document.getElementById("other-guild-text");
const joinBtn=document.getElementById("join-btn");
const notifyBtn=document.getElementById("notify-ready");
const notifyPanel=document.getElementById("notify-panel");
const stQueued=document.getElementById("st-queued");
const stSeen=document.getElementById("st-seen");
const stInvite=document.getElementById("st-invite");
const stDone=document.getElementById("st-done");
const notifyFoot=document.getElementById("notify-foot");
const RAID_KEYS=["manaforge-omega","manaforge","mfo","liberation-of-undermine","liberation","nerubar-palace","nerubar","amirdrassil","aberrus","vault"];
let allChoices=[];
let lastSelected="";
let lastSubmitted=null;

function show(node){[loading,stepErr,stepSel,stepDone].forEach(n=>n.style.display="none");node.style.display="block"}
function withTimeout(promise,ms,msg){let t;const k=new Promise((_,rej)=>t=setTimeout(()=>rej(new Error(msg||"timeout")),ms));return Promise.race([promise.finally(()=>clearTimeout(t)),k])}
async function apiFetch(url,init){return withTimeout(fetch(url,init),12000,"network-timeout")}
function render(list){sel.innerHTML="";list.forEach(o=>{const opt=document.createElement("option");opt.value=JSON.stringify(o);opt.textContent=o.name+" — "+o.realm;sel.appendChild(opt)});count.innerHTML='<span class="pill">#</span>'+list.length+" character(s)";if(lastSelected){const i=[...sel.options].findIndex(o=>o.value===lastSelected);if(i>=0)sel.selectedIndex=i}btn.disabled=sel.selectedOptions.length===0}
function skel(on){pvSkel.style.display=on?"block":"none";pvEmpty.style.display=on?"none":"block";pvCard.style.display="none"}
function clearPreview(){pvAvatar.src="";pvTitle.textContent="";pvClass.textContent="";pvIlvl.textContent="";pvFaction.textContent="";pvScore.textContent="";pvRaid.textContent="";pvRio.href="#";pvNote.style.display="none";pvNote.textContent="";pvCard.style.display="none";pvEmpty.style.display="block";pvSkel.style.display="none"}
function pickLatestRaidName(prog){const keys=Object.keys(prog||{});for(const want of RAID_KEYS){const hit=keys.find(k=>k.toLowerCase().includes(want));if(hit)return hit}let mk=null,ms=-1;for(const k of keys){const p=prog[k]||{};const s=(p.mythic_bosses_killed||0)*3+(p.heroic_bosses_killed||0)*2+(p.normal_bosses_killed||0);if(s>ms){ms=s;mk=k}}return mk}
function raidSummary(p){const name=pickLatestRaidName(p);if(!name)return"";const d=p[name]||{};const t=d.total_bosses||0,m=d.mythic_bosses_killed||0,h=d.heroic_bosses_killed||0,n=d.normal_bosses_killed||0;if(m>0)return"M "+m+"/"+t+" • Manaforge Omega";if(h>0)return"HC "+h+"/"+t;if(n>0)return"N "+n+"/"+t;return"0/"+t}
function currentChoice(){if(!sel.value)return null;try{return JSON.parse(sel.value)}catch{return null}}

async function intake(){
  if(!code||!state){errText.textContent="Missing code or state.";show(stepErr);return}
  try{
    const r=await apiFetch(API_BASE+"/oauth/intake",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({state,code})});
    if(!r.ok){errText.textContent="Intake failed.";show(stepErr);return}
    const data=await r.json();
    if(!data.ok){errText.textContent="Server error: "+(data.error||"unknown");show(stepErr);return}
    allChoices=(data.choices||[]).map(o=>({name:o.name,realm:o.realm,realm_slug:o.realm_slug,name_slug:o.name_slug,region:(o.region||REGION_DEFAULT).toLowerCase()}));
    who.innerHTML='<span class="pill">ID</span>Discord: '+data.user_id;
    render(allChoices);
    show(stepSel);
    if(sel.options.length){sel.selectedIndex=0;lastSelected=sel.value;const c=currentChoice();if(c)fillPreview(c.region.toUpperCase(),c.realm,c.name)}
  }catch(e){
    errText.textContent="Network error.";
    show(stepErr)
  }
}

async function fillPreview(region,realm,name){
  skel(true);
  try{
    const u="https://raider.io/api/v1/characters/profile?"+new URLSearchParams({region,realm,name,fields:"gear,raid_progression,mythic_plus_scores_by_season:current"});
    const r=await withTimeout(fetch(u,{cache:"no-store"}),8000,"rio-timeout");
    if(!r.ok){clearPreview();return}
    const d=await r.json();
    const cls=d.class||"";
    const spec=(d.active_spec_name||"")+(d.active_spec_role?(" • "+d.active_spec_role):"");
    const ilvl=d.gear&&d.gear.item_level_equipped?Math.round(Number(d.gear.item_level_equipped)):null;
    let score=0;
    if(Array.isArray(d.mythic_plus_scores_by_season)&&d.mythic_plus_scores_by_season.length){const s0=d.mythic_plus_scores_by_season[0]||{};if(s0.scores&&s0.scores.all!=null)score=Math.round(Number(s0.scores.all)||0)}
    const raid=raidSummary(d.raid_progression||{});
    pvAvatar.src=d.thumbnail_url||"";
    pvTitle.textContent=name+" — "+realm;
    pvClass.textContent=spec?(spec+" • "+cls):cls;
    pvIlvl.textContent=ilvl?("iLvl "+ilvl):"";
    pvFaction.textContent=d.faction||"";
    pvScore.textContent=score?("M+ "+score):"No current M+ score";
    pvRaid.textContent=raid||"";
    pvRio.href=d.profile_url||("https://raider.io/characters/"+region+"/"+realm.toLowerCase().replace(/\s+/g,"-")+"/"+name);
    pvEmpty.style.display="none";pvSkel.style.display="none";pvCard.style.display="block";
    pvNote.style.display=(!score)?"block":"none";
    pvNote.textContent=(!score)?"This character has no current-season Mythic+ score on Raider.IO.":""
  }catch(e){
    clearPreview()
  }
}

function filterNow(){
  const s=q.value.toLowerCase();
  const f=!s?allChoices:allChoices.filter(o=>o.name.toLowerCase().includes(s)||o.realm.toLowerCase().includes(s));
  render(f);
  if(sel.options.length){sel.selectedIndex=0;lastSelected=sel.value;const c=currentChoice();if(c)fillPreview(c.region.toUpperCase(),c.realm,c.name)}else{clearPreview()}
}

sel.addEventListener("change",()=>{btn.disabled=sel.selectedOptions.length===0;lastSelected=sel.value;const c=currentChoice();if(c)fillPreview(c.region.toUpperCase(),c.realm,c.name)});
sel.addEventListener("dblclick",()=>{if(!btn.disabled)submitApp()});
q.addEventListener("input",filterNow);
document.addEventListener("keydown",e=>{if(e.key==="Enter"&&document.activeElement!==q&&!btn.disabled){submitApp()}if(e.key==="ArrowDown"){if(sel.selectedIndex<sel.options.length-1){sel.selectedIndex++;sel.dispatchEvent(new Event("change"))}e.preventDefault()}if(e.key==="ArrowUp"){if(sel.selectedIndex>0){sel.selectedIndex--;sel.dispatchEvent(new Event("change"))}e.preventDefault()}});

async function submitApp(){
  if(sel.selectedOptions.length===0)return;
  btn.disabled=true;const prev=btn.textContent;btn.textContent="Submitting…";
  try{
    const r=await apiFetch(API_BASE+"/oauth/submit",{method:"POST",body:new URLSearchParams({state,choice:sel.value})});
    if(!r.ok){errText.textContent="Submit failed.";show(stepErr);btn.disabled=false;btn.textContent=prev;return}
    const data=await r.json();
    if(!data.ok){errText.textContent="Submit error: "+(data.error||data.status||"unknown");show(stepErr);btn.disabled=false;btn.textContent=prev;return}
    const picked=JSON.parse(sel.value);
    lastSubmitted={name:picked.name,realm:picked.realm};
    if(data.status==="other_guild"){
      doneText.textContent="This character is currently in "+(data.guild||"another guild")+". Please leave your current guild, then click the button below so officers can invite you.";
      otherText.textContent="When you’ve left your current guild, press the button to notify officers. Keep this page open to watch progress.";
      if(data.join_url){joinBtn.href=data.join_url;joinBtn.textContent="Open Timeskip Discord"}
      otherCta.style.display="block";
      show(stepDone);
      return
    }
    const m={auto_accepted:"You’re all set — you were auto-accepted.",queued:"Thanks! Your application is pending officer review.",linked_alt:"Alt linked to your profile."};
    doneText.textContent=m[data.status]||("Status: "+data.status);
    otherCta.style.display="none";
    show(stepDone)
  }catch(e){
    errText.textContent="Network error during submit.";
    show(stepErr);btn.disabled=false;btn.textContent=prev
  }
}

btn.addEventListener("click",submitApp);
document.getElementById("retry").addEventListener("click",()=>{show(loading);clearPreview();intake()});

let pollId=null,currentTicket=null;
function mark(el,ok){el.classList.toggle("ok",!!ok);el.textContent=ok?"✓":"•"}
function setStatus(status){mark(stQueued,status==="queued"||status==="seen"||status==="invite_sent"||status==="completed");mark(stSeen,status==="seen"||status==="invite_sent"||status==="completed");mark(stInvite,status==="invite_sent"||status==="completed");mark(stDone,status==="completed");const now=new Date().toUTCString();notifyFoot.textContent="Last update: "+now+" • Status: "+status}
async function pollStatus(){
  if(!currentTicket)return;
  try{
    const u=new URL(API_BASE+"/notify-status");
    u.searchParams.set("ticket_id",currentTicket);
    const r=await apiFetch(u.toString(),{method:"GET",cache:"no-store"});
    if(!r.ok)return;
    const data=await r.json();
    if(!data.ok)return;
    const st=data.status||"queued";
    setStatus(st);
    if(st==="completed"&&pollId){clearInterval(pollId);pollId=null}
  }catch{}
}

notifyBtn.addEventListener("click",async()=>{
  const c=currentChoice();
  const user_id=who.textContent.replace(/.*Discord:\s*/,"").trim();
  const name=lastSubmitted?.name||c?.name||"";
  const realm=lastSubmitted?.realm||c?.realm||"";
  notifyBtn.disabled=true;notifyBtn.textContent="Notifying…";
  try{
    const r=await apiFetch(API_BASE+"/notify-ready",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id,name,realm,note:"Left previous guild • <@&"+ROLE_ID+">"})});
    const data=await r.json();
    if(!r.ok||!data.ok){notifyBtn.disabled=false;notifyBtn.textContent="I’ve left my guild — notify officers";alert("Failed to notify.");return}
    currentTicket=data.ticket_id;
    notifyPanel.style.display="block";
    setStatus("queued");
    if(pollId)clearInterval(pollId);
    pollId=setInterval(pollStatus,4000);
    notifyBtn.textContent="Notification sent"
  }catch(e){
    notifyBtn.disabled=false;notifyBtn.textContent="I’ve left my guild — notify officers";
    alert("Network error while notifying.")
  }
});

intake();
</script>
</body>
</html>
