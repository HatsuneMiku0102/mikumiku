<!doctype html><html lang="en"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Finishing sign-in…</title>
<style>
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1200px 600px at 20% 10%,#0b1730,#070b15 65%);color:#e5e7eb;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
.container{max-width:820px;margin:6vh auto;padding:24px}
.card{background:linear-gradient(180deg,#111827cc,#0b1324cc);border:1px solid #1f2937;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px #0006}
.header{padding:22px 22px 10px;border-bottom:1px solid #1f2937}
.title{margin:0;font-size:20px;display:flex;gap:10px;align-items:center}
.dot{width:10px;height:10px;border-radius:999px;background:#34d399;box-shadow:0 0 20px #34d39955}
.sub{margin:6px 0 0;color:#9ca3af;font-size:14px}
.body{padding:22px}
.row{margin:12px 0}
.flex{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.spinner{width:32px;height:32px;border:3px solid #34d39933;border-top-color:#34d399;border-radius:999px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.input,select,button{font:inherit}
.input,select{width:100%;background:#0b1220;color:#e5e7eb;border:1px solid #334155;border-radius:10px;padding:10px 12px;outline:none;transition:border .15s ease,box-shadow .15s ease;font-size:15px}
.input:focus,select:focus{border-color:#34d399;box-shadow:0 0 0 4px #34d39933}
.btn{appearance:none;border:1px solid #10b981;background:linear-gradient(180deg,#34d399,#10b981);color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;transition:transform .08s ease,box-shadow .2s ease;box-shadow:0 6px 20px #10b98144;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn.secondary{background:none;color:#e5e7eb;border-color:#334155;box-shadow:none}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:720px){.grid{grid-template-columns:2fr 3fr}}
.badge{display:inline-block;padding:4px 8px;border:1px solid #334155;border-radius:999px;font-size:12px;color:#9ca3af}
.err{color:#fca5a5}
.ok{color:#86efac}
</style>
<body><div class="container"><div class="card">
<div class="header"><h1 class="title"><span class="dot"></span>Finishing sign-in</h1><p class="sub">Retrieving your characters</p></div>
<div class="body">
  <div id="step-loading" class="row flex"><div class="spinner"></div><div>Talking to server…</div></div>
  <div id="step-error" class="row" style="display:none">
    <div class="row err" id="err-text"></div>
    <div class="row"><a class="btn secondary" href="/">Return</a></div>
  </div>
  <div id="step-select" class="row" style="display:none">
    <div class="row"><span class="badge" id="who"></span></div>
    <div class="grid">
      <div>
        <div class="row"><input id="q" class="input" placeholder="Search name or realm"></div>
        <div class="row"><select id="choice" size="10"></select></div>
      </div>
      <div>
        <div class="row"><button id="submit" class="btn" disabled>Submit application</button> <a class="btn secondary" href="/">Cancel</a></div>
        <div class="row"><span class="badge" id="count"></span></div>
      </div>
    </div>
  </div>
  <div id="step-done" class="row" style="display:none">
    <div class="row ok" id="done-text"></div>
    <div class="row"><a class="btn" href="https://discord.com/app">Return to Discord</a></div>
  </div>
</div>
</div></div>
<script>
const API_BASE="https://mikumikudev-c530e6b3e669.herokuapp.com"
const params=new URLSearchParams(location.search)
const code=params.get("code")||""
const state=params.get("state")||""
const loading=document.getElementById("step-loading")
const stepErr=document.getElementById("step-error")
const errText=document.getElementById("err-text")
const stepSel=document.getElementById("step-select")
const stepDone=document.getElementById("step-done")
const who=document.getElementById("who")
const q=document.getElementById("q")
const sel=document.getElementById("choice")
const btn=document.getElementById("submit")
const count=document.getElementById("count")
let allChoices=[]
function show(id){loading.style.display="none";stepErr.style.display="none";stepSel.style.display="none";stepDone.style.display="none";id.style.display="block"}
function render(list){sel.innerHTML="";list.forEach(o=>{const opt=document.createElement("option");opt.value=o.name+"::"+o.realm;opt.textContent=o.name+" — "+o.realm;sel.appendChild(opt)}) ;count.textContent=list.length+" character(s)";btn.disabled=sel.selectedOptions.length===0}
async function intake(){
  if(!code||!state){errText.textContent="Missing code or state.";show(stepErr);return}
  try{
    const r=await fetch(API_BASE+"/oauth/intake",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({state,code})})
    if(!r.ok){const t=await r.text();errText.textContent="Intake failed: "+t;show(stepErr);return}
    const data=await r.json()
    if(!data.ok){errText.textContent="Server error: "+(data.error||"unknown");show(stepErr);return}
    allChoices=data.choices||[]
    who.textContent="User ID: "+data.user_id
    render(allChoices)
    show(stepSel)
  }catch(e){errText.textContent="Network error.";show(stepErr)}
}
q.addEventListener("input",()=>{const s=q.value.toLowerCase();const f=!s?allChoices:allChoices.filter(o=>o.name.toLowerCase().includes(s)||o.realm.toLowerCase().includes(s));render(f)})
sel.addEventListener("change",()=>{btn.disabled=sel.selectedOptions.length===0})
btn.addEventListener("click",async()=>{
  if(sel.selectedOptions.length===0)return
  btn.disabled=true
  btn.textContent="Submitting…"
  try{
    const body=new URLSearchParams({state,choice:sel.value})
    const r=await fetch(API_BASE+"/oauth/submit",{method:"POST",body})
    if(!r.ok){const t=await r.text();errText.textContent="Submit failed: "+t;show(stepErr);btn.disabled=false;btn.textContent="Submit application";return}
    const data=await r.json()
    if(!data.ok){errText.textContent="Submit error: "+(data.error||data.status||"unknown");show(stepErr);btn.disabled=false;btn.textContent="Submit application";return}
    const m={auto_accepted:"You’re all set. You were auto-accepted.",queued:"Thanks. Your application is pending officer review.",linked_alt:"Alt linked to your profile."}
    document.getElementById("done-text").textContent=m[data.status]||("Status: "+data.status)
    show(stepDone)
  }catch(e){errText.textContent="Network error.";show(stepErr);btn.disabled=false;btn.textContent="Submit application"}
})
intake()
</script>
</body></html>
