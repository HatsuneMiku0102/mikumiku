<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MikuMiku | Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Your existing styles remain unchanged */
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h2>Admin Dashboard</h2>
        <button id="logout">Logout</button>

        <div class="real-time-info">
            <h3>Real-time Active Users</h3>
            <p id="active-users-count">Loading active user count...</p>
            <p id="website-users-count">Website Users: Loading...</p>
            <p id="extension-users-count">Extension Users: Loading...</p>
        </div>

        <div class="user-list">
            <div class="user-group">
                <h3>Combined Users</h3>
                <ul id="combined-ip-list" class="ip-list">Loading...</ul>
            </div>
        </div>

        <!-- Chart section -->
        <div class="chart-container">
            <h3>Visitors by Country</h3>
            <canvas id="locationChart" width="400" height="200"></canvas>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const socket = io();
            const combinedIpListElement = document.getElementById('combined-ip-list');
            const ipElements = new Map();

            socket.on('connect', () => {
                console.log('Connected to socket server.');
            });

            socket.on('connect_error', (error) => {
                console.error('Error connecting to socket:', error);
            });

            socket.on('activeUsersUpdate', (data) => {
                if (data && data.users && Array.isArray(data.users)) {
                    const combinedUsers = data.users.reduce((acc, user) => {
                        const existing = acc.find(u => u.ip === user.ip);
                        if (existing) {
                            existing.connectionTypes.push(user.connectionType);
                        } else {
                            acc.push({
                                ip: user.ip,
                                connectionTypes: [user.connectionType]
                            });
                        }
                        return acc;
                    }, []);

                    document.getElementById('active-users-count').innerText = `Currently Active Users: ${data.users.length}`;
                    combinedIpListElement.innerHTML = '';

                    // Display combined users
                    combinedUsers.forEach(user => {
                        const ipItem = createIpItem(user);
                        combinedIpListElement.appendChild(ipItem);
                    });
                } else {
                    console.warn('No valid active users data found.');
                    document.getElementById('active-users-count').innerText = 'No active users found.';
                }
            });

            socket.on('locationUpdate', (data) => {
                if (data && data.ip) {
                    const ipItem = createIpItem(data);
                    combinedIpListElement.appendChild(ipItem);
                }
            });

            // Helper function to create an IP list item
            function createIpItem(user) {
                const ipItem = document.createElement('li');
                ipItem.classList.add('ip-item');
                ipItem.innerText = `IP: ${user.ip}, Connections: ${user.connectionTypes.join(', ')}`;
                return ipItem;
            }

            // Logout logic
            document.getElementById('logout').addEventListener('click', () => {
                fetch('/logout', { method: 'POST', credentials: 'include' })
                    .then(() => {
                        document.cookie = 'token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                        window.location.href = '/admin-login.html';
                    })
                    .catch(error => console.error('Logout failed:', error));
            });

            // Fetch country data for the chart
            fetch('/api/geo-data')
                .then(response => response.json())
                .then(data => {
                    const countries = data.map(item => item._id || 'Unknown');
                    const visitCounts = data.map(item => item.count);

                    const ctx = document.getElementById('locationChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: countries,
                            datasets: [{
                                label: 'Visitors by Country',
                                data: visitCounts,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                })
                .catch(error => console.error('Error fetching geo data:', error));
        });
    </script>
</body>
</html>
