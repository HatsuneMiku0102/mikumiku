<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikuMiku | Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <canvas id="techCanvas"></canvas>

    <div class="page-container">
        <div class="title-bar">
            <div class="container">
                <div class="left-section"></div>
                <div class="center-section">
                    <div class="logo-title-wrapper">
                        <img src="/logo.webp" alt="Logo" class="logo" loading="lazy">
                        <h1 class="site-title" id="dynamicTitle">MikuMiku</h1>
                    </div>
                </div>
                <div class="right-section">
                    <div class="personality-section">
                        <div id="personalityCircle" class="personality-circle"></div>
                        <div id="personalityTextBox" class="personality-text-box">
                            <div id="personalityPhrase" class="personality-text-wrapper"></div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="dropdown-button">Menu</button>
                        <div class="dropdown-content">
                            <a href="/admin-login.html">Admin Login</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="now-playing-container">
            <div id="nowPlayingBox" class="now-playing">
                <div class="now-playing-sidebar">
                    <div class="sidebar-item">
                        <span>Channel:</span> <span id="channelName">Loading...</span>
                    </div>
                    <div class="sidebar-item">
                        <span>Views:</span> <span id="viewCount">Loading...</span>
                    </div>
                    <div class="sidebar-item">
                        <span>Likes:</span> <span id="likeCount">Loading...</span>
                    </div>
                    <div class="sidebar-item">
                        <span>Uploaded:</span> <span id="publishedDate">Loading...</span>
                    </div>
                    <div class="sidebar-item video-category">
                        <span>Category:</span> <span id="videoCategory">Loading...</span>
                    </div>
                </div>
        
                <div class="video-section">
                    <div class="video-title-container">
                        <h2>Currently Playing</h2>
                        <p id="videoTitle">Loading...</p>
                    </div>
        
                    <div class="thumbnail-container">
                        <img id="videoThumbnail" src="" alt="Thumbnail" class="video-thumbnail" loading="lazy">
                    </div>
        
                    <div id="offline-indicator" class="offline-indicator">I’m not on YouTube at the moment, soz :(</div>
        
                    <!-- Progress Bar -->
                    <div class="progress-bar-container">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>

                    <!-- Time Elapsed under Progress Bar -->
                    <div id="timeElapsedContainer" class="time-elapsed">Time Elapsed: <span id="timeElapsed">0s</span></div>
        
                    <!-- Toggle Description Button -->
                    <button class="toggle-description" id="toggleDescriptionButton">Show Description</button>
                </div>
            </div>
        </div>
        
        <!-- Modal Structure -->
        <div id="descriptionModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeDescriptionButton">&times;</span>
                <h2>Description</h2>
                <p id="videoDescription">Loading description...</p>
            </div>
        </div>

        <div class="widgets-container">
            <div class="live-clock box-container">
                <h3>My Current Time</h3>
                <div class="clock-container">
                    <div class="clock">
                        <p id="local-time">--:--:--</p>
                        <p id="current-date">24 Sep 2024</p>
                    </div>
                </div>
            </div>

            <div class="weather-widget box-container">
                <h3>My Current Weather</h3>
                <div class="weather-info">
                    <img id="weather-icon" src="" alt="Weather Icon" loading="lazy" style="display: none;">
                    <p id="weather-description">Loading...</p>
                    <p id="temperature">--°C</p>
                    <p id="humidity">Humidity: --%</p>
                    <p id="wind-speed">Wind: -- m/s</p>
                </div>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="now-playing-about-wrapper">
                <div class="about box-container" id="aboutMe">
                    <h2>About Me</h2>
                    <p>Hey there, I'm Hystoriya, a 24-year-old developer. This is my personal website that I made for no apparent reason. If you find yourself here randomly, then hi :)</p>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <p>&copy; 2024 MikuMiku. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <div id="chat-box" class="chat-box">
        <div class="chat-header">
            <h3>Haru AI</h3>
            <button id="close-chat" class="close-chat">X</button>
        </div>
        <div id="chat-content" class="chat-content">
            <div class="message bot-message">Hi! I'm Haru, how can I help you today?</div>
        </div>
        <div class="chat-input-container">
            <input type="text" id="chat-input" class="chat-input" placeholder="Type your message..." />
            <button id="send-message" class="send-message">Send</button>
        </div>
    </div>

    <!-- Socket.io Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.1/socket.io.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="haru.js"></script>

    <!-- JavaScript to handle all features -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const socket = io("https://mikumiku.dev");
            let lastHeartbeatReceived = Date.now();
            let isSessionExpired = false;
            let browsingStartTime = null; // Set to null initially
            let browsingInterval = null;
    
            // Now Playing Elements
            const nowPlayingBox = document.getElementById("nowPlayingBox");
            const videoTitleElement = document.getElementById("videoTitle");
            const videoThumbnailElement = document.getElementById("videoThumbnail");
            const offlineIndicatorElement = document.getElementById("offline-indicator");
            const progressBarElement = document.getElementById("progressBar");
            const channelNameElement = document.getElementById("channelName");
            const viewCountElement = document.getElementById("viewCount");
            const likeCountElement = document.getElementById("likeCount");
            const publishedDateElement = document.getElementById("publishedDate");
            const videoCategoryElement = document.getElementById("videoCategory");
            const videoDescriptionElement = document.getElementById("videoDescription");
            const timeElapsedElement = document.getElementById("timeElapsed");
    
            // Helper function to format numbers with commas
            function formatNumber(number) {
                if (typeof number === 'string') {
                    number = number.replace(/,/g, ''); // Remove existing commas
                }
                const num = Number(number);
                return isNaN(num) ? "N/A" : num.toLocaleString();
            }
    
            function clearDisplay() {
                nowPlayingBox.classList.add("offline");
                offlineIndicatorElement.style.display = "block";
                videoTitleElement.textContent = "I’m not on YouTube at the moment, soz :(";
                videoThumbnailElement.src = "";
                videoThumbnailElement.style.display = "none";
                channelNameElement.textContent = "";
                viewCountElement.textContent = "";
                likeCountElement.textContent = "";
                publishedDateElement.textContent = "";
                videoCategoryElement.textContent = "";
                progressBarElement.style.width = "0%";
                videoDescriptionElement.textContent = "";
                timeElapsedElement.textContent = "0s"; // Reset the time elapsed display
            }
    
            function reinitializeSession() {
                console.warn("[Client] Reinitializing session due to mismatch or timeout.");
                clearDisplay();
                isSessionExpired = true; // Stop further updates until session is restarted
            }
    
            function formatTimeElapsed(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;
    
                if (hours > 0) {
                    return `${hours}h ${minutes}m ${remainingSeconds}s`;
                } else if (minutes > 0) {
                    return `${minutes}m ${remainingSeconds}s`;
                } else {
                    return `${remainingSeconds}s`;
                }
            }
    
            function displayVideoPresence(data) {
                lastHeartbeatReceived = Date.now();
                nowPlayingBox.classList.remove("offline");
                offlineIndicatorElement.style.display = "none";
    
                // Update Title
                videoTitleElement.textContent = data.title || "Unknown Title";
    
                // Update Thumbnail
                if (data.thumbnail) {
                    videoThumbnailElement.src = data.thumbnail;
                    videoThumbnailElement.style.display = "block";
                } else {
                    videoThumbnailElement.src = "";
                    videoThumbnailElement.style.display = "none";
                }
    
                // Update Channel Name
                channelNameElement.textContent = data.channelTitle || "Unknown Channel";
    
                // Update View Count with commas
                viewCountElement.textContent = `Views: ${formatNumber(data.viewCount)}` || "Views: N/A";
    
                // Update Like Count with commas
                likeCountElement.textContent = `Likes: ${formatNumber(data.likeCount)}` || "Likes: N/A";
    
                // Update Published Date
                if (data.publishedAt) {
                    const publishedDate = new Date(data.publishedAt);
                    publishedDateElement.textContent = `Published on: ${publishedDate.toLocaleDateString()}` || "Published on: N/A";
                } else {
                    publishedDateElement.textContent = "Published on: N/A";
                }
    
                // Update Video Category
                videoCategoryElement.textContent = `Category: ${data.category}` || "Category: N/A";
    
                // Update Description
                videoDescriptionElement.textContent = data.description || "No description available.";
    
                // Handle Progress Bar Update
                handleRealTimeProgress(data);
            }
    
            function handleRealTimeProgress(data) {
                if (data.duration && data.currentTime) {
                    const progressPercentage = (data.currentTime / data.duration) * 100;
                    progressBarElement.style.width = `${progressPercentage}%`;
                } else {
                    progressBarElement.style.width = "0%";
                }
            }
    
            function displayBrowsingPresence() {
                nowPlayingBox.classList.remove("offline");
                offlineIndicatorElement.style.display = "none";
                videoTitleElement.textContent = "Browsing YouTube";
                videoThumbnailElement.src = "https://i.postimg.cc/GpgNPv0R/custom-browsing-thumbnail.png";
                videoThumbnailElement.style.display = "block";
                channelNameElement.textContent = "Browsing...";
                viewCountElement.textContent = "";
                likeCountElement.textContent = "";
                publishedDateElement.textContent = "";
                videoCategoryElement.textContent = "";
                videoDescriptionElement.textContent = "Browsing videos on YouTube";
                progressBarElement.style.width = "0%";
            }
    
            function updateBrowsingPresence() {
                if (browsingStartTime) {
                    const timeElapsed = Math.floor((Date.now() - browsingStartTime) / 1000);
                    timeElapsedElement.textContent = formatTimeElapsed(timeElapsed);
    
                    const browsingData = {
                        title: 'YouTube',
                        description: 'Browsing videos',
                        thumbnail: 'https://i.postimg.cc/GpgNPv0R/custom-browsing-thumbnail.png',
                        timeElapsed: timeElapsed,
                        presenceType: 'browsing'
                    };
                    socket.emit('updateBrowsingPresence', browsingData);
                }
            }
    
            function startBrowsingPresence() {
                if (!browsingStartTime) {
                    browsingStartTime = Date.now(); // Set browsing start time only if it's not already set
                }
                updateBrowsingPresence(); // Update immediately
                if (!browsingInterval) {
                    browsingInterval = setInterval(updateBrowsingPresence, 15000); // Update every 15 seconds
                }
            }
    
            function stopBrowsingPresence() {
                if (browsingInterval) {
                    clearInterval(browsingInterval);
                    browsingInterval = null;
                }
                browsingStartTime = null; // Reset browsing start time when browsing ends
            }
    
            // Socket.IO event listeners
            socket.on("connect", () => {
                console.log("[Socket.IO] Connected to server.");
                isSessionExpired = false;
                socket.emit('requestLatestData');
            });
    
            socket.on("presenceUpdate", (data) => {
                if (isSessionExpired) {
                    console.warn("[Client] Ignoring presenceUpdate due to expired session.");
                    return;
                }
    
                console.log("[Socket.IO] Received presenceUpdate:", data);
                lastHeartbeatReceived = Date.now();
    
                if (data.presenceType === 'video') {
                    stopBrowsingPresence();
                    displayVideoPresence(data);
                } else if (data.presenceType === 'browsing') {
                    startBrowsingPresence();
                    displayBrowsingPresence();
                } else {
                    clearDisplay();
                }
            });
    
            socket.on("reinitializeSession", (data) => {
                console.warn(`[Socket.IO] Received reinitializeSession: ${JSON.stringify(data)}`);
                reinitializeSession();
            });
    
            socket.on("sessionExpired", (data) => {
                console.warn(`[Socket.IO] Session expired for video ID: ${data.videoId}`);
                reinitializeSession();
            });
    
            socket.on("disconnect", () => {
                console.warn("[Socket.IO] Disconnected from server.");
                stopBrowsingPresence();
                clearDisplay();
            });
    
            setInterval(() => {
                if (Date.now() - lastHeartbeatReceived > 60000) {
                    console.warn("[Heartbeat] No heartbeat received in the last 60 seconds. Marking as offline.");
                    clearDisplay();
                }
            }, 15000);
    
            // Modal Toggle Logic
            const descriptionModal = document.getElementById("descriptionModal");
            const closeDescriptionButton = document.getElementById("closeDescriptionButton");
            const toggleDescriptionButton = document.getElementById("toggleDescriptionButton");
    
            toggleDescriptionButton.addEventListener("click", function () {
                if (descriptionModal.style.display === "block") {
                    descriptionModal.style.display = "none";
                    toggleDescriptionButton.textContent = "Show Description";
                } else {
                    descriptionModal.style.display = "block";
                    toggleDescriptionButton.textContent = "Hide Description";
                }
            });
    
            closeDescriptionButton.addEventListener("click", function () {
                descriptionModal.style.display = "none";
                toggleDescriptionButton.textContent = "Show Description";
            });
    
            window.addEventListener("click", function (event) {
                if (event.target === descriptionModal) {
                    descriptionModal.style.display = "none";
                    toggleDescriptionButton.textContent = "Show Description";
                }
            });
    
            // Clock Update Script
            function updateClocks() {
                const now = new Date();
                const localTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const localTimeElement = document.getElementById('local-time');
                if (localTimeElement) localTimeElement.textContent = localTime;
                const currentDate = now.toLocaleDateString(undefined, { day: '2-digit', month: 'short', year: 'numeric' });
                const currentDateElement = document.getElementById('current-date');
                if (currentDateElement) currentDateElement.textContent = currentDate;
            }
    
            setInterval(updateClocks, 1000);
            updateClocks();
    
            // Weather Update Script
            const CITY_NAME = 'Leeds';
            async function fetchWeather() {
                try {
                    const response = await fetch(`/api/weather?city=${encodeURIComponent(CITY_NAME)}`);
                    const data = await response.json();
    
                    if (data.error) {
                        throw new Error(data.error);
                    }
    
                    displayWeather(data);
                } catch (error) {
                    console.error('Error fetching weather data:', error);
                    const weatherIconElement = document.getElementById('weather-icon');
                    if (weatherIconElement) weatherIconElement.style.display = 'none';
                    document.getElementById('weather-description').innerText = 'Unable to fetch weather data.';
                }
            }
    
            function displayWeather(data) {
                const description = data.weather[0].description;
                const temperature = Math.round(data.main.temp);
                const humidity = data.main.humidity;
                const windSpeed = data.wind.speed;
                const iconCode = data.weather[0].icon;
                const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
    
                document.getElementById('weather-description').innerText = `Condition: ${description}`;
                document.getElementById('temperature').innerText = `Temperature: ${temperature}°C`;
                document.getElementById('humidity').innerText = `Humidity: ${humidity}%`;
                document.getElementById('wind-speed').innerText = `Wind: ${windSpeed} m/s`;
    
                const weatherIconElement = document.getElementById('weather-icon');
                if (weatherIconElement) {
                    weatherIconElement.src = iconUrl;
                    weatherIconElement.style.display = 'block';
                }
            }
    
            setInterval(fetchWeather, 3600000);
            fetchWeather();

   
            // Canvas Animation Script
            const canvas = document.getElementById("techCanvas");
            const ctx = canvas.getContext("2d");
            let width = window.innerWidth;
            let height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;

            window.addEventListener('resize', () => {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
                preRenderNebula();
            });

            const offscreenCanvas = document.createElement('canvas');
            const offscreenCtx = offscreenCanvas.getContext('2d');
            offscreenCanvas.width = width;
            offscreenCanvas.height = height;

            const nebulaColors = [
                'rgba(52, 7, 91, 0.8)',
                'rgba(73, 48, 107, 0.7)',
                'rgba(118, 24, 120, 0.6)',
                'rgba(255, 144, 253, 0.4)',
                'rgba(255, 255, 255, 0.1)'
            ];

            function preRenderNebula() {
                offscreenCtx.clearRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
                const gradient = offscreenCtx.createRadialGradient(
                    width / 2,
                    height / 2,
                    100,
                    width / 2,
                    height / 2,
                    Math.max(width, height) / 2
                );

                nebulaColors.forEach((color, index) => {
                    gradient.addColorStop(index / (nebulaColors.length - 1), color);
                });

                offscreenCtx.fillStyle = gradient;
                offscreenCtx.fillRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
            }

            preRenderNebula();

            const stars = [];
            const STAR_COUNT = 100;

            for (let i = 0; i < STAR_COUNT; i++) {
                stars.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    radius: Math.random() * 1.5 + 0.5,
                    speed: Math.random() * 0.5 + 0.2,
                    brightness: Math.random() * 0.5 + 0.5,
                    twinkleSpeed: Math.random() * 0.02 + 0.01
                });
            }

            const shootingStars = [];
            const SHOOTING_STAR_POOL_SIZE = 10;
            const MAX_SHOOTING_STARS = 5;
            let activeShootingStars = 0;

            for (let i = 0; i < SHOOTING_STAR_POOL_SIZE; i++) {
                shootingStars.push({
                    x: Math.random() * width,
                    y: Math.random() * height * 0.5,
                    length: Math.random() * 100 + 50,
                    speed: Math.random() * 8 + 4,
                    active: false
                });
            }

            function activateShootingStar() {
                for (let star of shootingStars) {
                    if (!star.active) {
                        star.x = Math.random() * width;
                        star.y = Math.random() * height * 0.5;
                        star.length = Math.random() * 100 + 50;
                        star.speed = Math.random() * 8 + 4;
                        star.active = true;
                        activeShootingStars++;
                        break;
                    }
                }
            }

            function deactivateShootingStar(star) {
                star.active = false;
                activeShootingStars--;
            }

            setInterval(() => {
                if (activeShootingStars < MAX_SHOOTING_STARS) {
                    activateShootingStar();
                }
            }, 2000);

            function animate() {
                ctx.clearRect(0, 0, width, height);
                ctx.drawImage(offscreenCanvas, 0, 0, width, height);

                ctx.fillStyle = 'white';
                for (let star of stars) {
                    star.brightness += star.twinkleSpeed;
                    if (star.brightness > 1 || star.brightness < 0.5) {
                        star.twinkleSpeed *= -1;
                    }

                    star.x -= star.speed;
                    if (star.x < 0) star.x = width;

                    ctx.globalAlpha = star.brightness;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1;

                ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.lineWidth = 2;
                ctx.shadowBlur = 10;
                ctx.shadowColor = 'white';
                ctx.globalCompositeOperation = 'lighter';
                for (let star of shootingStars) {
                    if (star.active) {
                        ctx.beginPath();
                        ctx.moveTo(star.x, star.y);
                        ctx.lineTo(star.x + star.length, star.y - star.length * 0.5);
                        ctx.stroke();

                        star.x -= star.speed;
                        star.y += star.speed * 0.5;

                        if (star.x < 0 || star.y > height) {
                            deactivateShootingStar(star);
                        }
                    }
                }
                ctx.shadowBlur = 0;
                ctx.globalCompositeOperation = 'source-over';

                requestAnimationFrame(animate);
            }

            animate();
        });
    </script>
</body>

</html>
