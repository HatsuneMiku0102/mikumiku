<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Miku.dev | Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <canvas id="soundWaveCanvas" aria-hidden="true"></canvas>
    <div class="page-container" id="pageContainer">
      <header class="title-bar" id="titleBar">
        <div class="container">
          <div class="left-section"></div>
          <div class="title-wrapper">
            <a href="/" aria-label="Home" class="logo-link">
              <span class="site-title">Miku.dev</span>
              <div class="visualizer-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 100" class="visualizer">
                  <g>
                    <rect x="10" y="70" width="15" height="30" fill="#00c6ff">
                      <animate attributeName="height" values="30;60;30" dur="0.8s" repeatCount="indefinite" />
                      <animate attributeName="y" values="70;40;70" dur="0.8s" repeatCount="indefinite" />
                    </rect>
                    <rect x="35" y="60" width="15" height="40" fill="#ff4081">
                      <animate attributeName="height" values="40;80;40" dur="1s" repeatCount="indefinite" />
                      <animate attributeName="y" values="60;20;60" dur="1s" repeatCount="indefinite" />
                    </rect>
                    <rect x="60" y="80" width="15" height="20" fill="#00c6ff">
                      <animate attributeName="height" values="20;50;20" dur="0.6s" repeatCount="indefinite" />
                      <animate attributeName="y" values="80;50;80" dur="0.6s" repeatCount="indefinite" />
                    </rect>
                    <rect x="85" y="50" width="15" height="50" fill="#ff4081">
                      <animate attributeName="height" values="50;90;50" dur="1.2s" repeatCount="indefinite" />
                      <animate attributeName="y" values="50;10;50" dur="1.2s" repeatCount="indefinite" />
                    </rect>
                    <rect x="110" y="70" width="15" height="30" fill="#00c6ff">
                      <animate attributeName="height" values="30;60;30" dur="0.9s" repeatCount="indefinite" />
                      <animate attributeName="y" values="70;40;70" dur="0.9s" repeatCount="indefinite" />
                    </rect>
                    <rect x="135" y="60" width="15" height="40" fill="#ff4081">
                      <animate attributeName="height" values="40;80;40" dur="1.1s" repeatCount="indefinite" />
                      <animate attributeName="y" values="60;20;60" dur="1.1s" repeatCount="indefinite" />
                    </rect>
                  </g>
                </svg>
              </div>
            </a>
          </div>
          <div class="right-section">
            <button class="menu-button" id="menuButton" aria-label="Open Menu">
              <i class="fas fa-music"></i>
            </button>
          </div>
        </div>
      </header>
      <nav class="overlay-menu" id="overlayMenu">
        <button class="close-overlay" id="closeOverlay" aria-label="Close Menu">
          <i class="fas fa-times"></i>
        </button>
        <div class="overlay-content">
          <a href="/auth" aria-label="Admin Login">
            <i class="fas fa-user-lock"></i> Admin Login
          </a>
          <a href="#aboutMe" aria-label="About Me">
            <i class="fas fa-info-circle"></i> About Me
          </a>
          <div class="personality-options">
            <button id="personalityOption1" class="personality-button">
              <i class="fas fa-music"></i> Melody
            </button>
            <button id="personalityOption2" class="personality-button">
              <i class="fas fa-headphones"></i> Harmony
            </button>
            <button id="personalityOption3" class="personality-button">
              <i class="fas fa-microphone"></i> Rhythm
            </button>
          </div>
        </div>
      </nav>
      <section class="now-playing-container">
        <div id="nowPlayingBox" class="grid-container">
          <div id="videoInfo">
            <div class="video-info-details">
              <div class="info-item"><i class="fas fa-tv"></i> <span id="channelName">Loading...</span></div>
              <div class="info-item"><i class="fas fa-eye"></i> <span id="viewCount">Loading...</span></div>
              <div class="info-item"><i class="fas fa-thumbs-up"></i> <span id="likeCount">Loading...</span></div>
              <div class="info-item"><i class="fas fa-calendar-day"></i> <span id="publishedDate">Loading...</span></div>
              <div class="info-item video-category"><i class="fas fa-tag"></i> <span id="videoCategory">Loading...</span></div>
            </div>
          </div>
          <div id="timeInfo">
            <section class="clock-section">
              <p id="greeting" class="greeting"><i class="fas fa-sun"></i> <span id="greeting-text">Good Morning!</span></p>
              <div class="clocks-container">
                <div class="digital-clock">
                  <p id="local-time"><i class="fas fa-clock"></i> 00:03:56</p>
                  <p id="current-date"><i class="fas fa-calendar-alt"></i> 14 October 2024</p>
                  <p id="day-of-week"><i class="fas fa-calendar-day"></i> Monday</p>
                  <p id="time-zone"><i class="fas fa-globe"></i> UTC</p>
                </div>
              </div>
              <p id="last-visit-message" class="last-visit-message"><i class="fas fa-history"></i> Welcome back!</p>
            </section>
          </div>
          <div id="youtubeSection">
            <div class="video-title-container">
              <h2>Currently Playing</h2>
              <p id="videoTitle">Loading...</p>
            </div>
            <div class="thumbnail-container">
              <img id="videoThumbnailImage" src="" alt="Thumbnail" class="video-thumbnail" loading="lazy" />
            </div>
            <div class="progress-container">
              <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
              </div>
              <div class="indicator-container">
                <span id="liveIndicator" class="indicator live">Live</span>
                <span id="pauseIndicator" class="indicator paused">Paused</span>
              </div>
            </div>
            <div id="offline-indicator" class="offline-indicator">
              <i class="fas fa-signal-slash"></i> I’m currently offline
            </div>
            <div class="description-and-time">
              <div id="timeElapsedContainer" style="display: none;"></div>
              <button class="toggle-description" id="toggleDescriptionButton" aria-label="Toggle Description">
                <i class="fas fa-info-circle"></i> Show Description
              </button>
              <div id="descriptionModal">
                <h2 id="descriptionModalTitle">Description</h2>
                <p id="descriptionModalDescription">Loading description...</p>
              </div>
            </div>
          </div>
          <div id="weatherSection">
            <aside class="weather-section">
              <img id="weather-icon" src="" alt="Weather Icon" class="weather-icon" loading="lazy" />
              <p id="weather-description" class="weather-description"><i class="fas fa-cloud-sun"></i> Loading...</p>
              <p id="temperature" class="temperature"><i class="fas fa-temperature-high"></i> --°C</p>
              <p id="humidity" class="humidity"><i class="fas fa-tint"></i> Humidity: --%</p>
              <p id="wind-speed" class="wind-speed"><i class="fas fa-wind"></i> Wind: -- m/s</p>
            </aside>
          </div>
        </div>
        <div id="bufferOverlay" class="buffer-overlay">Buffering...</div>
      </section>
      <footer class="footer">
        <div class="container">
          <p>&copy; 2024 MikuMiku. All rights reserved.</p>
          <button id="manageConsentFooter" class="manage-consent-button">
            <i class="fas fa-cookie-bite"></i> Manage Cookie Preferences
          </button>
        </div>
      </footer>
      <div id="consentModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="consentModalTitle" aria-describedby="consentModalDescription">
        <div class="modal-content">
          <button class="close-button" id="closeConsentModal" aria-label="Close Consent Modal">
            <i class="fas fa-times"></i>
          </button>
          <h2 id="consentModalTitle"><i class="fas fa-cookie"></i> Cookie Consent</h2>
          <p id="consentModalDescription">
            I use cookies stored in your browser to enhance your experience on my personal website. These cookies are essential for the website's functionality. By clicking "Accept," you consent to their use. You can also manage your cookie preferences in the "Manage Cookie Preferences" section.
          </p>
          <div class="consent-buttons">
            <button id="acceptConsent" class="consent-button"><i class="fas fa-check"></i> Accept</button>
            <button id="declineConsent" class="consent-button"><i class="fas fa-times"></i> Decline</button>
          </div>
        </div>
      </div>
    </div>
    <!-- External Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.1/socket.io.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="haru.js"></script>
    <script src="clockwork.js"></script>
    <!-- Initialization Scripts -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("pageContainer").classList.add("loaded");

        const titleBar = document.getElementById("titleBar");
        if (titleBar) {
          window.addEventListener("scroll", function () {
            titleBar.classList.toggle("scrolled", window.scrollY > 50);
          });
        }

        const menuButton = document.getElementById("menuButton");
        const overlayMenu = document.getElementById("overlayMenu");
        const closeOverlay = document.getElementById("closeOverlay");
        if (menuButton && overlayMenu) {
          menuButton.addEventListener("click", function (e) {
            e.stopPropagation();
            overlayMenu.classList.add("active");
            document.body.classList.add("overlay-active");
          });
        }
        if (closeOverlay && overlayMenu) {
          closeOverlay.addEventListener("click", function (e) {
            e.stopPropagation();
            overlayMenu.classList.remove("active");
            document.body.classList.remove("overlay-active");
          });
        }
        window.addEventListener("click", function (event) {
          if (event.target === overlayMenu) {
            overlayMenu.classList.remove("active");
            document.body.classList.remove("overlay-active");
          }
        });

        const personalityButtons = document.querySelectorAll(".personality-button");
        const siteTitle = document.querySelector(".site-title");
        if (personalityButtons.length && siteTitle) {
          personalityButtons.forEach((button) => {
            button.addEventListener("click", function () {
              const personality = button.textContent.trim();
              if (personality === "Melody") siteTitle.style.color = "#ff4081";
              else if (personality === "Harmony") siteTitle.style.color = "#00c6ff";
              else if (personality === "Rhythm") siteTitle.style.color = "#ffffff";
              else siteTitle.style.color = "#00c6ff";
              personalityButtons.forEach((btn) => btn.classList.remove("active"));
              button.classList.add("active");
            });
          });
        }
      });
    </script>
    <!-- Consent Modal Script -->
    <script>
      (function () {
        "use strict";
        const CONFIG = {
          consentCookieName: "cookieConsent",
          consentCookieExpiryDays: 365,
          consentCookiePath: "/",
          consentModalId: "consentModal",
          acceptButtonId: "acceptConsent",
          declineButtonId: "declineConsent",
          manageButtonIds: ["manageConsentFooter"],
          closeButtonId: "closeConsentModal",
          cookieCategories: { necessary: { enabled: true, description: "Necessary cookies enable core functionalities and security features of the website." } },
          focusableSelectors: "button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])"
        };
        const consentModal = document.getElementById(CONFIG.consentModalId);
        const acceptButton = document.getElementById(CONFIG.acceptButtonId);
        const declineButton = document.getElementById(CONFIG.declineButtonId);
        const closeButton = document.getElementById(CONFIG.closeButtonId);
        const manageConsentButtons = CONFIG.manageButtonIds.map((id) => document.getElementById(id));
        function setCookie(name, value, days, path) {
          let expires = "";
          if (days) {
            const date = new Date();
            date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
            expires = "; expires=" + date.toUTCString();
          }
          const secure = location.protocol === "https:" ? "; Secure" : "";
          const sameSite = "; SameSite=Lax";
          document.cookie = name + "=" + (value || "") + expires + "; path=" + path + secure + sameSite;
        }
        function getCookie(name) {
          const nameEQ = name + "=";
          const ca = document.cookie.split(";");
          for (let c of ca) {
            c = c.trim();
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
          }
          return null;
        }
        function eraseCookie(name, path) {
          document.cookie = name + '=; Max-Age=-99999999; path=' + path + ';';
        }
        function trapFocus(modal) {
          const focusableElements = modal.querySelectorAll(CONFIG.focusableSelectors);
          if (!focusableElements.length) return;
          const firstFocusableElement = focusableElements[0],
                lastFocusableElement = focusableElements[focusableElements.length - 1];
          modal.addEventListener("keydown", function (event) {
            if (event.key === "Tab") {
              if (event.shiftKey) {
                if (document.activeElement === firstFocusableElement) {
                  event.preventDefault();
                  lastFocusableElement.focus();
                }
              } else {
                if (document.activeElement === lastFocusableElement) {
                  event.preventDefault();
                  firstFocusableElement.focus();
                }
              }
            }
            if (event.key === "Escape") { event.preventDefault(); }
          });
        }
        function showModal() {
          consentModal.classList.add("active");
          document.body.classList.add("modal-active");
          consentModal.setAttribute("aria-hidden", "false");
          const focusableElements = consentModal.querySelectorAll(CONFIG.focusableSelectors);
          if (focusableElements.length) focusableElements[0].focus();
          trapFocus(consentModal);
        }
        function hideModal() {
          consentModal.classList.remove("active");
          document.body.classList.remove("modal-active");
          consentModal.setAttribute("aria-hidden", "true");
        }
        function initConsentModal() {
          const existingConsent = getCookie(CONFIG.consentCookieName);
          if (!existingConsent) {
            showModal();
          } else {
            applyConsent(existingConsent);
          }
          if (acceptButton) {
            acceptButton.addEventListener("click", function () {
              setCookie(CONFIG.consentCookieName, JSON.stringify({ necessary: true }), CONFIG.consentCookieExpiryDays, CONFIG.consentCookiePath);
              hideModal();
              initializeCookies();
            });
          } else {
            console.error("Accept button not found.");
          }
          if (declineButton) {
            declineButton.addEventListener("click", function () {
              setCookie(CONFIG.consentCookieName, JSON.stringify({ necessary: false }), CONFIG.consentCookieExpiryDays, CONFIG.consentCookiePath);
              hideModal();
              disableCookies();
            });
          } else {
            console.error("Decline button not found.");
          }
          manageConsentButtons.forEach((button) => {
            if (button) {
              button.addEventListener("click", function (event) {
                event.preventDefault();
                showModal();
              });
            } else {
              console.error("A manage consent button was not found.");
            }
          });
          if (closeButton) {
            closeButton.addEventListener("click", function () {
              alert("Please make a choice regarding cookie usage.");
            });
          } else {
            console.error("Close button not found.");
          }
          window.addEventListener("click", function (event) {
            if (event.target === consentModal) {
              alert("Please make a choice regarding cookie usage.");
            }
          });
        }
        function applyConsent(consentValue) {
          try {
            const consent = JSON.parse(consentValue);
            if (consent.necessary) {
              initializeCookies(consent);
            } else {
              disableCookies();
            }
          } catch (error) {
            console.error("Error parsing consent cookie:", error);
            showModal();
          }
        }
        function initializeCookies(consent) {
          console.log("Necessary cookies enabled.");
        }
        function disableCookies() {
          console.log("Necessary cookies disabled.");
        }
        function areCookiesEnabled() {
          const testCookie = "test_cookie_consent";
          setCookie(testCookie, "test", 1);
          const result = getCookie(testCookie) === "test";
          eraseCookie(testCookie);
          return result;
        }
        function init() {
          if (areCookiesEnabled()) {
            initConsentModal();
          } else {
            console.warn("Cookies are disabled in this browser. Consent modal will not be displayed.");
          }
        }
        document.addEventListener("DOMContentLoaded", init);
      })();
    </script>
    <!-- Video Presence Script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let currentVideoTitle = "";
        let currentVideoThumbnail = "";
        let isBrowsing = false;
        let isOffline = false;
        let browsingStartTime = null;
        let browsingInterval = null;
        let isBuffering = false;
        const log = (message) => console.log(`[Haru.js] ${message}`);

        if (localStorage.getItem("browsingStartTime")) {
          browsingStartTime = parseInt(localStorage.getItem("browsingStartTime"));
          isBrowsing = true;
          displayBrowsingPresence({
            presenceType: "browsing",
            title: "Browsing YouTube",
            description: "Browsing videos on YouTube",
            channelTitle: "Browsing...",
            viewCount: "",
            likeCount: "",
            publishedAt: "",
            category: ""
          });
        }

        const nowPlayingBox = document.getElementById("nowPlayingBox");
        const videoTitleElement = document.getElementById("videoTitle");
        const videoThumbnailImage = document.getElementById("videoThumbnailImage");
        const offlineIndicatorElement = document.getElementById("offline-indicator");
        const progressBarElement = document.getElementById("progressBar");
        const channelNameElement = document.getElementById("channelName");
        const viewCountElement = document.getElementById("viewCount");
        const likeCountElement = document.getElementById("likeCount");
        const publishedDateElement = document.getElementById("publishedDate");
        const videoCategoryElement = document.getElementById("videoCategory");
        const timeElapsedContainer = document.getElementById("timeElapsedContainer");
        const liveIndicatorElement = document.getElementById("liveIndicator");
        const pauseIndicatorElement = document.getElementById("pauseIndicator");
        const youtubeSection = document.getElementById("youtubeSection");
        const bufferOverlay = document.getElementById("bufferOverlay");

        function formatNumber(number) {
          if (typeof number === "string") number = number.replace(/,/g, "");
          const num = Number(number);
          return isNaN(num) ? "N/A" : num.toLocaleString();
        }
        function formatElapsedTime(seconds) {
          const hrs = Math.floor(seconds / 3600);
          const mins = Math.floor((seconds % 3600) / 60);
          const secs = seconds % 60;
          if (hrs > 0) return `${hrs}h ${mins}m ${secs}s`;
          else if (mins > 0) return `${mins}m ${secs}s`;
          else return `${secs}s`;
        }
        function updateBrowsingElapsed() {
          if (browsingStartTime && timeElapsedContainer) {
            const elapsedSec = Math.floor((Date.now() - browsingStartTime) / 1000);
            timeElapsedContainer.style.display = "block";
            timeElapsedContainer.innerHTML = `<i class="fas fa-clock"></i> ${formatElapsedTime(elapsedSec)}`;
          }
        }
        function restoreYoutubeSection() {
          const ytSection = document.getElementById("youtubeSection");
          if (ytSection) {
            Array.from(ytSection.children).forEach(child => {
              if (child.id === "offline-indicator") {
                child.style.display = "none";
              } else {
                child.style.display = "block";
              }
            });
          }
        }
        function clearDisplay() {
          if (isBuffering) return;
          if (nowPlayingBox) nowPlayingBox.classList.add("offline");
          const ytSection = document.getElementById("youtubeSection");
          if (ytSection) {
            Array.from(ytSection.children).forEach(child => {
              if (child.id !== "offline-indicator") {
                child.style.display = "none";
              }
            });
          }
          if (offlineIndicatorElement) {
            offlineIndicatorElement.style.display = "block";
            offlineIndicatorElement.classList.add("visible");
          }
          const videoTitleContainer = document.querySelector(".video-title-container");
          if (videoTitleContainer) {
            videoTitleContainer.innerHTML = '<h2>Currently Playing</h2><p id="videoTitle"></p>';
          }
          const thumbnailContainer = document.querySelector(".thumbnail-container");
          if (thumbnailContainer) {
            thumbnailContainer.style.display = "none";
          }
          if (channelNameElement) channelNameElement.textContent = "";
          if (viewCountElement) viewCountElement.textContent = "";
          if (likeCountElement) likeCountElement.textContent = "";
          if (publishedDateElement) publishedDateElement.textContent = "";
          if (videoCategoryElement) videoCategoryElement.textContent = "";
          if (progressBarElement) progressBarElement.style.width = "0%";
          if (timeElapsedContainer) timeElapsedContainer.style.display = "none";
          clearInterval(browsingInterval);
          browsingInterval = null;
          browsingStartTime = null;
          localStorage.removeItem("browsingStartTime");
          log("Display cleared (offline).");
          const toggleButton = document.getElementById("toggleDescriptionButton");
          if (toggleButton) toggleButton.style.display = "none";
        }
        function handleRealTimeProgress(data) {
          if (data.duration && data.currentTime !== undefined) {
            const progressPercentage = (data.currentTime / data.duration) * 100;
            if (progressBarElement) progressBarElement.style.width = progressPercentage + "%";
            log(`handleRealTimeProgress: isLive=${data.isLive}, isPaused=${data.isPaused}, progress=${progressPercentage.toFixed(2)}%`);
            if (data.isLive && data.isPaused) log("Conflict: Both isLive and isPaused are true. Prioritizing live indicator.");
            if (data.isLive) {
              if (liveIndicatorElement) liveIndicatorElement.classList.add("active");
              if (pauseIndicatorElement) pauseIndicatorElement.classList.remove("active");
              log("Live stream indicator activated.");
            } else if (data.isPaused) {
              if (liveIndicatorElement) liveIndicatorElement.classList.remove("active");
              if (pauseIndicatorElement) pauseIndicatorElement.classList.add("active");
              log("Pause indicator activated.");
            } else {
              if (liveIndicatorElement) liveIndicatorElement.classList.remove("active");
              if (pauseIndicatorElement) pauseIndicatorElement.classList.remove("active");
              log("Both indicators deactivated.");
            }
          } else {
            if (progressBarElement) progressBarElement.style.width = "0%";
            log("handleRealTimeProgress: Invalid data received.");
          }
          if (!data.isPaused && !data.isLive && videoTitleElement) {
            videoTitleElement.classList.add("playing");
          } else if (videoTitleElement) {
            videoTitleElement.classList.remove("playing");
          }
        }
        function animateTitle(text) {
          const oldTitle = document.getElementById("videoTitle");
          if (!oldTitle) return;
          const newTitle = oldTitle.cloneNode(true);
          newTitle.textContent = text;
          newTitle.classList.remove("new-video-title");
          void newTitle.offsetWidth;
          newTitle.classList.add("new-video-title");
          oldTitle.parentNode.replaceChild(newTitle, oldTitle);
        }
        function animateThumbnail(src) {
          const oldThumb = document.getElementById("videoThumbnailImage");
          if (!oldThumb) return;
          const newThumb = oldThumb.cloneNode(true);
          newThumb.src = src;
          newThumb.style.display = "block";
          newThumb.classList.remove("new-video-thumbnail");
          void newThumb.offsetWidth;
          newThumb.classList.add("new-video-thumbnail");
          oldThumb.parentNode.replaceChild(newThumb, oldThumb);
        }
        function displayVideoPresence(data) {
          lastHeartbeatReceived = Date.now();
          isBrowsing = false;
          if (offlineIndicatorElement) {
            offlineIndicatorElement.classList.remove("visible");
            offlineIndicatorElement.style.display = "none";
            isOffline = false;
          }
          if (timeElapsedContainer) timeElapsedContainer.style.display = "none";
          restoreYoutubeSection();
          if (data.title === currentVideoTitle && data.thumbnail === currentVideoThumbnail) {
            handleRealTimeProgress(data);
            return;
          }
          currentVideoTitle = data.title;
          currentVideoThumbnail = data.thumbnail;
          isBuffering = true;
          if (bufferOverlay) bufferOverlay.classList.add("active");
          if (youtubeSection) youtubeSection.classList.add("fade-out");
          setTimeout(function () {
            animateTitle(data.title || "Unknown Title");
            if (data.thumbnail) {
              animateThumbnail(data.thumbnail);
            } else if (videoThumbnailImage) {
              videoThumbnailImage.src = "";
              videoThumbnailImage.style.display = "none";
            }
            if (channelNameElement) channelNameElement.textContent = data.channelTitle || "Unknown Channel";
            if (viewCountElement) viewCountElement.textContent = formatNumber(data.viewCount) || "N/A";
            if (likeCountElement) likeCountElement.textContent = formatNumber(data.likeCount) || "N/A";
            if (publishedDateElement) {
              if (data.publishedAt) {
                const publishedDate = new Date(data.publishedAt);
                publishedDateElement.textContent = publishedDate.toLocaleDateString() || "Published on: N/A";
              } else {
                publishedDateElement.textContent = "Published on: N/A";
              }
            }
            if (videoCategoryElement) videoCategoryElement.textContent = data.category || "N/A";
            const descModal = document.getElementById("descriptionModal");
            if (descModal) {
              const p = descModal.querySelector("p");
              if (p) p.textContent = data.description || "No description available.";
              descModal.classList.remove("active");
            }
            if (youtubeSection) {
              youtubeSection.classList.remove("fade-out");
              youtubeSection.classList.add("fade-in");
            }
            if (nowPlayingBox) nowPlayingBox.classList.remove("offline");
            if (offlineIndicatorElement) {
              offlineIndicatorElement.classList.remove("visible");
              offlineIndicatorElement.style.display = "none";
            }
            if (bufferOverlay) bufferOverlay.classList.remove("active");
            isBuffering = false;
            log("Video presence updated in UI.");
            const toggleButton = document.getElementById("toggleDescriptionButton");
            if (toggleButton) toggleButton.style.display = "block";
            handleRealTimeProgress(data);
          }, 300);
        }
        function displayBrowsingPresence(data) {
          lastHeartbeatReceived = Date.now();
          if (nowPlayingBox) nowPlayingBox.classList.remove("offline");
          if (offlineIndicatorElement) {
            offlineIndicatorElement.classList.remove("visible");
            offlineIndicatorElement.style.display = "none";
            isOffline = false;
          }
          log("Updating browsing presence...");
          if (!isBrowsing) {
            currentVideoTitle = "";
            currentVideoThumbnail = "";
            animateTitle(data.title || "Browsing YouTube");
            const thumbImg = document.getElementById("videoThumbnailImage");
            if (thumbImg) {
              thumbImg.src = "https://www.youtube.com/img/desktop/yt_1200.png";
              thumbImg.style.display = "block";
            }
            const thumbnailContainer = document.querySelector(".thumbnail-container");
            if (thumbnailContainer) {
              thumbnailContainer.style.display = "block";
            }
            isBrowsing = true;
            browsingStartTime = Date.now();
            localStorage.setItem("browsingStartTime", browsingStartTime);
          } else {
            if (videoTitleElement) videoTitleElement.textContent = data.title || "Browsing YouTube";
            const thumbImg = document.getElementById("videoThumbnailImage");
            if (thumbImg) thumbImg.src = "https://www.youtube.com/img/desktop/yt_1200.png";
          }
          if (channelNameElement) channelNameElement.textContent = "Browsing...";
          if (viewCountElement) viewCountElement.textContent = "";
          if (likeCountElement) likeCountElement.textContent = "";
          if (publishedDateElement) publishedDateElement.textContent = "";
          if (videoCategoryElement) videoCategoryElement.textContent = "";
          const descModal = document.getElementById("descriptionModal");
          if (descModal) {
            const p = descModal.querySelector("p");
            if (p) p.textContent = data.description || "Browsing videos on YouTube";
            descModal.classList.remove("active");
          }
          updateBrowsingElapsed();
          if (!browsingInterval) {
            browsingInterval = setInterval(updateBrowsingElapsed, 1000);
          }
          if (liveIndicatorElement) liveIndicatorElement.classList.remove("active");
          if (pauseIndicatorElement) pauseIndicatorElement.classList.remove("active");
          if (progressBarElement) progressBarElement.style.width = "0%";
          if (youtubeSection) {
            youtubeSection.classList.remove("fade-out");
            youtubeSection.classList.add("fade-in");
          }
          log("Browsing presence updated in UI.");
          const toggleButton = document.getElementById("toggleDescriptionButton");
          if (toggleButton) toggleButton.style.display = "block";
        }
        const socket = io("https://mikumiku.dev");
        socket.on("connect", function () {
          log("Connected to server via Socket.IO.");
          isSessionExpired = false;
          socket.emit("requestLatestData");
        });
        socket.on("disconnect", function () {
          log("Disconnected from server.");
          clearDisplay();
        });
        socket.on("presenceUpdate", function (data) {
          if (isSessionExpired) {
            log("Ignoring presenceUpdate due to expired session.");
            return;
          }
          log("Received presenceUpdate: " + JSON.stringify(data));
          if (data.presenceType === "video") {
            clearInterval(browsingInterval);
            browsingInterval = null;
            browsingStartTime = null;
            localStorage.removeItem("browsingStartTime");
            displayVideoPresence(data);
          } else if (data.presenceType === "browsing") {
            log("Browsing presence update received.");
            displayBrowsingPresence(data);
          } else if (data.presenceType === "offline") {
            log("Offline presence update received.");
            clearDisplay();
          } else {
            clearDisplay();
          }
        });
        setInterval(function () {
          if (!isBuffering && Date.now() - lastHeartbeatReceived > 15000) {
            if (!isOffline) {
              log("No heartbeat received in 15 seconds. Marking as offline.");
              isOffline = true;
              if (offlineIndicatorElement) {
                offlineIndicatorElement.classList.add("visible");
                offlineIndicatorElement.style.display = "block";
              }
            }
            clearDisplay();
          }
        }, 5000);
      });
    </script>
    <!-- Clocks Script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        function updateClocks() {
          const now = new Date();
          const localTime = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
          const localTimeElement = document.getElementById("local-time");
          if (localTimeElement) localTimeElement.textContent = localTime;
          const currentDate = now.toLocaleDateString(undefined, { day: "2-digit", month: "long", year: "numeric" });
          const currentDateElement = document.getElementById("current-date");
          if (currentDateElement) currentDateElement.textContent = currentDate;
          const dayOfWeek = now.toLocaleDateString(undefined, { weekday: "long" });
          const dayOfWeekElement = document.getElementById("day-of-week");
          if (dayOfWeekElement) dayOfWeekElement.textContent = dayOfWeek;
        }
        setInterval(updateClocks, 1000);
        updateClocks();
      });
    </script>
    <!-- Weather Script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        async function fetchWeather() {
          try {
            const response = await fetch("/api/weather?city=" + encodeURIComponent("Leeds"));
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            displayWeather(data);
          } catch (error) {
            console.error("Error fetching weather data:", error);
            const weatherIconElement = document.getElementById("weather-icon");
            if (weatherIconElement) weatherIconElement.style.display = "none";
            const weatherDescription = document.getElementById("weather-description");
            if (weatherDescription) weatherDescription.innerText = "Unable to fetch weather data.";
          }
        }
        function displayWeather(data) {
          const description = data.weather[0].description,
                temperature = Math.round(data.main.temp),
                humidity = data.main.humidity,
                windSpeed = data.wind.speed,
                iconCode = data.weather[0].icon,
                iconUrl = "https://openweathermap.org/img/wn/" + iconCode + "@2x.png";
          document.getElementById("weather-description").innerText = "Condition: " + description;
          document.getElementById("temperature").innerText = "Temperature: " + temperature + "°C";
          document.getElementById("humidity").innerText = "Humidity: " + humidity + "%";
          document.getElementById("wind-speed").innerText = "Wind: " + windSpeed + " m/s";
          const weatherIconElement = document.getElementById("weather-icon");
          if (weatherIconElement) {
            weatherIconElement.src = iconUrl;
            weatherIconElement.style.display = "block";
          }
        }
        setInterval(fetchWeather, 3600000);
        fetchWeather();
      });
    </script>
    <!-- Matrix Script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const canvas = document.getElementById("soundWaveCanvas");
        const ctx = canvas.getContext("2d");
        function resizeCanvas() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener("resize", function () {
          resizeCanvas();
          columns = Math.floor(canvas.width / fontSize);
          drops = new Array(columns).fill(0);
          speeds = Array.from({ length: columns }, () => Math.random() * 0.05 + 0.05);
          phraseCounters = new Array(columns).fill(0);
          currentDigits = new Array(columns).fill("0");
        });
        const fontSize = 20;
        let columns = Math.floor(canvas.width / fontSize);
        let drops = new Array(columns).fill(0);
        let speeds = Array.from({ length: columns }, () => Math.random() * 0.05 + 0.05);
        let phraseCounters = new Array(columns).fill(0);
        let currentDigits = new Array(columns).fill("0");
        const binaryChars = "01";
        const colors = ["#00C6FF", "#ff4081"];
        const mikuPhrases = ["Hatsune Miku", "The First Sound of the Future", "39", "Digital Diva", "CV01", "01"];
        function hexToRGBA(hex, alpha) {
          const r = parseInt(hex.slice(1, 3), 16),
                g = parseInt(hex.slice(3, 5), 16),
                b = parseInt(hex.slice(5, 7), 16);
          return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        function drawMatrix() {
          ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.font = fontSize + "px monospace";
          ctx.shadowColor = "rgba(0, 0, 0, 0.8)";
          ctx.shadowBlur = 4;
          const trailLength = 6;
          for (let i = 0; i < drops.length; i++) {
            let dropIncrement = speeds[i];
            let text;
            if (phraseCounters[i] > 0) {
              dropIncrement = 0;
              phraseCounters[i]--;
            }
            if (phraseCounters[i] === 0 && Math.random() < 0.002) {
              text = mikuPhrases[Math.floor(Math.random() * mikuPhrases.length)];
              ctx.fillStyle = "#FF69B4";
              phraseCounters[i] = 180;
              dropIncrement = speeds[i] * 0.2;
            } else {
              if (Math.random() < 0.1) {
                currentDigits[i] = binaryChars.charAt(Math.floor(Math.random() * binaryChars.length));
              }
              text = currentDigits[i];
              ctx.fillStyle = colors[i % colors.length];
            }
            const x = i * fontSize;
            const y = Math.floor(drops[i]) * fontSize;
            ctx.fillText(text, x, y);
            for (let j = 1; j < trailLength; j++) {
              const ty = y - j * fontSize;
              if (ty < 0) break;
              const alpha = 1 - j / trailLength;
              ctx.fillStyle = hexToRGBA(colors[i % colors.length], alpha);
              ctx.fillText(binaryChars.charAt(Math.floor(Math.random() * binaryChars.length)), x, ty);
            }
            if (y > canvas.height && Math.random() > 0.995) {
              drops[i] = 0;
              speeds[i] = Math.random() * 0.05 + 0.05;
              phraseCounters[i] = 0;
              currentDigits[i] = "0";
            }
            drops[i] += dropIncrement;
          }
          requestAnimationFrame(drawMatrix);
        }
        drawMatrix();
      });
    </script>
  </body>
</html>
