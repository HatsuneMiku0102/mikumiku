<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Miku.dev | Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="stylesheet" href="/styles.css"/>
    <style>
      #soundWaveCanvas{z-index:0}
      .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);opacity:0;visibility:hidden;transition:opacity .2s ease;z-index:4000}
      .backdrop.active{opacity:1;visibility:visible}
      .modal-description{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.98);max-width:640px;width:90%;background:#111;color:#fff;padding:1rem 1.25rem;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.5);z-index:5000;opacity:0;pointer-events:none;transition:opacity .2s ease,transform .2s ease}
      .modal-description.active{opacity:1;transform:translate(-50%,-50%) scale(1);pointer-events:auto}
      body.modal-open{overflow:hidden}
      .modal-description h4{margin:0 0 .5rem 0}
      .transition-layer{position:absolute;inset:0;background:linear-gradient(135deg,rgba(0,198,255,.12),rgba(255,64,129,.12));backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:5}
      .transition-layer.active{opacity:1;pointer-events:auto}
      .youtube-section.entering .video-thumb,.youtube-section.entering .video-details{filter:blur(3px);transform:scale(.98);transition:all .25s ease}
      .video-details .animate-in{opacity:0;transform:translateY(8px);animation:fadeInUp .5s ease forwards}
      .video-details .animate-in.delay-1{animation-delay:.08s}
      .video-details .animate-in.delay-2{animation-delay:.16s}
      .video-details .animate-in.delay-3{animation-delay:.24s}
      .video-details .animate-in.delay-4{animation-delay:.32s}
      .video-thumb .thumb-img{opacity:0;transform:scale(.96);animation:popIn .45s ease forwards}
      @keyframes fadeInUp{to{opacity:1;transform:translateY(0)}}
      @keyframes popIn{to{opacity:1;transform:scale(1)}}
      .skeleton{position:relative;overflow:hidden;background:rgba(255,255,255,.08);border-radius:8px}
      .skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);animation:shimmer 1.1s infinite}
      @keyframes shimmer{100%{transform:translateX(100%)}}
      .skeleton.title{height:20px;width:70%}
      .skeleton.line{height:12px;width:50%}
      .progress-bar{position:relative;overflow:hidden}
      .progress-bar #progressBar{transition:width .25s ease}
      .history-wrap{margin-top:12px}
      .history-header{display:flex;align-items:center;justify-content:space-between;gap:.5rem;font-weight:700;opacity:.9}
      .history-actions{display:flex;align-items:center;gap:.5rem}
      .history-more{display:inline-flex;align-items:center;gap:.4rem;border:none;background:linear-gradient(135deg,#00c6ff,#33d6ff);color:#001521;border-radius:999px;padding:.5rem .9rem;font-size:.85rem;font-weight:800;cursor:pointer;box-shadow:0 10px 24px rgba(0,198,255,.45)}
      .history-more:disabled{opacity:.5;cursor:not-allowed}
      .history-scroller{margin-top:8px;display:flex;justify-content:center;gap:10px;overflow:hidden;padding-bottom:6px}
      .hist-item{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px;cursor:pointer;transition:transform .15s ease,background .15s ease;border-color:rgba(255,255,255,.18)}
      .hist-item:hover{transform:translateY(-2px);background:rgba(255,255,255,.1)}
      .hist-thumb{width:150px;aspect-ratio:16/9;object-fit:cover;border-radius:8px}
      .hist-title{font-size:.8rem;line-height:1.2;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;font-weight:800}
      .hist-meta{font-size:.7rem;opacity:.7}
      .history-modal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:.5rem;max-height:60vh;overflow:auto}
      .history-modal-close{position:absolute;top:8px;right:10px;border:none;background:transparent;color:#fff;font-size:1.2rem;cursor:pointer}
    </style>
  </head>
  <body>
    <canvas id="soundWaveCanvas" aria-hidden="true"></canvas>
    <div class="page-container" id="pageContainer">
      <header class="title-bar" id="titleBar">
        <div class="container">
          <div class="left-section"></div>
          <div class="title-wrapper">
            <a href="/" aria-label="Home" class="logo-link">
              <span class="site-title">Miku.dev</span>
              <div class="visualizer-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 100" class="visualizer">
                  <g>
                    <rect x="10" y="70" width="15" height="30" fill="#00c6ff">
                      <animate attributeName="height" values="30;60;30" dur="0.8s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="70;40;70" dur="0.8s" repeatCount="indefinite"/>
                    </rect>
                    <rect x="35" y="60" width="15" height="40" fill="#ff4081">
                      <animate attributeName="height" values="40;80;40" dur="1s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="60;20;60" dur="1s" repeatCount="indefinite"/>
                    </rect>
                    <rect x="60" y="80" width="15" height="20" fill="#00c6ff">
                      <animate attributeName="height" values="20;50;20" dur="0.6s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="80;50;80" dur="0.6s" repeatCount="indefinite"/>
                    </rect>
                    <rect x="85" y="50" width="15" height="50" fill="#ff4081">
                      <animate attributeName="height" values="50;90;50" dur="1.2s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="50;10;50" dur="1.2s" repeatCount="indefinite"/>
                    </rect>
                    <rect x="110" y="70" width="15" height="30" fill="#00c6ff">
                      <animate attributeName="height" values="30;60;30" dur="0.9s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="70;40;70" dur="0.9s" repeatCount="indefinite"/>
                    </rect>
                    <rect x="135" y="60" width="15" height="40" fill="#ff4081">
                      <animate attributeName="height" values="40;80;40" dur="1.1s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="60;20;60" dur="1.1s" repeatCount="indefinite"/>
                    </rect>
                  </g>
                </svg>
              </div>
            </a>
          </div>
          <div class="right-section">
            <button class="menu-button" id="menuButton" aria-label="Open Menu">
              <i class="fas fa-music"></i>
            </button>
          </div>
        </div>
      </header>
      <nav class="overlay-menu" id="overlayMenu">
        <button class="close-overlay" id="closeOverlay" aria-label="Close Menu">
          <i class="fas fa-times"></i>
        </button>
        <div class="overlay-content">
          <a href="/auth" aria-label="Admin Login"><i class="fas fa-user-lock"></i> Admin Login</a>
          <a href="#aboutMe" aria-label="About Me"><i class="fas fa-info-circle"></i> About Me</a>
          <div class="personality-options">
            <button id="personalityOption1" class="personality-button"><i class="fas fa-music"></i> Melody</button>
            <button id="personalityOption2" class="personality-button"><i class="fas fa-headphones"></i> Harmony</button>
            <button id="personalityOption3" class="personality-button"><i class="fas fa-microphone"></i> Rhythm</button>
          </div>
        </div>
      </nav>
      <section class="now-playing-container">
        <div class="now-playing-card" id="nowPlayingCard">
          <div class="now-playing-grid">
            <div class="video-info">
              <div class="info-item"><i class="fas fa-tv"></i><span id="channelName">Loading…</span></div>
              <div class="info-item"><i class="fas fa-eye"></i><span id="viewCount">Loading…</span></div>
              <div class="info-item"><i class="fas fa-thumbs-up"></i><span id="likeCount">Loading…</span></div>
              <div class="info-item"><i class="fas fa-calendar-day"></i><span id="publishedDate">Loading…</span></div>
              <div class="info-item"><i class="fas fa-tag"></i><span id="videoCategory">Loading…</span></div>
            </div>
            <div class="time-info">
              <div class="greeting-container">
                <p class="greeting"><i class="fas fa-sun"></i> <span id="greeting-text">Good Morning!</span></p>
              </div>
              <div class="clock-container">
                <div class="digital-clock">
                  <p id="local-time"><i class="fas fa-clock"></i> 00:00:00</p>
                  <p id="current-date"><i class="fas fa-calendar-alt"></i> 1 January 2025</p>
                  <p id="day-of-week"><i class="fas fa-calendar-day"></i> Wednesday</p>
                  <p id="time-zone"><i class="fas fa-globe"></i> UTC</p>
                </div>
              </div>
            </div>
            <div class="youtube-section" id="youtubeSection" style="position: relative;">
              <div class="transition-layer" id="ytTransition"></div>
              <div class="video-thumb">
                <img id="videoThumbnailImage" class="thumb-img" src="" alt="Thumbnail" loading="lazy"/>
                <div id="thumbSkeleton" class="skeleton" style="position:absolute;inset:0;display:none;"></div>
              </div>
              <div class="video-details">
                <h3 class="animate-in">Currently Playing</h3>
                <p id="videoTitle" class="animate-in delay-1">Loading…</p>
                <div class="progress-bar animate-in delay-2"><div id="progressBar"></div></div>
                <div class="animate-in delay-3">
                  <button id="toggleDescriptionButton"><i class="fas fa-info-circle"></i> Show Description</button>
                </div>
                <div id="backdrop" class="backdrop" aria-hidden="true"></div>
                <div id="descriptionModal" class="modal-description" role="dialog" aria-modal="true" aria-labelledby="descriptionModalTitle" aria-describedby="descriptionModalDescription">
                  <h4 id="descriptionModalTitle">Description</h4>
                  <p id="descriptionModalDescription">Loading description…</p>
                </div>
                <div id="titleSkeleton" class="skeleton title" style="margin-top:.5rem;display:none;"></div>
                <div id="lineSkeleton" class="skeleton line" style="margin-top:.5rem;display:none;"></div>
              </div>
              <div class="status-boxes">
                <div id="liveIndicator" class="status-box live">Live</div>
                <div id="pauseIndicator" class="status-box paused">Paused</div>
              </div>
            </div>
            <aside class="weather-info" style="grid-area: weatherSection;">
              <img id="weather-icon" src="" alt="Weather Icon" loading="lazy"/>
              <p id="weather-description">Loading…</p>
              <p id="temperature">--°C</p>
              <p id="humidity">Humidity: --%</p>
              <p id="wind-speed">Wind: -- m/s</p>
            </aside>
            <div class="history-wrap">
              <div class="history-header">
                <div><i class="fas fa-clock"></i> Recent</div>
                <div class="history-actions">
                  <button id="historyMoreBtn" class="history-more"><i class="fas fa-list"></i> More</button>
                </div>
              </div>
              <div id="historyScroller" class="history-scroller"></div>
            </div>
          </div>
          <div id="offline-indicator" class="offline-indicator"><i class="fas fa-signal-slash"></i> Offline</div>
        </div>
      </section>
      <footer class="footer">
        <div class="container">
          <p>&copy; 2024 MikuMiku. All rights reserved.</p>
          <button id="manageConsentFooter" class="manage-consent-button"><i class="fas fa-cookie-bite"></i> Manage Cookie Preferences</button>
        </div>
      </footer>
      <div id="consentModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="consentModalTitle" aria-describedby="consentModalDescription">
        <div class="modal-content">
          <button class="close-button" id="closeConsentModal" aria-label="Close Consent Modal"><i class="fas fa-times"></i></button>
          <h2 id="consentModalTitle"><i class="fas a-cookie"></i> Cookie Consent</h2>
          <p id="consentModalDescription">I use cookies stored in your browser to enhance your experience on my personal website. These cookies are essential for the website's functionality. By clicking "Accept," you consent to their use. You can also manage your cookie preferences in the "Manage Cookie Preferences" section.</p>
          <div class="consent-buttons">
            <button id="acceptConsent" class="consent-button"><i class="fas fa-check"></i> Accept</button>
            <button id="declineConsent" class="consent-button"><i class="fas fa-times"></i> Decline</button>
          </div>
        </div>
      </div>

      <div id="historyBackdrop" class="backdrop" aria-hidden="true"></div>
      <div id="historyModal" class="modal-description" role="dialog" aria-modal="true" aria-labelledby="historyModalTitle">
        <button id="closeHistoryModal" class="history-modal-close" aria-label="Close"><i class="fas fa-times"></i></button>
        <h4 id="historyModalTitle">More Recently Played</h4>
        <div id="historyModalGrid" class="history-modal-grid"></div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.1/socket.io.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="haru.js"></script>
    <script src="clockwork.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("pageContainer");e&&e.classList.add("loaded");const t=document.getElementById("titleBar");t&&window.addEventListener("scroll",function(){t.classList.toggle("scrolled",window.scrollY>50)});const n=document.getElementById("menuButton"),o=document.getElementById("overlayMenu"),a=document.getElementById("closeOverlay");n&&o&&n.addEventListener("click",function(e){e.stopPropagation(),o.classList.add("active"),document.body.classList.add("overlay-active")}),a&&o&&a.addEventListener("click",function(e){e.stopPropagation(),o.classList.remove("active"),document.body.classList.remove("overlay-active")}),window.addEventListener("click",function(e){e.target===o&&(o.classList.remove("active"),document.body.classList.remove("overlay-active"))});const i=document.querySelectorAll(".personality-button"),d=document.querySelector(".site-title");i.length&&d&&i.forEach(e=>{e.addEventListener("click",function(){const t=e.textContent.trim();"Melody"===t?d.style.color="#ff4081":"Harmony"===t?d.style.color="#00c6ff":"Rhythm"===t?d.style.color="#ffffff":d.style.color="#00c6ff",i.forEach(e=>e.classList.remove("active")),e.classList.add("active")})})});
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function(){
      const key = "lastVisitTimestamp"
      const now = Date.now()
      const lastVisit = localStorage.getItem(key)
      
      let message
      if (lastVisit) {
        const diffMs = now - parseInt(lastVisit, 10)
        const diffSec = Math.floor(diffMs / 1000)
        const diffMin = Math.floor(diffSec / 60)
        const diffHr = Math.floor(diffMin / 60)
        const diffDay = Math.floor(diffHr / 24)
    
        if (diffDay > 0) {
          message = `Last visited ${diffDay} day${diffDay>1?'s':''} ago`
        } else if (diffHr > 0) {
          message = `Last visited ${diffHr} hour${diffHr>1?'s':''} ago`
        } else if (diffMin > 0) {
          message = `Last visited ${diffMin} minute${diffMin>1?'s':''} ago`
        } else {
          message = `Last visited just now`
        }
      } else {
        message = "This is your first visit!"
      }
    
      localStorage.setItem(key, now.toString())
    
      const footerContainer = document.querySelector(".footer .container")
      if (footerContainer) {
        const span = document.createElement("span")
        span.style.display = "block"
        span.style.marginTop = "4px"
        span.style.opacity = "0.8"
        span.textContent = message
        footerContainer.appendChild(span)
      }
    })
    </script>


    <script>
    (function(){
      const cfg={name:"cookieConsent",days:365,path:"/",modalId:"consentModal",acceptId:"acceptConsent",declineId:"declineConsent",manageIds:["manageConsentFooter"],closeId:"closeConsentModal"}
      const modal=document.getElementById(cfg.modalId)
      const btnAccept=document.getElementById(cfg.acceptId)
      const btnDecline=document.getElementById(cfg.declineId)
      const btnClose=document.getElementById(cfg.closeId)
      const manageBtns=cfg.manageIds.map(id=>document.getElementById(id)).filter(Boolean)
      function setCookie(name,value,days,path){let exp="";if(typeof days==="number"&&isFinite(days)){const d=new Date();d.setTime(d.getTime()+days*24*60*60*1000);exp="; expires="+d.toUTCString()}const sec=location.protocol==="https:"?"; Secure":"";document.cookie=name+"="+encodeURIComponent(value)+exp+"; path="+(path||"/")+"; SameSite=Lax"+sec}
      function getCookie(name){const n=name+"=";const arr=document.cookie.split(";");for(let i=0;i<arr.length;i++){let c=arr[i].trim();if(c.indexOf(n)===0)return decodeURIComponent(c.substring(n.length))}return null}
      function openModal(){if(!modal)return;modal.classList.add("active");document.body.classList.add("modal-active");modal.setAttribute("aria-hidden","false")}
      function closeModal(){if(!modal)return;modal.classList.remove("active");document.body.classList.remove("modal-active");modal.setAttribute("aria-hidden","true")}
      function init(){const existing=getCookie(cfg.name);if(!existing){openModal()}manageBtns.forEach(b=>b.addEventListener("click",e=>{e.preventDefault();openModal()}))
        if(btnAccept)btnAccept.addEventListener("click",function(){setCookie(cfg.name,JSON.stringify({necessary:true}),cfg.days,cfg.path);closeModal()})
        if(btnDecline)btnDecline.addEventListener("click",function(){setCookie(cfg.name,JSON.stringify({necessary:false}),cfg.days,cfg.path);closeModal()})
        if(btnClose)btnClose.addEventListener("click",function(){closeModal()})
        window.addEventListener("click",function(e){if(e.target===modal)closeModal()})
        document.addEventListener("keydown",function(e){if(e.key==="Escape"&&modal.classList.contains("active"))closeModal()})
      }
      document.addEventListener("DOMContentLoaded",init)
    })();
    </script>


    <script>
      document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("currentVideoTitle"),t=localStorage.getItem("currentVideoThumbnail");if(e){const t=document.getElementById("videoTitle");t&&(t.textContent=e)}if(t){const e=document.getElementById("videoThumbnailImage");e&&(e.src=t,e.style.display="block")}const n=localStorage.getItem("currentVideoChannel"),o=localStorage.getItem("currentVideoViews"),a=localStorage.getItem("currentVideoLikes"),i=localStorage.getItem("currentVideoPublished"),d=localStorage.getItem("currentVideoCategory"),l=localStorage.getItem("currentVideoDescription"),c=document.getElementById("channelName"),s=document.getElementById("viewCount"),r=document.getElementById("likeCount"),m=document.getElementById("publishedDate"),g=document.getElementById("videoCategory"),f=document.getElementById("descriptionModalDescription");c&&n&&(c.textContent=n),s&&o&&(s.textContent=o),r&&a&&(r.textContent=a),m&&i&&(m.textContent=i),g&&d&&(g.textContent=d),f&&l&&(f.textContent=l)});
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("toggleDescriptionButton"),t=document.getElementById("descriptionModal"),n=document.getElementById("backdrop");function o(){t.classList.add("active"),n.classList.add("active"),document.body.classList.add("modal-open"),localStorage.setItem("descriptionModalOpen","true")}function a(){t.classList.remove("active"),n.classList.remove("active"),document.body.classList.remove("modal-open"),localStorage.setItem("descriptionModalOpen","false")}localStorage.getItem("descriptionModalOpen")==="true"?o():a(),e.addEventListener("click",function(){t.classList.contains("active")?a():o()}),n.addEventListener("click",a),document.addEventListener("keydown",function(e){if(e.key==="Escape"&&t.classList.contains("active"))a()})});
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){function e(){const e=new Date,t=e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),n=document.getElementById("local-time");n&&(n.textContent=t);const o=e.toLocaleDateString(void 0,{day:"2-digit",month:"long",year:"numeric"}),a=document.getElementById("current-date");a&&(a.textContent=o);const i=e.toLocaleDateString(void 0,{weekday:"long"}),d=document.getElementById("day-of-week");d&&(d.textContent=i)}setInterval(e,1e3),e()});
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){async function e(){try{const e=await fetch("/api/weather?city="+encodeURIComponent("Leeds")),t=await e.json();if(t.error)throw new Error(t.error);n(t)}catch(e){const t=document.getElementById("weather-icon");t&&(t.style.display="none");const n=document.getElementById("weather-description");n&&(n.innerText="Unable to fetch weather data.")}}function n(e){const n=e.weather[0].description,o=Math.round(e.main.temp),a=e.main.humidity,i=e.wind.speed,d=e.weather[0].icon,l="https://openweathermap.org/img/wn/"+d+"@2x.png";document.getElementById("weather-description").innerText="Condition: "+n,document.getElementById("temperature").innerText="Temperature: "+o+"°C",document.getElementById("humidity").innerText="Humidity: "+a+"%",document.getElementById("wind-speed").innerText="Wind: "+i+" m/s";const c=document.getElementById("weather-icon");c&&(c.src=l,c.style.display="block")}setInterval(e,3600000),e()});
    </script>

    <script>
    document.addEventListener("DOMContentLoaded",function(){
    const e=document.getElementById("nowPlayingCard"),t=document.getElementById("youtubeSection"),n=document.getElementById("offline-indicator"),o=document.getElementById("videoTitle"),a=document.getElementById("videoThumbnailImage"),i=document.getElementById("thumbSkeleton"),d=document.getElementById("titleSkeleton"),l=document.getElementById("lineSkeleton"),c=document.getElementById("channelName"),s=document.getElementById("viewCount"),r=document.getElementById("likeCount"),m=document.getElementById("publishedDate"),g=document.getElementById("videoCategory"),f=document.getElementById("progressBar"),v=document.getElementById("liveIndicator"),h=document.getElementById("pauseIndicator"),p=document.getElementById("descriptionModalDescription"),y=document.getElementById("toggleDescriptionButton"),u=document.getElementById("ytTransition"),S=document.getElementById("historyScroller"),E=document.getElementById("historyMoreBtn"),Y=document.getElementById("historyBackdrop"),K=document.getElementById("historyModal"),Z=document.getElementById("historyModalGrid"),X=document.getElementById("closeHistoryModal");
    let w=null;let T=null;let A=null;let offlineTimer=null;const OFFLINE_DELAY=2000;
    function C(e){return e==null?null:Number(e)}
    function L(e){return e===true||e==="true"||e===1||e==="1"}
    function N(e){if(!f)return;const t=L(e.isLive);if(t){f.style.width="100%";return}const n=C(e.duration),o=C(e.currentTime),a=C(e.percent);if(typeof n==="number"&&n>0&&typeof o==="number"&&o>=0){const e=Math.max(0,Math.min(100,(o/n)*100));f.style.width=e+"%";T=e}else if(typeof a==="number"&&!isNaN(a)){const e=Math.max(0,Math.min(100,a));f.style.width=e+"%";T=e}else if(T==null){f.style.width="0%"}}
    function O(e){const t=L(e.isLive),n=L(e.isPaused);v&&v.classList.toggle("active",t),h&&h.classList.toggle("active",n)}
    function D(){n&&n.classList.remove("visible"),e&&e.classList.remove("offline"),t&&(t.style.display="block")}
    function R(e){w=e.videoId||null,o&&(o.textContent=e.title||""),c&&(c.textContent=e.channelTitle||""),s&&(s.textContent=P(e.viewCount)),r&&(r.textContent=P(e.likeCount)),m&&(m.textContent=e.publishedAt?new Date(e.publishedAt).toLocaleDateString():m.textContent),g&&(g.textContent=e.category||""),p&&(p.textContent=e.description||""),a&&(e.thumbnail?(a.removeAttribute("loading"),a.src=e.thumbnail,a.style.display="block"):a.style.display=""),D(),N(e),O(e),y&&(y.style.display="block"),localStorage.setItem("currentVideoTitle",o?o.textContent:""),localStorage.setItem("currentVideoThumbnail",a&&a.src?a.src:""),localStorage.setItem("currentVideoChannel",c?c.textContent:""),localStorage.setItem("currentVideoViews",s?s.textContent:""),localStorage.setItem("currentVideoLikes",r?r.textContent:""),localStorage.setItem("currentVideoPublished",m?m.textContent:""),localStorage.setItem("currentVideoCategory",g?g.textContent:""),localStorage.setItem("currentVideoDescription",p?p.textContent:""),a.classList.remove("thumb-img"),void a.offsetWidth,a.classList.add("thumb-img");const q=document.querySelectorAll(".video-details .animate-in");q.forEach(x=>{x.style.opacity="0";x.style.transform="translateY(8px)";void x.offsetWidth;x.classList.add("animate-in")});I(e)}
    function P(e){if(typeof e==="string")e=e.replace(/,/g,"");const t=Number(e);return isNaN(t)?"N/A":t.toLocaleString()}
    function M(){n&&n.classList.add("visible"),e&&e.classList.add("offline")}
    function scheduleOffline(){clearTimeout(offlineTimer);offlineTimer=setTimeout(()=>{M()},OFFLINE_DELAY)}
    function cancelOffline(){clearTimeout(offlineTimer);offlineTimer=null;D()}
    function H(e){t.classList.add("entering");u.classList.add("active");i.style.display="block";d.style.display="block";l.style.display="block";const n=new Image;const s=new Promise(r=>{n.onload=()=>r(true);n.onerror=()=>r(false);if(e.thumbnail)n.src=e.thumbnail});const o=new Promise(r=>setTimeout(()=>r(false),800));Promise.race([s,o]).then(()=>{R(e);setTimeout(()=>{u.classList.remove("active");t.classList.remove("entering");i.style.display="none";d.style.display="none";l.style.display="none"},180)})}
    function B(){const e=localStorage.getItem("npHistory");try{return e?JSON.parse(e):[]}catch{return[]}}
    function I(e){const t=B().filter(x=>x.videoId!==e.videoId);t.unshift({videoId:e.videoId||"",title:e.title||"",thumbnail:e.thumbnail||"",channelTitle:e.channelTitle||"",publishedAt:e.publishedAt||"",category:e.category||""});const n=t.slice(0,20);localStorage.setItem("npHistory",JSON.stringify(n));W(n)}
    function U(e){const t=document.createElement("div");t.className="hist-item";t.dataset.videoId=e.videoId;const n=document.createElement("img");n.className="hist-thumb";n.src=e.thumbnail||"";const o=document.createElement("div");o.className="hist-title";o.textContent=e.title||"";const a=document.createElement("div");a.className="hist-meta";a.textContent=e.channelTitle||"";t.appendChild(n);t.appendChild(o);t.appendChild(a);t.addEventListener("click",function(){n&&n.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"});const d={videoId:e.videoId,title:e.title,thumbnail:e.thumbnail,channelTitle:e.channelTitle,viewCount:s?s.textContent:"",likeCount:r?r.textContent:"",publishedAt:e.publishedAt,category:e.category,description:p?p.textContent:"",duration:0,currentTime:0,isLive:false,isPaused:true};R(d);G(false)});return t}
    function W(e){S.innerHTML="";const t=e.slice(0,3);t.forEach(n=>S.appendChild(U(n)));E.disabled=e.length<=3;Z.innerHTML="";const n=e.slice(3);n.forEach(o=>Z.appendChild(U(o)))}
    function F(){W(B())}
    function G(e=true){if(e){Y.classList.add("active");K.classList.add("active");document.body.classList.add("modal-open")}else{Y.classList.remove("active");K.classList.remove("active");document.body.classList.remove("modal-open")}}
    async function J(){if(!w)return;const e=v&&v.classList.contains("active");if(!e)return;try{const t=await fetch("/api/youtube/stats?videoId="+encodeURIComponent(w));if(!t.ok)return;const n=await t.json();if(typeof n.viewCount!=="undefined"&&s)s.textContent=P(n.viewCount);if(typeof n.likeCount!=="undefined"&&r)r.textContent=P(n.likeCount)}catch{}}
    function Q(){if(A){clearInterval(A);A=null}const e=v&&v.classList.contains("active");if(e){A=setInterval(J,10000)}}
    const z=io();
    z.on("connect",function(){cancelOffline()})
    z.on("disconnect",function(){scheduleOffline()})
    z.on("presenceUpdate",function(e){
    if(e.presenceType==="offline"){scheduleOffline();return}
    cancelOffline()
    if(e.presenceType==="video"){e.videoId===w?(N(e),O(e)):(H(e),Q())}
    else if(e.presenceType==="browsing"){o&&(o.textContent=e.title||o.textContent);a&&(e.thumbnail?(a.src=e.thumbnail,a.style.display="block"):a.style.display="");O({isLive:false,isPaused:false})}
    })
    setTimeout(function(){if(!o||!o.textContent||o.textContent==="Loading…"){const e=localStorage.getItem("currentVideoTitle");if(e&&o)o.textContent=e}},0);
    F();
    E.addEventListener("click",function(){G(true)});
    Y.addEventListener("click",function(){G(false)});
    X.addEventListener("click",function(){G(false)});
    document.addEventListener("keydown",function(e){if(e.key==="Escape"&&K.classList.contains("active"))G(false)});
    setInterval(Q,5000)
    });
    </script>


    <script>
      document.addEventListener("DOMContentLoaded",function(){const canvas=document.getElementById("soundWaveCanvas");if(!canvas)return;const ctx=canvas.getContext("2d");const cell=20;const glyphs=["0","1"];const words=["Hatsune Miku","Digital Diva","CV01","39"];let cols=0;let y=[],speed=[],hold=[],last=[];function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;cols=Math.floor(canvas.width/cell);y=new Array(cols).fill(0);speed=Array.from({length:cols},()=>Math.random()*0.5+0.5);hold=new Array(cols).fill(0);last=new Array(cols).fill("0")}function rgba(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgba(${r}, ${g}, ${b}, ${a})`}resize();window.addEventListener("resize",resize);const palette=["#00C6FF","#FF4081"];function draw(){ctx.fillStyle="rgba(0,0,0,0.05)";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.font=`${cell}px monospace`;ctx.shadowColor="rgba(0,0,0,0.8)";ctx.shadowBlur=4;const trail=6;for(let c=0;c<cols;c++){let ch;if(hold[c]>0){ch=last[c];hold[c]--}else if(Math.random()<0.02){ch=words[Math.floor(Math.random()*words.length)];hold[c]=Math.max(2,Math.ceil(ch.length*3));last[c]=ch}else{ch=glyphs[Math.floor(Math.random()*glyphs.length)];last[c]=ch}const x=c*cell;const py=Math.floor(y[c])*cell;ctx.fillStyle=palette[c%palette.length];ctx.fillText(ch,x,py);for(let t=1;t<=trail;t++){const ty=py-t*cell;if(ty<0)break;const fade=1-t/(trail+1);ctx.fillStyle=rgba(palette[c%palette.length],fade*0.9);ctx.fillText(glyphs[Math.floor(Math.random()*glyphs.length)],x,ty)}if(py>canvas.height&&Math.random()>0.975){y[c]=0;speed[c]=Math.random()*0.1+0.1;hold[c]=0;last[c]="0"}y[c]+=speed[c]}requestAnimationFrame(draw)}requestAnimationFrame(draw)});
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){function send(){fetch("/track-visitor",{method:"POST",keepalive:true}).catch(()=>{})}send();document.addEventListener("visibilitychange",function(){if(document.visibilityState==="hidden"){navigator.sendBeacon&&navigator.sendBeacon("/track-visitor")}})});
    </script>
  </body>
</html>



