<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Miku.dev | Home</title>
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- External CSS -->
    <link rel="stylesheet" href="/styles.css" />
    <!-- Mapbox GL JS CSS -->
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      /* Temporary inline style for description modal toggling */
      #descriptionModal {
        display: none;
      }
      #descriptionModal.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <!-- Load external libraries first -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.1/socket.io.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    
    <!-- Canvas for sound waves -->
    <canvas id="soundWaveCanvas" aria-hidden="true"></canvas>
    
    <!-- Page Container -->
    <div class="page-container" id="pageContainer">
      <!-- Header -->
      <header class="title-bar" id="titleBar">
        <div class="container">
          <div class="left-section"></div>
          <div class="title-wrapper">
            <a href="/" aria-label="Home" class="logo-link">
              <span class="site-title">Miku.dev</span>
              <div class="visualizer-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 100" class="visualizer">
                  <g>
                    <rect x="10" y="70" width="15" height="30" fill="#00c6ff">
                      <animate attributeName="height" values="30;60;30" dur="0.8s" repeatCount="indefinite" />
                      <animate attributeName="y" values="70;40;70" dur="0.8s" repeatCount="indefinite" />
                    </rect>
                    <rect x="35" y="60" width="15" height="40" fill="#ff4081">
                      <animate attributeName="height" values="40;80;40" dur="1s" repeatCount="indefinite" />
                      <animate attributeName="y" values="60;20;60" dur="1s" repeatCount="indefinite" />
                    </rect>
                    <rect x="60" y="80" width="15" height="20" fill="#00c6ff">
                      <animate attributeName="height" values="20;50;20" dur="0.6s" repeatCount="indefinite" />
                      <animate attributeName="y" values="80;50;80" dur="0.6s" repeatCount="indefinite" />
                    </rect>
                    <rect x="85" y="50" width="15" height="50" fill="#ff4081">
                      <animate attributeName="height" values="50;90;50" dur="1.2s" repeatCount="indefinite" />
                      <animate attributeName="y" values="50;10;50" dur="1.2s" repeatCount="indefinite" />
                    </rect>
                    <rect x="110" y="70" width="15" height="30" fill="#00c6ff">
                      <animate attributeName="height" values="30;60;30" dur="0.9s" repeatCount="indefinite" />
                      <animate attributeName="y" values="70;40;70" dur="0.9s" repeatCount="indefinite" />
                    </rect>
                    <rect x="135" y="60" width="15" height="40" fill="#ff4081">
                      <animate attributeName="height" values="40;80;40" dur="1.1s" repeatCount="indefinite" />
                      <animate attributeName="y" values="60;20;60" dur="1.1s" repeatCount="indefinite" />
                    </rect>
                  </g>
                </svg>
              </div>
            </a>
          </div>
          <div class="right-section">
            <button class="menu-button" id="menuButton" aria-label="Open Menu">
              <i class="fas fa-music"></i>
            </button>
          </div>
        </div>
      </header>
      
      <!-- Overlay Menu -->
      <nav class="overlay-menu" id="overlayMenu">
        <button class="close-overlay" id="closeOverlay" aria-label="Close Menu">
          <i class="fas fa-times"></i>
        </button>
        <div class="overlay-content">
          <a href="/auth" aria-label="Admin Login">
            <i class="fas fa-user-lock"></i> Admin Login
          </a>
          <a href="#aboutMe" aria-label="About Me">
            <i class="fas fa-info-circle"></i> About Me
          </a>
          <div class="personality-options">
            <button id="personalityOption1" class="personality-button">
              <i class="fas fa-music"></i> Melody
            </button>
            <button id="personalityOption2" class="personality-button">
              <i class="fas fa-headphones"></i> Harmony
            </button>
            <button id="personalityOption3" class="personality-button">
              <i class="fas fa-microphone"></i> Rhythm
            </button>
          </div>
        </div>
      </nav>
      
      <!-- Now Playing Container -->
      <section class="now-playing-container">
        <div id="nowPlayingBox" class="now-playing">
          <aside class="now-playing-sidebar">
            <div class="sidebar-item">
              <i class="fas fa-tv"></i> <span id="channelName">Loading...</span>
            </div>
            <div class="sidebar-item">
              <i class="fas fa-eye"></i> <span id="viewCount">Loading...</span>
            </div>
            <div class="sidebar-item">
              <i class="fas fa-thumbs-up"></i> <span id="likeCount">Loading...</span>
            </div>
            <div class="sidebar-item">
              <i class="fas fa-calendar-day"></i> <span id="publishedDate">Loading...</span>
            </div>
            <div class="sidebar-item video-category">
              <i class="fas fa-tag"></i> <span id="videoCategory">Loading...</span>
            </div>
            <hr class="animated-divider" />
            <section class="clock-section">
              <p id="greeting" class="greeting">
                <i class="fas fa-sun"></i>
                <span id="greeting-text">Good Morning!</span>
              </p>
              <div class="clocks-container">
                <div class="digital-clock">
                  <p id="local-time">
                    <i class="fas fa-clock"></i> 00:03:56
                  </p>
                  <p id="current-date">
                    <i class="fas fa-calendar-alt"></i> 14 October 2024
                  </p>
                  <p id="day-of-week">
                    <i class="fas fa-calendar-day"></i> Monday
                  </p>
                  <p id="time-zone">
                    <i class="fas fa-globe"></i> UTC
                  </p>
                </div>
              </div>
              <p id="last-visit-message" class="last-visit-message">
                <i class="fas fa-history"></i> Welcome back!
              </p>
            </section>
          </aside>
          <div class="video-section">
            <div id="videoInfoContainer" class="video-info-container">
              <div class="video-title-container">
                <h2>Currently Playing</h2>
                <p id="videoTitle">Loading...</p>
              </div>
              <div class="thumbnail-container">
                <video
                  id="videoThumbnail"
                  class="video-thumbnail"
                  preload="metadata"
                  controls
                  aria-label="Currently Playing Video"
                >
                  Your browser does not support the video tag.
                </video>
                <img
                  id="videoThumbnailImage"
                  src=""
                  alt="Thumbnail"
                  class="video-thumbnail"
                  loading="lazy"
                />
              </div>
            </div>
            <div id="offline-indicator" class="offline-indicator">
              <i class="fas fa-signal-slash"></i> I’m currently offline
            </div>
            <!-- New Progress Bar & Indicator Area -->
            <div class="progress-container">
              <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
              </div>
              <div class="indicator-container">
                <span id="liveIndicator" class="indicator live">Live</span>
                <span id="pauseIndicator" class="indicator paused">Paused</span>
              </div>
            </div>
            <div class="description-and-time">
              <button class="toggle-description" id="toggleDescriptionButton" aria-label="Toggle Description">
                <i class="fas fa-info-circle"></i> Show Description
              </button>
              <div id="descriptionModal">
                <h2 id="descriptionModalTitle">Description</h2>
                <p id="descriptionModalDescription">Loading description...</p>
              </div>
              <!-- Centered time elapsed display (only shown when browsing presence) -->
              <div id="timeElapsedContainer" class="time-elapsed">
                <i class="fas fa-clock"></i> <span id="timeElapsed">0s</span>
              </div>
            </div>
          </div>
          <hr class="animated-divider" />
          <!-- Sidebar Extra: Weather and Map -->
          <div class="sidebar-extra">
            <aside class="weather-section">
              <img
                id="weather-icon"
                src=""
                alt="Weather Icon"
                class="weather-icon"
                loading="lazy"
              />
              <p id="weather-description" class="weather-description">
                <i class="fas fa-cloud-sun"></i> Loading...
              </p>
              <p id="temperature" class="temperature">
                <i class="fas fa-temperature-high"></i> --°C
              </p>
              <p id="humidity" class="humidity">
                <i class="fas fa-tint"></i> Humidity: --%
              </p>
              <p id="wind-speed" class="wind-speed">
                <i class="fas fa-wind"></i> Wind: -- m/s
              </p>
            </aside>
            <aside class="map-section">
              <h3>Visitor Map</h3>
              <!-- Square map container; width is 100% to allow responsiveness -->
              <div id="map" style="height: 300px; width: 300px; border-radius: var(--border-radius);"></div>
            </aside>
          </div>
        </div>
      </section>
      <section class="content-wrapper">
        <div class="now-playing-about-wrapper">
          <div class="about" id="aboutMe">
            <h2>About Me</h2>
            <p>
              Hey there, I'm Hystoriya, a 24-year-old developer. This is my personal website that I made for no apparent reason. If you find yourself here randomly, then hi :)
            </p>
          </div>
        </div>
      </section>
      <footer class="footer">
        <div class="container">
          <p>&copy; 2024 MikuMiku. All rights reserved.</p>
          <button id="manageConsentFooter" class="manage-consent-button">
            <i class="fas fa-cookie-bite"></i> Manage Cookie Preferences
          </button>
        </div>
      </footer>
      <div id="chat-box" class="chat-box closed" role="dialog" aria-labelledby="chatHeader" aria-modal="true">
        <div class="chat-header">
          <div class="chat-logo">
            <svg width="32" height="32" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 10 H90 V70 H70 L50 90 L30 70 H10 Z" fill="#ffffff" stroke="#007BFF" stroke-width="5" />
            </svg>
          </div>
          <h3 id="chatHeader">Haru AI</h3>
          <button id="close-chat" class="close-chat" aria-label="Close Chat">
            <svg width="24" height="24" viewBox="0 0 20 20" fill="#ffffff" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 8.586L3.536 2.122 2.122 3.536 8.586 10l-6.464 6.464 1.414 1.414L18.344 17.656C19.792 16.208 20.688 14.21 20.688 12c0-5.514-4.486-10-10-10zm0 14l-3-3H5v-2h4v2zm0-4H5v-2h4v2zm6-4h-8v2h8V8z" />
            </svg>
          </button>
        </div>
        <div id="chat-content" class="chat-content" role="log" aria-live="polite">
          <div class="message bot-message">
            <div class="message-content">
              <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="#007BFF" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10c2.21 0 4.208-.896 5.656-2.344L20 18.414V20h1.586l-1.414-1.414L18.344 17.656C19.792 16.208 20.688 14.21 20.688 12c0-5.514-4.486-10-10-10zm-1 14H7v-2h4v2zm0-4H7v-2h4v2zm6-4h-8v2h8V8z" />
              </svg>
              Hi! I'm Haru, how can I help you today?
            </div>
          </div>
        </div>
        <div id="chat-loading" class="chat-loading" aria-hidden="true">
          <svg class="spinner" width="24" height="24" viewBox="0 0 50 50">
            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke="#007BFF" stroke-width="5"></circle>
          </svg>
          <span>Thinking...</span>
        </div>
        <div class="chat-input-container">
          <input type="text" id="chat-input" class="chat-input" placeholder="Type your message..." aria-label="Chat Input" />
          <button id="send-message" class="send-message" aria-label="Send Message">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#ffffff" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.01 21L23 12 2.01 3v7l15 2-15 2z" />
            </svg>
          </button>
        </div>
      </div>
      <button id="open-chat" class="open-chat-button" aria-label="Open Chat">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="#ffffff" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 2H4C2.897 2 2 2.897 2 4v12c0 1.103.897 2 2 2h5l4 4 4-4h5c1.103 0 2-.897 2-2V4c0-1.103-.897-2-2-2zm0 14l-3-3H5V4h15v12z" />
        </svg>
      </button>
      <div id="consentModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="consentModalTitle" aria-describedby="consentModalDescription">
        <div class="modal-content">
          <button class="close-button" id="closeConsentModal" aria-label="Close Consent Modal">
            <i class="fas fa-times"></i>
          </button>
          <h2 id="consentModalTitle">
            <i class="fas fa-cookie"></i> Cookie Consent
          </h2>
          <p id="consentModalDescription">
            I use cookies stored in your browser to enhance your experience on my personal website. These cookies are essential for the website's functionality. By clicking "Accept," you consent to their use. You can also manage your cookie preferences in the "Manage Cookie Preferences" section.
          </p>
          <div class="consent-buttons">
            <button id="acceptConsent" class="consent-button">
              <i class="fas fa-check"></i> Accept
            </button>
            <button id="declineConsent" class="consent-button">
              <i class="fas fa-times"></i> Decline
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Scripts -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // --- Mapbox Initialization ---
        mapboxgl.accessToken = 'pk.eyJ1IjoiYXJ0ZW1pczExNyIsImEiOiJjbTZzeHQ2bGowOHlnMm9yM3k4ZTl4cHptIn0.n1AdgsyV2iA7X1PwGvDTlA';
        const map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: [0, 20],
          zoom: 2
        });
        map.addControl(new mapboxgl.NavigationControl());
        const visitorMarkers = {};

        // --- Utility Logging Function ---
        const log = (msg) => console.log(`[Haru.js] ${msg}`);

        // --- Socket.IO Initialization ---
        const socket = io("https://mikumiku.dev");
        let lastHeartbeatReceived = Date.now();
        let isSessionExpired = false;
        let browsingStartTime = null;
        let browsingInterval = null;

        // --- DOM Element References ---
        const nowPlayingBox = document.getElementById("nowPlayingBox");
        const videoTitleElement = document.getElementById("videoTitle");
        const videoThumbnailImage = document.getElementById("videoThumbnailImage");
        const videoThumbnailElement = document.getElementById("videoThumbnail");
        const offlineIndicatorElement = document.getElementById("offline-indicator");
        const progressBarElement = document.getElementById("progressBar");
        const channelNameElement = document.getElementById("channelName");
        const viewCountElement = document.getElementById("viewCount");
        const likeCountElement = document.getElementById("likeCount");
        const publishedDateElement = document.getElementById("publishedDate");
        const videoCategoryElement = document.getElementById("videoCategory");
        const videoDescriptionElement = document.getElementById("descriptionModalDescription");
        const timeElapsedContainer = document.getElementById("timeElapsedContainer");
        const liveIndicatorElement = document.getElementById("liveIndicator");
        const pauseIndicatorElement = document.getElementById("pauseIndicator");
        const videoInfoContainer = document.getElementById("videoInfoContainer");

        // --- Helper Functions ---
        function formatNumber(number) {
          if (typeof number === "string") number = number.replace(/,/g, "");
          const num = Number(number);
          return isNaN(num) ? "N/A" : num.toLocaleString();
        }

        function formatElapsedTime(seconds) {
          const hrs = Math.floor(seconds / 3600);
          const mins = Math.floor((seconds % 3600) / 60);
          const secs = seconds % 60;
          if (hrs > 0) return `${hrs}h ${mins}m ${secs}s`;
          else if (mins > 0) return `${mins}m ${secs}s`;
          else return `${secs}s`;
        }

        function updateBrowsingElapsed() {
          if (browsingStartTime) {
            const elapsedSec = Math.floor((Date.now() - browsingStartTime) / 1000);
            timeElapsedContainer.innerHTML = `<i class="fas fa-clock"></i> ${formatElapsedTime(elapsedSec)}`;
          }
        }

        function clearDisplay() {
          nowPlayingBox.classList.add("offline");
          offlineIndicatorElement.style.display = "flex";
          videoTitleElement.textContent = "I’m not on YouTube at the moment, soz :(";
          videoThumbnailImage.src = "";
          videoThumbnailImage.style.display = "none";
          videoThumbnailElement.src = "";
          videoThumbnailElement.style.display = "none";
          channelNameElement.textContent = "";
          viewCountElement.textContent = "";
          likeCountElement.textContent = "";
          publishedDateElement.textContent = "";
          videoCategoryElement.textContent = "";
          progressBarElement.style.width = "0%";
          const descModal = document.getElementById("descriptionModal");
          descModal.querySelector("p").textContent = "";
          descModal.classList.remove("active");
          timeElapsedContainer.classList.remove("active");
          liveIndicatorElement.classList.remove("active");
          pauseIndicatorElement.classList.remove("active");
          clearInterval(browsingInterval);
          browsingInterval = null;
          browsingStartTime = null;
          log("Display cleared.");
        }

        function handleRealTimeProgress(data) {
          if (data.duration && data.currentTime !== undefined) {
            const progressPercentage = (data.currentTime / data.duration) * 100;
            progressBarElement.style.width = progressPercentage + "%";
            log(`Progress: ${progressPercentage.toFixed(2)}% (Live: ${data.isLive}, Paused: ${data.isPaused})`);
            if (data.isLive && data.isPaused) {
              log("Conflict: Both isLive and isPaused are true. Prioritizing live indicator.");
            }
            if (data.isLive) {
              liveIndicatorElement.classList.add("active");
              pauseIndicatorElement.classList.remove("active");
              log("Live indicator activated.");
            } else if (data.isPaused) {
              liveIndicatorElement.classList.remove("active");
              pauseIndicatorElement.classList.add("active");
              log("Pause indicator activated.");
            } else {
              liveIndicatorElement.classList.remove("active");
              pauseIndicatorElement.classList.remove("active");
              log("No indicator active.");
            }
          } else {
            progressBarElement.style.width = "0%";
            log("Invalid progress data received.");
          }
          if (!data.isPaused && !data.isLive) {
            videoTitleElement.classList.add("playing");
          } else {
            videoTitleElement.classList.remove("playing");
          }
        }

        function displayVideoPresence(data) {
          lastHeartbeatReceived = Date.now();
          nowPlayingBox.classList.remove("offline");
          offlineIndicatorElement.style.display = "none";
          log("Updating video presence...");
          if (videoTitleElement.textContent !== data.title || videoThumbnailImage.src !== data.thumbnail) {
            videoInfoContainer.classList.add("fade-out");
            setTimeout(() => {
              videoTitleElement.textContent = data.title || "Unknown Title";
              videoTitleElement.classList.remove("video-title-changed");
              void videoTitleElement.offsetWidth;
              videoTitleElement.classList.add("video-title-changed");
              if (data.thumbnail) {
                videoThumbnailImage.src = data.thumbnail;
                videoThumbnailImage.style.display = "block";
                videoThumbnailElement.style.display = "none";
              } else {
                videoThumbnailImage.src = "";
                videoThumbnailElement.style.display = "none";
              }
              channelNameElement.textContent = data.channelTitle || "Unknown Channel";
              viewCountElement.textContent = formatNumber(data.viewCount) || "N/A";
              likeCountElement.textContent = formatNumber(data.likeCount) || "N/A";
              if (data.publishedAt) {
                const publishedDate = new Date(data.publishedAt);
                publishedDateElement.textContent = publishedDate.toLocaleDateString() || "Published on: N/A";
              } else {
                publishedDateElement.textContent = "Published on: N/A";
              }
              videoCategoryElement.textContent = data.category || "N/A";
              const descModal = document.getElementById("descriptionModal");
              descModal.querySelector("p").textContent = data.description || "No description available.";
              descModal.classList.remove("active");
              // Hide browsing time elapsed when video presence is active.
              timeElapsedContainer.classList.remove("active");
              if (data.videoSrc) {
                videoThumbnailElement.src = data.videoSrc;
                videoThumbnailElement.style.display = "block";
                videoThumbnailImage.style.display = "none";
              } else {
                videoThumbnailElement.style.display = "none";
                videoThumbnailImage.style.display = "block";
              }
              videoInfoContainer.classList.remove("fade-out");
              videoInfoContainer.classList.add("fade-in");
              log("Video presence updated in UI.");
            }, 500);
          }
          handleRealTimeProgress(data);
        }

        function displayBrowsingPresence(data) {
          lastHeartbeatReceived = Date.now();
          nowPlayingBox.classList.remove("offline");
          offlineIndicatorElement.style.display = "none";
          log("Updating browsing presence...");
          const defaultThumbnail = "https://www.youtube.com/img/desktop/yt_1200.png";
          // Update thumbnail only if necessary to prevent flickering.
          if (videoThumbnailImage.src !== defaultThumbnail) {
            videoThumbnailImage.src = data.thumbnail || defaultThumbnail;
            videoThumbnailImage.style.display = "block";
            videoThumbnailElement.style.display = "none";
          }
          videoTitleElement.textContent = data.title || "Browsing YouTube";
          channelNameElement.textContent = "Browsing...";
          viewCountElement.textContent = "";
          likeCountElement.textContent = "";
          publishedDateElement.textContent = "";
          videoCategoryElement.textContent = "";
          const descModal = document.getElementById("descriptionModal");
          descModal.querySelector("p").textContent = data.description || "Browsing videos on YouTube";
          descModal.classList.remove("active");
          if (!browsingStartTime) {
            browsingStartTime = Date.now();
          }
          timeElapsedContainer.classList.add("active");
          updateBrowsingElapsed();
          if (!browsingInterval) {
            browsingInterval = setInterval(updateBrowsingElapsed, 1000);
          }
          liveIndicatorElement.classList.remove("active");
          pauseIndicatorElement.classList.remove("active");
          progressBarElement.style.width = "0%";
          videoInfoContainer.classList.remove("fade-out");
          videoInfoContainer.classList.add("fade-in");
          log("Browsing presence updated in UI.");
        }

        // --- Socket.IO Event Listeners ---
        socket.on("connect", function () {
          log("Connected to server via Socket.IO.");
          isSessionExpired = false;
          socket.emit("requestLatestData");
        });
        
        socket.on("presenceUpdate", function (data) {
          if (isSessionExpired) {
            log("Ignoring presenceUpdate due to expired session.");
            return;
          }
          log("Received presenceUpdate: " + JSON.stringify(data));
          if (data.presenceType === "video") {
            clearInterval(browsingInterval);
            browsingInterval = null;
            browsingStartTime = null;
            displayVideoPresence(data);
          } else if (data.presenceType === "browsing") {
            log("Browsing presence update received.");
            displayBrowsingPresence(data);
          } else {
            clearDisplay();
          }
        });
        
        socket.on("disconnect", function () {
          log("Disconnected from server.");
          clearDisplay();
        });
        
        setInterval(function () {
          if (Date.now() - lastHeartbeatReceived > 60000) {
            log("No heartbeat received in 60 seconds. Marking as offline.");
            clearDisplay();
          }
        }, 5000);
        
        // --- Mapbox Visitor Markers ---
        socket.on("visitorLocation", function (data) {
          log(`Received visitor location: ${JSON.stringify(data)}`);
          const { id, latitude, longitude, info } = data;
          if (visitorMarkers[id]) {
            visitorMarkers[id].setLngLat([longitude, latitude]);
          } else {
            const marker = new mapboxgl.Marker({ color: "#ff4081" })
              .setLngLat([longitude, latitude])
              .addTo(map);
            if (info) {
              marker.setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`<strong>${info}</strong>`));
            }
            visitorMarkers[id] = marker;
          }
        });
        
        // --- Description Modal Toggle ---
        const descriptionModal = document.getElementById("descriptionModal");
        const toggleDescriptionButton = document.getElementById("toggleDescriptionButton");
        descriptionModal.classList.remove("active");
        toggleDescriptionButton.textContent = " Show Description";
        toggleDescriptionButton.addEventListener("click", function (e) {
          e.stopPropagation();
          if (descriptionModal.classList.contains("active")) {
            descriptionModal.classList.remove("active");
            toggleDescriptionButton.textContent = " Show Description";
          } else {
            descriptionModal.classList.add("active");
            toggleDescriptionButton.textContent = " Hide Description";
          }
        });
        document.addEventListener("click", function (e) {
          if (!descriptionModal.contains(e.target) && e.target !== toggleDescriptionButton) {
            descriptionModal.classList.remove("active");
            toggleDescriptionButton.textContent = " Show Description";
          }
        });
      });
    </script>
    
    <!-- Clock and Weather Updates -->
    <script>
      function updateClocks() {
        const now = new Date();
        const localTime = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
        const localTimeElement = document.getElementById("local-time");
        if (localTimeElement) localTimeElement.textContent = localTime;
        const currentDate = now.toLocaleDateString(undefined, { day: "2-digit", month: "long", year: "numeric" });
        const currentDateElement = document.getElementById("current-date");
        if (currentDateElement) currentDateElement.textContent = currentDate;
        const dayOfWeek = now.toLocaleDateString(undefined, { weekday: "long" });
        const dayOfWeekElement = document.getElementById("day-of-week");
        if (dayOfWeekElement) dayOfWeekElement.textContent = dayOfWeek;
      }
      setInterval(updateClocks, 1000);
      updateClocks();
      
      const CITY_NAME = "Leeds";
      async function fetchWeather() {
        try {
          const response = await fetch("/api/weather?city=" + encodeURIComponent(CITY_NAME));
          const data = await response.json();
          if (data.error) throw new Error(data.error);
          displayWeather(data);
        } catch (error) {
          console.error("Error fetching weather data:", error);
          const weatherIconElement = document.getElementById("weather-icon");
          if (weatherIconElement) weatherIconElement.style.display = "none";
          document.getElementById("weather-description").innerText = "Unable to fetch weather data.";
        }
      }
      function displayWeather(data) {
        const description = data.weather[0].description,
              temperature = Math.round(data.main.temp),
              humidity = data.main.humidity,
              windSpeed = data.wind.speed,
              iconCode = data.weather[0].icon,
              iconUrl = "https://openweathermap.org/img/wn/" + iconCode + "@2x.png";
        document.getElementById("weather-description").innerText = "Condition: " + description;
        document.getElementById("temperature").innerText = "Temperature: " + temperature + "°C";
        document.getElementById("humidity").innerText = "Humidity: " + humidity + "%";
        document.getElementById("wind-speed").innerText = "Wind: " + windSpeed + " m/s";
        const weatherIconElement = document.getElementById("weather-icon");
        if (weatherIconElement) {
          weatherIconElement.src = iconUrl;
          weatherIconElement.style.display = "block";
        }
      }
      setInterval(fetchWeather, 3600000);
      fetchWeather();
    </script>
    
    <!-- Sound Wave Matrix -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const canvas = document.getElementById("soundWaveCanvas");
        const ctx = canvas.getContext("2d");
        function resizeCanvas() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener("resize", () => {
          resizeCanvas();
          columns = Math.floor(canvas.width / fontSize);
          drops = new Array(columns).fill(0);
          speeds = Array.from({ length: columns }, () => Math.random() * 0.05 + 0.05);
          phraseCounters = new Array(columns).fill(0);
          currentDigits = new Array(columns).fill("0");
        });
        const fontSize = 20;
        let columns = Math.floor(canvas.width / fontSize);
        let drops = new Array(columns).fill(0);
        let speeds = Array.from({ length: columns }, () => Math.random() * 0.05 + 0.05);
        let phraseCounters = new Array(columns).fill(0);
        let currentDigits = new Array(columns).fill("0");
        const binaryChars = "01";
        const colors = ["#00C6FF", "#ff4081"];
        const mikuPhrases = [
          "Hatsune Miku",
          "The First Sound of the Future",
          "39",
          "Digital Diva",
          "CV01",
          "01",
        ];
        function hexToRGBA(hex, alpha) {
          const r = parseInt(hex.slice(1, 3), 16),
                g = parseInt(hex.slice(3, 5), 16),
                b = parseInt(hex.slice(5, 7), 16);
          return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        function drawMatrix() {
          ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.font = fontSize + "px monospace";
          ctx.shadowColor = "rgba(0, 0, 0, 0.8)";
          ctx.shadowBlur = 4;
          const trailLength = 6;
          for (let i = 0; i < drops.length; i++) {
            let dropIncrement = speeds[i];
            let text;
            if (phraseCounters[i] > 0) {
              dropIncrement = 0;
              phraseCounters[i]--;
            }
            if (phraseCounters[i] === 0 && Math.random() < 0.002) {
              text = mikuPhrases[Math.floor(Math.random() * mikuPhrases.length)];
              ctx.fillStyle = "#FF69B4";
              phraseCounters[i] = 180;
              dropIncrement = speeds[i] * 0.2;
            } else {
              if (Math.random() < 0.1) {
                currentDigits[i] = binaryChars.charAt(Math.floor(Math.random() * binaryChars.length));
              }
              text = currentDigits[i];
              ctx.fillStyle = colors[i % colors.length];
            }
            const x = i * fontSize;
            const y = Math.floor(drops[i]) * fontSize;
            ctx.fillText(text, x, y);
            for (let j = 1; j < trailLength; j++) {
              const ty = y - j * fontSize;
              if (ty < 0) break;
              const alpha = 1 - j / trailLength;
              ctx.fillStyle = hexToRGBA(colors[i % colors.length], alpha);
              ctx.fillText(binaryChars.charAt(Math.floor(Math.random() * binaryChars.length)), x, ty);
            }
            if (y > canvas.height && Math.random() > 0.995) {
              drops[i] = 0;
              speeds[i] = Math.random() * 0.05 + 0.05;
              phraseCounters[i] = 0;
              currentDigits[i] = "0";
            }
            drops[i] += dropIncrement;
          }
          requestAnimationFrame(drawMatrix);
        }
        drawMatrix();
      });
    </script>
  </body>
</html>
