<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Miku.dev | Home</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="/styles.css" />
<style>
  .now-playing-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    background: transparent;
    padding: 10px;
  }
  .grid-container {
    display: contents; /* preserve children grid behavior */
  }
  .video-info-details,
  .clock-section,
  .youtube-section,
  .weather-section {
    background: #222;
    border-radius: 8px;
    padding: 15px;
    color: white;
    box-sizing: border-box;
  }
  .description-modal {
    display: none;
    background: #333;
    color: white;
    padding: 15px;
    margin-top: 10px;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
  }
  .description-modal.active {
    display: block;
  }
</style>
</head>
<body>
<canvas id="soundWaveCanvas" aria-hidden="true"></canvas>
<div class="page-container" id="pageContainer">
  <header class="title-bar" id="titleBar">
    <div class="container">
      <div class="left-section"></div>
      <div class="title-wrapper">
        <a href="/" aria-label="Home" class="logo-link">
          <span class="site-title">Miku.dev</span>
          <div class="visualizer-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 100" class="visualizer">
              <g>
                <rect x="10" y="70" width="15" height="30" fill="#00c6ff">
                  <animate attributeName="height" values="30;60;30" dur="0.8s" repeatCount="indefinite" />
                  <animate attributeName="y" values="70;40;70" dur="0.8s" repeatCount="indefinite" />
                </rect>
                <rect x="35" y="60" width="15" height="40" fill="#ff4081">
                  <animate attributeName="height" values="40;80;40" dur="1s" repeatCount="indefinite" />
                  <animate attributeName="y" values="60;20;60" dur="1s" repeatCount="indefinite" />
                </rect>
                <rect x="60" y="80" width="15" height="20" fill="#00c6ff">
                  <animate attributeName="height" values="20;50;20" dur="0.6s" repeatCount="indefinite" />
                  <animate attributeName="y" values="80;50;80" dur="0.6s" repeatCount="indefinite" />
                </rect>
                <rect x="85" y="50" width="15" height="50" fill="#ff4081">
                  <animate attributeName="height" values="50;90;50" dur="1.2s" repeatCount="indefinite" />
                  <animate attributeName="y" values="50;10;50" dur="1.2s" repeatCount="indefinite" />
                </rect>
                <rect x="110" y="70" width="15" height="30" fill="#00c6ff">
                  <animate attributeName="height" values="30;60;30" dur="0.9s" repeatCount="indefinite" />
                  <animate attributeName="y" values="70;40;70" dur="0.9s" repeatCount="indefinite" />
                </rect>
                <rect x="135" y="60" width="15" height="40" fill="#ff4081">
                  <animate attributeName="height" values="40;80;40" dur="1.1s" repeatCount="indefinite" />
                  <animate attributeName="y" values="60;20;60" dur="1.1s" repeatCount="indefinite" />
                </rect>
              </g>
            </svg>
          </div>
        </a>
      </div>
      <div class="right-section">
        <button class="menu-button" id="menuButton" aria-label="Open Menu"><i class="fas fa-music"></i></button>
      </div>
    </div>
  </header>

  <nav class="overlay-menu" id="overlayMenu" aria-hidden="true">
    <button class="close-overlay" id="closeOverlay" aria-label="Close Menu"><i class="fas fa-times"></i></button>
    <div class="overlay-content">
      <a href="/auth" aria-label="Admin Login"><i class="fas fa-user-lock"></i> Admin Login</a>
      <a href="#aboutMe" aria-label="About Me"><i class="fas fa-info-circle"></i> About Me</a>
      <div class="personality-options">
        <button id="personalityOption1" class="personality-button"><i class="fas fa-music"></i> Melody</button>
        <button id="personalityOption2" class="personality-button"><i class="fas fa-headphones"></i> Harmony</button>
        <button id="personalityOption3" class="personality-button"><i class="fas fa-microphone"></i> Rhythm</button>
      </div>
    </div>
  </nav>

  <section class="now-playing-container">

    <div id="nowPlayingBox" class="grid-container">

      <div id="videoInfo" class="video-info-details widget">
        <div class="info-item"><i class="fas fa-tv"></i><span id="channelName">Loading...</span></div>
        <div class="info-item"><i class="fas fa-eye"></i><span id="viewCount">Loading...</span></div>
        <div class="info-item"><i class="fas fa-thumbs-up"></i><span id="likeCount">Loading...</span></div>
        <div class="info-item"><i class="fas fa-calendar-day"></i><span id="publishedDate">Loading...</span></div>
        <div class="info-item video-category"><i class="fas fa-tag"></i><span id="videoCategory">Loading...</span></div>
      </div>
  

      <div id="timeInfo" class="clock-section widget">
        <p class="greeting"><i class="fas fa-sun"></i><span id="greeting-text">Good Morning!</span></p>
        <p id="local-time"><i class="fas fa-clock"></i> 00:00:00</p>
        <p id="current-date"><i class="fas fa-calendar-alt"></i> 1 January 2025</p>
        <p id="day-of-week"><i class="fas fa-calendar-day"></i> Wednesday</p>
        <p id="time-zone"><i class="fas fa-globe"></i> UTC</p>
        <p id="last-visit-message" class="last-visit-message"><i class="fas fa-history"></i> Welcome back!</p>
      </div>
  

      <div id="youtubeSection" class="youtube-section widget">
        <h2>Currently Playing</h2>
        <p id="videoTitle" class="video-title">Loading…</p>
        <div class="thumbnail-container">
          <img id="videoThumbnailImage" class="video-thumbnail" src="" alt="Thumbnail" loading="lazy">
        </div>
        <div class="progress-wrapper">
          <div class="progress-bar-container">
            <div id="progressBar" class="progress-bar"></div>
          </div>
          <div class="indicator-container">
            <span id="liveIndicator" class="indicator live">Live</span>
            <span id="pauseIndicator" class="indicator paused">Paused</span>
          </div>
          <p id="timeElapsedContainer" class="time-elapsed" style="display:none;"></p>
        </div>
        <div id="offline-indicator" class="offline-indicator" style="display:none;">
          <i class="fas fa-signal-slash"></i> I’m currently offline
        </div>
        <button class="toggle-description widget-button" id="toggleDescriptionButton">
          <i class="fas fa-info-circle"></i> Show Description
        </button>
        <div id="descriptionModal" class="description-modal" aria-hidden="true">
          <h3>Description</h3>
          <p id="descriptionModalDescription">Loading description…</p>
        </div>
      </div>
  

      <aside id="weatherSection" class="weather-section widget">
        <img id="weather-icon" class="weather-icon" src="" alt="Weather Icon" loading="lazy">
        <p id="weather-description"><i class="fas fa-cloud-sun"></i> Loading…</p>
        <p id="temperature"><i class="fas fa-temperature-high"></i> --°C</p>
        <p id="humidity"><i class="fas fa-tint"></i> Humidity: --%</p>
        <p id="wind-speed"><i class="fas fa-wind"></i> Wind: -- m/s</p>
      </aside>
  

      <div id="bufferOverlay" class="buffer-overlay">Buffering…</div>
    </div>
  </section>



  <footer class="footer">
    <div class="container">
      <p>&copy; 2024 MikuMiku. All rights reserved.</p>
      <button id="manageConsentFooter" class="manage-consent-button"><i class="fas fa-cookie-bite"></i> Manage Cookie Preferences</button>
    </div>
  </footer>

  <div id="consentModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="consentModalTitle" aria-describedby="consentModalDescription">
    <div class="modal-content">
      <button class="close-button" id="closeConsentModal" aria-label="Close Consent Modal"><i class="fas fa-times"></i></button>
      <h2 id="consentModalTitle"><i class="fas fa-cookie"></i> Cookie Consent</h2>
      <p id="consentModalDescription">
        I use cookies stored in your browser to enhance your experience on my personal website. These cookies are essential for the website's functionality. By clicking "Accept," you consent to their use. You can also manage your cookie preferences in the "Manage Cookie Preferences" section.
      </p>
      <div class="consent-buttons">
        <button id="acceptConsent" class="consent-button"><i class="fas fa-check"></i> Accept</button>
        <button id="declineConsent" class="consent-button"><i class="fas fa-times"></i> Decline</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.1/socket.io.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="haru.js"></script>
<script src="clockwork.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const pageContainer = document.getElementById("pageContainer");
  if (pageContainer) pageContainer.classList.add("loaded");

  const titleBar = document.getElementById("titleBar");
  window.addEventListener("scroll", () => {
    if (titleBar) titleBar.classList.toggle("scrolled", window.scrollY > 50);
  });

  const menuButton = document.getElementById("menuButton");
  const overlayMenu = document.getElementById("overlayMenu");
  const closeOverlay = document.getElementById("closeOverlay");

  menuButton?.addEventListener("click", e => {
    e.stopPropagation();
    overlayMenu.classList.add("active");
    document.body.classList.add("overlay-active");
    overlayMenu.setAttribute("aria-hidden", "false");
  });

  closeOverlay?.addEventListener("click", e => {
    e.stopPropagation();
    overlayMenu.classList.remove("active");
    document.body.classList.remove("overlay-active");
    overlayMenu.setAttribute("aria-hidden", "true");
  });

  window.addEventListener("click", e => {
    if (e.target === overlayMenu) {
      overlayMenu.classList.remove("active");
      document.body.classList.remove("overlay-active");
      overlayMenu.setAttribute("aria-hidden", "true");
    }
  });

  const personalityButtons = document.querySelectorAll(".personality-button");
  const siteTitle = document.querySelector(".site-title");
  personalityButtons.forEach(button => {
    button.addEventListener("click", () => {
      switch(button.textContent.trim()) {
        case "Melody": siteTitle.style.color = "#ff4081"; break;
        case "Harmony": siteTitle.style.color = "#00c6ff"; break;
        case "Rhythm": siteTitle.style.color = "#ffffff"; break;
        default: siteTitle.style.color = "#00c6ff";
      }
      personalityButtons.forEach(btn => btn.classList.remove("active"));
      button.classList.add("active");
    });
  });

  // Restore stored video info
  const storedTitle = localStorage.getItem("currentVideoTitle");
  const storedThumbnail = localStorage.getItem("currentVideoThumbnail");
  if(storedTitle) document.getElementById("videoTitle").textContent = storedTitle;
  if(storedThumbnail) {
    const img = document.getElementById("videoThumbnailImage");
    img.src = storedThumbnail;
    img.style.display = "block";
  }

  // Consent Modal Handling
  (function() {
    const CONFIG = {
      consentCookieName: "cookieConsent",
      consentCookieExpiryDays: 365,
      consentCookiePath: "/",
      consentModalId: "consentModal",
      acceptButtonId: "acceptConsent",
      declineButtonId: "declineConsent",
      manageButtonIds: ["manageConsentFooter"],
      closeButtonId: "closeConsentModal",
      focusableSelectors: "button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])",
    };
    const consentModal = document.getElementById(CONFIG.consentModalId);
    const acceptButton = document.getElementById(CONFIG.acceptButtonId);
    const declineButton = document.getElementById(CONFIG.declineButtonId);
    const closeButton = document.getElementById(CONFIG.closeButtonId);
    const manageConsentButtons = CONFIG.manageButtonIds.map(id => document.getElementById(id));

    function setCookie(name, value, days, path) {
      let expires = "";
      if (days) {
        const date = new Date();
        date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
        expires = "; expires=" + date.toUTCString();
      }
      const secure = location.protocol === "https:" ? "; Secure" : "";
      const sameSite = "; SameSite=Lax";
      document.cookie = `${name}=${value || ""}${expires}; path=${path}${secure}${sameSite}`;
    }
    function getCookie(name) {
      const nameEQ = name + "=";
      return document.cookie.split(";").map(c => c.trim()).find(c => c.startsWith(nameEQ))?.substring(nameEQ.length) || null;
    }
    function eraseCookie(name, path) {
      document.cookie = `${name}=; Max-Age=-99999999; path=${path};`;
    }
    function trapFocus(modal) {
      const focusables = modal.querySelectorAll(CONFIG.focusableSelectors);
      if (!focusables.length) return;
      const first = focusables[0], last = focusables[focusables.length - 1];
      modal.addEventListener("keydown", e => {
        if (e.key === "Tab") {
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
        if (e.key === "Escape") e.preventDefault();
      });
    }
    function showModal() {
      consentModal.classList.add("active");
      document.body.classList.add("modal-active");
      consentModal.setAttribute("aria-hidden", "false");
      consentModal.querySelector(CONFIG.focusableSelectors)?.focus();
      trapFocus(consentModal);
    }
    function hideModal() {
      consentModal.classList.remove("active");
      document.body.classList.remove("modal-active");
      consentModal.setAttribute("aria-hidden", "true");
    }
    function initializeCookies() {
      console.log("Necessary cookies enabled.");
    }
    function disableCookies() {
      console.log("Necessary cookies disabled.");
    }
    function applyConsent(value) {
      try {
        const consent = JSON.parse(value);
        consent.necessary ? initializeCookies() : disableCookies();
      } catch {
        showModal();
      }
    }
    function areCookiesEnabled() {
      setCookie("test_cookie_consent", "test", 1, CONFIG.consentCookiePath);
      const enabled = getCookie("test_cookie_consent") === "test";
      eraseCookie("test_cookie_consent", CONFIG.consentCookiePath);
      return enabled;
    }
    function initConsentModal() {
      const existing = getCookie(CONFIG.consentCookieName);
      if (!existing) showModal();
      else applyConsent(existing);

      acceptButton?.addEventListener("click", () => {
        setCookie(CONFIG.consentCookieName, JSON.stringify({ necessary: true }), CONFIG.consentCookieExpiryDays, CONFIG.consentCookiePath);
        hideModal();
        initializeCookies();
      });
      declineButton?.addEventListener("click", () => {
        setCookie(CONFIG.consentCookieName, JSON.stringify({ necessary: false }), CONFIG.consentCookieExpiryDays, CONFIG.consentCookiePath);
        hideModal();
        disableCookies();
      });
      manageConsentButtons.forEach(button => button?.addEventListener("click", e => {
        e.preventDefault();
        showModal();
      }));
      closeButton?.addEventListener("click", () => alert("Please make a choice regarding cookie usage."));
      window.addEventListener("click", e => {
        if (e.target === consentModal) alert("Please make a choice regarding cookie usage.");
      });
    }

    if (areCookiesEnabled()) initConsentModal();
    else console.warn("Cookies are disabled in this browser. Consent modal will not be displayed.");
  })();

  // Toggle description modal
  const toggleButton = document.getElementById("toggleDescriptionButton");
  const descriptionModal = document.getElementById("descriptionModal");
  if (localStorage.getItem("descriptionModalOpen") === "true") {
    descriptionModal.classList.add("active");
    toggleButton.innerHTML = '<i class="fas fa-info-circle"></i> Hide Description';
  } else {
    descriptionModal.classList.remove("active");
    toggleButton.innerHTML = '<i class="fas fa-info-circle"></i> Show Description';
  }
  toggleButton.addEventListener("click", () => {
    if (descriptionModal.classList.contains("active")) {
      descriptionModal.classList.remove("active");
      toggleButton.innerHTML = '<i class="fas fa-info-circle"></i> Show Description';
      localStorage.setItem("descriptionModalOpen", "false");
    } else {
      descriptionModal.classList.add("active");
      toggleButton.innerHTML = '<i class="fas fa-info-circle"></i> Hide Description';
      localStorage.setItem("descriptionModalOpen", "true");
    }
  });

  // Clock update
  function updateClocks() {
    const now = new Date();
    const localTime = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    const currentDate = now.toLocaleDateString(undefined, { day: "2-digit", month: "long", year: "numeric" });
    const dayOfWeek = now.toLocaleDateString(undefined, { weekday: "long" });
    document.getElementById("local-time").textContent = localTime;
    document.getElementById("current-date").textContent = currentDate;
    document.getElementById("day-of-week").textContent = dayOfWeek;
  }
  updateClocks();
  setInterval(updateClocks, 1000);

  // Weather fetching and display
  async function fetchWeather() {
    try {
      const res = await fetch("/api/weather?city=Leeds");
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      const { description } = data.weather[0];
      const temperature = Math.round(data.main.temp);
      const humidity = data.main.humidity;
      const windSpeed = data.wind.speed;
      const iconCode = data.weather[0].icon;
      const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
      document.getElementById("weather-description").innerText = "Condition: " + description;
      document.getElementById("temperature").innerText = `Temperature: ${temperature}°C`;
      document.getElementById("humidity").innerText = `Humidity: ${humidity}%`;
      document.getElementById("wind-speed").innerText = `Wind: ${windSpeed} m/s`;
      const iconEl = document.getElementById("weather-icon");
      iconEl.src = iconUrl;
      iconEl.style.display = "block";
    } catch {
      const iconEl = document.getElementById("weather-icon");
      iconEl.style.display = "none";
      document.getElementById("weather-description").innerText = "Unable to fetch weather data.";
    }
  }
  fetchWeather();
  setInterval(fetchWeather, 3600000);

  // Sound wave canvas matrix animation
  const canvas = document.getElementById("soundWaveCanvas");
  const ctx = canvas.getContext("2d");
  const fontSize = 20;
  let columns, drops, speeds, phraseCounters, currentDigits;
  const binaryChars = "01";
  const colors = ["#00C6FF", "#ff4081"];
  const mikuPhrases = ["Hatsune Miku", "The First Sound of the Future", "39", "Digital Diva", "CV01", "01"];
  function hexToRGBA(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16),
          g = parseInt(hex.slice(3, 5), 16),
          b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r},${g},${b},${alpha})`;
  }
  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    columns = Math.floor(canvas.width / fontSize);
    drops = Array(columns).fill(0);
    speeds = Array.from({ length: columns }, () => Math.random() * 0.05 + 0.05);
    phraseCounters = Array(columns).fill(0);
    currentDigits = Array(columns).fill("0");
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  function drawMatrix() {
    ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.font = `${fontSize}px monospace`;
    ctx.shadowColor = "rgba(0, 0, 0, 0.8)";
    ctx.shadowBlur = 4;
    const trailLength = 6;
    for (let i = 0; i < drops.length; i++) {
      let dropIncrement = speeds[i];
      let text;
      if (phraseCounters[i] > 0) {
        dropIncrement = 0;
        phraseCounters[i]--;
      }
      if (phraseCounters[i] === 0 && Math.random() < 0.002) {
        text = mikuPhrases[Math.floor(Math.random() * mikuPhrases.length)];
        ctx.fillStyle = "#FF69B4";
        phraseCounters[i] = 180;
        dropIncrement = speeds[i] * 0.2;
      } else {
        if (Math.random() < 0.1) currentDigits[i] = binaryChars.charAt(Math.floor(Math.random() * binaryChars.length));
        text = currentDigits[i];
        ctx.fillStyle = colors[i % colors.length];
      }
      const x = i * fontSize;
      const y = Math.floor(drops[i]) * fontSize;
      ctx.fillText(text, x, y);
      for (let j = 1; j < trailLength; j++) {
        const ty = y - j * fontSize;
        if (ty < 0) break;
        const alpha = 1 - j / trailLength;
        ctx.fillStyle = hexToRGBA(colors[i % colors.length], alpha);
        ctx.fillText(binaryChars.charAt(Math.floor(Math.random() * binaryChars.length)), x, ty);
      }
      if (y > canvas.height && Math.random() > 0.995) {
        drops[i] = 0;
        speeds[i] = Math.random() * 0.05 + 0.05;
        phraseCounters[i] = 0;
        currentDigits[i] = "0";
      }
      drops[i] += dropIncrement;
    }
    requestAnimationFrame(drawMatrix);
  }
  drawMatrix();
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const elements = {
    nowPlayingBox: document.getElementById("nowPlayingBox"),
    videoTitle: document.getElementById("videoTitle"),
    videoThumbnailImage: document.getElementById("videoThumbnailImage"),
    offlineIndicator: document.getElementById("offline-indicator"),
    progressBar: document.getElementById("progressBar"),
    channelName: document.getElementById("channelName"),
    viewCount: document.getElementById("viewCount"),
    likeCount: document.getElementById("likeCount"),
    publishedDate: document.getElementById("publishedDate"),
    videoCategory: document.getElementById("videoCategory"),
    timeElapsedContainer: document.getElementById("timeElapsedContainer"),
    liveIndicator: document.getElementById("liveIndicator"),
    pauseIndicator: document.getElementById("pauseIndicator"),
    youtubeSection: document.getElementById("youtubeSection"),
    bufferOverlay: document.getElementById("bufferOverlay"),
    toggleDescriptionButton: document.getElementById("toggleDescriptionButton"),
  };

  let currentVideoTitle = "";
  let currentVideoThumbnail = "";
  let isBrowsing = false;
  let browsingStartTime = null;
  let browsingInterval = null;
  let isBuffering = false;
  let lastHeartbeatReceived = Date.now();
  let isOffline = false;
  let isSessionExpired = false;

  const log = (msg) => console.log(`[Haru.js] ${msg}`);

  function formatNumber(num) {
    if (typeof num === "string") num = num.replace(/,/g, "");
    const n = Number(num);
    return isNaN(n) ? "N/A" : n.toLocaleString();
  }
  function formatElapsedTime(sec) {
    return `${Math.floor(sec / 60).toString().padStart(2,"0")}:${(sec % 60).toString().padStart(2,"0")}`;
  }
  function updateBrowsingElapsed() {
    if (!browsingStartTime) return;
    elements.timeElapsedContainer.style.display = "block";
    const elapsed = Math.floor((Date.now() - browsingStartTime) / 1000);
    elements.timeElapsedContainer.innerHTML = `<i class="fas fa-clock"></i> ${formatElapsedTime(elapsed)}`;
  }
  function clearDisplay() {
    if (isBuffering) return;
    elements.nowPlayingBox.classList.add("offline");
    Array.from(elements.youtubeSection.children).forEach(child => {
      if (child.id !== "offline-indicator") child.style.display = "none";
    });
    elements.offlineIndicator.style.display = "block";
    elements.offlineIndicator.classList.add("visible");
    elements.progressBar.style.width = "0%";
    elements.timeElapsedContainer.style.display = "none";
    elements.channelName.textContent = "";
    elements.viewCount.textContent = "";
    elements.likeCount.textContent = "";
    elements.publishedDate.textContent = "";
    elements.videoCategory.textContent = "";
    elements.videoTitle.textContent = "";
    const thumbContainer = document.querySelector(".thumbnail-container");
    if (thumbContainer) thumbContainer.style.display = "none";
    if (browsingInterval) {
      clearInterval(browsingInterval);
      browsingInterval = null;
    }
    browsingStartTime = null;
    localStorage.removeItem("browsingStartTime");
    log("Display cleared (offline).");
    if (elements.toggleDescriptionButton) elements.toggleDescriptionButton.style.display = "none";
  }
  function handleRealTimeProgress(data) {
    if (data.duration && data.currentTime !== undefined) {
      const progress = (data.currentTime / data.duration) * 100;
      elements.progressBar.style.width = progress + "%";
      if (data.isLive) {
        elements.liveIndicator.classList.add("active");
        elements.pauseIndicator.classList.remove("active");
      } else if (data.isPaused) {
        elements.liveIndicator.classList.remove("active");
        elements.pauseIndicator.classList.add("active");
      } else {
        elements.liveIndicator.classList.remove("active");
        elements.pauseIndicator.classList.remove("active");
      }
      elements.videoTitle.classList.toggle("playing", !data.isPaused && !data.isLive);
      log(`handleRealTimeProgress: Live=${data.isLive}, Paused=${data.isPaused}, Progress=${progress.toFixed(2)}%`);
    } else {
      elements.progressBar.style.width = "0%";
      log("handleRealTimeProgress: Invalid data.");
    }
  }
  function animateTitle(text) {
    const oldTitle = elements.videoTitle;
    if (!oldTitle) return;
    const newTitle = oldTitle.cloneNode(true);
    newTitle.textContent = text;
    newTitle.classList.remove("new-video-title");
    void newTitle.offsetWidth;
    newTitle.classList.add("new-video-title");
    oldTitle.parentNode.replaceChild(newTitle, oldTitle);
    localStorage.setItem("currentVideoTitle", text);
  }
  function animateThumbnail(src) {
    const oldThumb = elements.videoThumbnailImage;
    if (!oldThumb) return;
    const newThumb = oldThumb.cloneNode(true);
    newThumb.src = src;
    newThumb.style.display = "block";
    newThumb.classList.remove("new-video-thumbnail");
    void newThumb.offsetWidth;
    newThumb.classList.add("new-video-thumbnail");
    oldThumb.parentNode.replaceChild(newThumb, oldThumb);
    localStorage.setItem("currentVideoThumbnail", src);
  }
  function restoreYoutubeSection() {
    Array.from(elements.youtubeSection.children).forEach(child => {
      child.style.display = child.id === "offline-indicator" ? "none" : "block";
    });
  }
  function displayVideoPresence(data) {
    lastHeartbeatReceived = Date.now();
    isBrowsing = false;
    isOffline = false;
    elements.offlineIndicator.classList.remove("visible");
    elements.offlineIndicator.style.display = "none";
    elements.timeElapsedContainer.style.display = "none";
    restoreYoutubeSection();
    if (data.title === currentVideoTitle && data.thumbnail === currentVideoThumbnail) {
      handleRealTimeProgress(data);
      return;
    }
    currentVideoTitle = data.title;
    currentVideoThumbnail = data.thumbnail;
    isBuffering = true;
    elements.bufferOverlay.classList.add("active");
    elements.youtubeSection.classList.add("fade-out");

    setTimeout(() => {
      animateTitle(data.title || "Unknown Title");
      if (data.thumbnail) animateThumbnail(data.thumbnail);
      else {
        elements.videoThumbnailImage.src = "";
        elements.videoThumbnailImage.style.display = "none";
      }
      elements.channelName.textContent = data.channelTitle || "Unknown Channel";
      elements.viewCount.textContent = formatNumber(data.viewCount) || "N/A";
      elements.likeCount.textContent = formatNumber(data.likeCount) || "N/A";
      elements.publishedDate.textContent = data.publishedAt ? new Date(data.publishedAt).toLocaleDateString() : "Published on: N/A";
      elements.videoCategory.textContent = data.category || "N/A";

      const descModal = document.getElementById("descriptionModal");
      if (descModal) {
        descModal.querySelector("p").textContent = data.description || "No description available.";
        descModal.classList.remove("active");
      }
      elements.youtubeSection.classList.remove("fade-out");
      elements.youtubeSection.classList.add("fade-in");
      elements.nowPlayingBox.classList.remove("offline");
      elements.offlineIndicator.classList.remove("visible");
      elements.offlineIndicator.style.display = "none";
      elements.bufferOverlay.classList.remove("active");
      isBuffering = false;
      log("Video presence updated in UI.");
      if (elements.toggleDescriptionButton) elements.toggleDescriptionButton.style.display = "block";
      handleRealTimeProgress(data);
    }, 300);
  }
  function displayBrowsingPresence(data) {
    lastHeartbeatReceived = Date.now();
    elements.nowPlayingBox.classList.remove("offline");
    elements.offlineIndicator.classList.remove("visible");
    elements.offlineIndicator.style.display = "none";
    isOffline = false;

    if (!isBrowsing) {
      currentVideoTitle = "";
      currentVideoThumbnail = "";
      animateTitle(data.title || "Browsing YouTube");
      elements.videoThumbnailImage.src = "https://www.youtube.com/img/desktop/yt_1200.png";
      elements.videoThumbnailImage.style.display = "block";
      document.querySelector(".thumbnail-container").style.display = "block";
      isBrowsing = true;
      browsingStartTime = Date.now();
      localStorage.setItem("browsingStartTime", browsingStartTime);
    } else {
      if (elements.videoTitle) elements.videoTitle.textContent = data.title || "Browsing YouTube";
      elements.videoThumbnailImage.src = "https://www.youtube.com/img/desktop/yt_1200.png";
    }
    elements.channelName.textContent = "Browsing...";
    elements.viewCount.textContent = "";
    elements.likeCount.textContent = "";
    elements.publishedDate.textContent = "";
    elements.videoCategory.textContent = "";
    const descModal = document.getElementById("descriptionModal");
    if (descModal) {
      descModal.querySelector("p").textContent = data.description || "Browsing videos on YouTube";
      descModal.classList.remove("active");
    }
    updateBrowsingElapsed();
    if (!browsingInterval) browsingInterval = setInterval(updateBrowsingElapsed, 1000);
    elements.liveIndicator.classList.remove("active");
    elements.pauseIndicator.classList.remove("active");
    elements.progressBar.style.width = "0%";
    elements.youtubeSection.classList.remove("fade-out");
    elements.youtubeSection.classList.add("fade-in");
    log("Browsing presence updated in UI.");
    if (elements.toggleDescriptionButton) elements.toggleDescriptionButton.style.display = "block";
  }

  if (localStorage.getItem("browsingStartTime")) {
    browsingStartTime = parseInt(localStorage.getItem("browsingStartTime"));
    isBrowsing = true;
    displayBrowsingPresence({
      presenceType: "browsing",
      title: "Browsing YouTube",
      description: "Browsing videos on YouTube",
      channelTitle: "Browsing...",
      viewCount: "",
      likeCount: "",
      publishedAt: "",
      category: ""
    });
  }

  const socket = io("https://mikumiku.dev");

  socket.on("connect", () => {
    log("Connected to server via Socket.IO.");
    isSessionExpired = false;
    socket.emit("requestLatestData");
  });
  socket.on("disconnect", () => {
    log("Disconnected from server.");
    clearDisplay();
  });
  socket.on("presenceUpdate", data => {
    if (isSessionExpired) {
      log("Ignoring presenceUpdate due to expired session.");
      return;
    }
    log("Received presenceUpdate: " + JSON.stringify(data));
    switch(data.presenceType) {
      case "video":
        if (browsingInterval) clearInterval(browsingInterval);
        browsingInterval = null;
        browsingStartTime = null;
        localStorage.removeItem("browsingStartTime");
        displayVideoPresence(data);
        break;
      case "browsing":
        displayBrowsingPresence(data);
        break;
      case "offline":
      default:
        clearDisplay();
        break;
    }
  });

  setInterval(() => {
    if (!isBuffering && Date.now() - lastHeartbeatReceived > 15000) {
      if (!isOffline) {
        log("No heartbeat received in 15 seconds. Marking as offline.");
        isOffline = true;
        elements.offlineIndicator.classList.add("visible");
        elements.offlineIndicator.style.display = "block";
      }
      clearDisplay();
    }
  }, 5000);
});
</script>
</body>
</html>
