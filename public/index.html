<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikuMiku | Home</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <canvas id="techCanvas"></canvas>

    <div class="page-container">
        <div class="title-bar">
            <div class="container">
                <img src="/logo.webp" alt="Logo" class="logo">
                <h1 class="site-title" id="dynamicTitle">MikuMiku</h1>
            </div>
        </div>

        <div id="main-content" class="main-content">
            <div id="now-playing" class="now-playing">
                <div class="now-playing-sidebar">
                    <div class="sidebar-item">
                        <span>Channel:</span> <span id="channelName">Loading...</span>
                    </div>
                    <div class="sidebar-item">
                        <span>Views:</span> <span id="viewCount">Loading...</span>
                    </div>
                    <div class="sidebar-item">
                        <span>Uploaded:</span> <span id="publishedDate">Loading...</span>
                    </div>
                </div>
            
                <div class="video-section">
                    <div class="video-title-container">
                        <h2>Currently Playing on YouTube</h2>
                        <p id="videoTitle">Loading...</p>
                    </div>
                    
                    <!-- Paused Icon and Progress Bar Container -->
                    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
                        <!-- Paused Icon: Initially hidden -->
                        <span id="pausedIcon" style="display: none; width: 24px; height: 24px;" aria-label="Video Paused" title="Video Paused">
                            <!-- SVG for Pause Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="6" y="5" width="4" height="14"></rect>
                                <rect x="14" y="5" width="4" height="14"></rect>
                            </svg>
                        </span>
                        
                        <!-- Liquid Progress Bar -->
                        <div id="progress-bar-container" style="flex-grow: 1;">
                            <canvas id="liquidProgressBar" width="400" height="50"></canvas>
                        </div>
                    </div>
                    
                    <img id="videoThumbnail" src="" alt="Thumbnail of currently playing video" class="video-thumbnail">
                    
                    <!-- Progress Times and Time Remaining -->
                    <div class="progress-times-container">
                        <p id="time-elapsed" class="progress-time">Time Elapsed: --:--</p>
                        <p id="total-duration" class="progress-time">Total Duration: --:--</p>
                        <p id="time-remaining" class="progress-time" style="display: none;">Browsing for: --:--</p> <!-- Added time-remaining -->
                    </div>

                    <!-- Offline Indicator -->
                    <div id="offline-indicator" style="display: none; color: red; font-weight: bold; margin-top: 1rem;">
                        YouTube is currently offline.
                    </div>
                </div>

                <div class="widgets-container">
                    <div class="live-clock">
                        <h3>My Current Time</h3>
                        <div class="clock-container">
                            <div class="clock">
                                <p id="local-time">--:--:--</p>
                                <p id="current-date">24 Sep 2024</p>
                            </div>
                        </div>
                    </div>

                    <div class="weather-widget">
                        <h3>My Current Weather</h3>
                        <div class="weather-info">
                            <img id="weather-icon" src="" alt="Weather Icon">
                            <p id="weather-description">Loading...</p>
                            <p id="temperature">--Â°C</p>
                            <p id="humidity">Humidity: --%</p>
                            <p id="wind-speed">Wind: -- m/s</p>
                        </div>
                    </div>
                </div>

                <div class="content-wrapper">
                    <div class="now-playing-about-wrapper">
                        <div class="recent-videos-wrapper">
                            <div class="recent-videos-title">
                                <h3>Recently Watched Videos</h3>
                            </div>
                            <div id="recent-videos-container" class="recent-videos-container"></div>
                        </div>

                        <div class="about" id="aboutMe">
                            <div class="container">
                                <h2>About Me</h2>
                                <p>Hey there, I'm Hystoriya, a 24-year-old developer. This is my personal website that I made for no apparent reason. If you find yourself here randomly, then hi :)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div class="container">
                    <p>&copy; 2024 MikuMiku. All rights reserved.</p>
                    <p><a href="/admin-login.html">Admin Login</a></p>
                </div>
            </footer>
        </div>

        <!-- Socket.io and Moment.js Libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

        <!-- Canvas Background Animation Script -->
        <!-- Video and Socket.io Integration Script -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Initialize Socket.io connection
                const socket = io('https://mikumiku.dev'); // Ensure this matches your server URL
        
                // Elements
                const videoTitleElement = document.getElementById('videoTitle');
                const videoThumbnailElement = document.getElementById('videoThumbnail');
                const channelNameElement = document.getElementById('channelName');
                const viewCountElement = document.getElementById('viewCount');
                const publishedDateElement = document.getElementById('publishedDate');
                const offlineIndicator = document.getElementById('offline-indicator');
                const pausedIcon = document.getElementById('pausedIcon');
                const timeElapsedElement = document.getElementById('time-elapsed');
                const totalDurationElement = document.getElementById('total-duration');
                const timeRemainingElement = document.getElementById('time-remaining');
        
                // Variables for tracking video progress
                let videoDuration = 0; // Total duration of the video in seconds
                let videoStartTime = null; // Timestamp when the video started
                let isVideoPaused = true; // Video paused state
        
                // Liquid Progress Bar Setup
                const liquidCanvas = document.getElementById('liquidProgressBar');
                const liquidCtx = liquidCanvas.getContext('2d');
                const liquidWidth = liquidCanvas.width;
                const liquidHeight = liquidCanvas.height;
        
                let progress = 0;
        
                const wave = {
                    amplitude: 10,
                    wavelength: 100,
                    speed: 0.02,
                    phase: 0,
                };
        
                function updateProgress(newProgress) {
                    progress = Math.min(Math.max(newProgress, 0), 100);
                    timeElapsedElement.innerText = `Time Elapsed: ${formatTime((progress / 100) * videoDuration)}`;
                }
        
                function drawLiquidFill() {
                    liquidCtx.clearRect(0, 0, liquidWidth, liquidHeight);
                    const fillLevel = liquidHeight - (progress / 100) * liquidHeight;
        
                    liquidCtx.beginPath();
                    liquidCtx.moveTo(0, fillLevel);
        
                    for (let x = 0; x <= liquidWidth; x++) {
                        const y = wave.amplitude * Math.sin((2 * Math.PI / wave.wavelength) * x + wave.phase) + fillLevel;
                        liquidCtx.lineTo(x, y);
                    }
        
                    liquidCtx.lineTo(liquidWidth, liquidHeight);
                    liquidCtx.lineTo(0, liquidHeight);
                    liquidCtx.closePath();
        
                    const gradient = liquidCtx.createLinearGradient(0, fillLevel - wave.amplitude, 0, liquidHeight);
                    gradient.addColorStop(0, 'rgba(0, 229, 255, 0.6)');
                    gradient.addColorStop(0.5, 'rgba(255, 64, 129, 0.6)');
                    gradient.addColorStop(1, 'rgba(255, 64, 129, 0.6)');
        
                    liquidCtx.fillStyle = gradient;
                    liquidCtx.fill();
        
                    liquidCtx.lineWidth = 2;
                    liquidCtx.strokeStyle = '#00e5ff';
                    liquidCtx.stroke();
                }
        
                function animateLiquidProgressBar() {
                    wave.phase += wave.speed;
                    drawLiquidFill();
                    requestAnimationFrame(animateLiquidProgressBar);
                }
        
                animateLiquidProgressBar();
        
                // Update progress bar
                function updateProgressBar() {
                    if (!isVideoPaused && videoStartTime && videoDuration > 0) {
                        const elapsedTime = (Date.now() - videoStartTime) / 1000;
                        if (elapsedTime >= 0 && elapsedTime <= videoDuration) {
                            const progressPercent = (elapsedTime / videoDuration) * 100;
                            updateProgress(progressPercent);
                        } else {
                            updateProgress(100);
                        }
                    }
                }
        
                // Socket.io Event Handlers
                socket.on('connect', () => {
                    console.log('Connected to server via Socket.io');
                });
        
                socket.on('disconnect', () => {
                    console.log('Disconnected from server');
                });
        
                socket.on('nowPlayingUpdate', (data) => {
                    console.log('Received "nowPlayingUpdate" event:', data);
        
                    if (!data || !data.videoUrl || !data.title) {
                        console.error('Invalid or missing data in "nowPlayingUpdate"');
                        return;
                    }
        
                    const { isOffline, videoUrl, title, currentTime, isPaused, videoDuration: duration } = data;
        
                    // Update video details
                    videoTitleElement.innerText = title;
                    videoThumbnailElement.src = `https://img.youtube.com/vi/${extractYouTubeVideoID(videoUrl)}/hqdefault.jpg`;
        
                    // Update progress and other info
                    videoDuration = duration;
                    videoStartTime = Date.now() - (currentTime * 1000);
                    isVideoPaused = isPaused;
        
                    // Update the interface based on video status
                    if (isPaused) {
                        pausedIcon.style.display = 'inline';
                    } else {
                        pausedIcon.style.display = 'none';
                        setInterval(updateProgressBar, 1000);
                    }
        
                    // Handle offline state
                    if (isOffline) {
                        offlineIndicator.style.display = 'block';
                        videoTitleElement.innerText = 'YouTube Tab Closed';
                    } else {
                        offlineIndicator.style.display = 'none';
                    }
        
                    // Clear any old intervals for updating progress
                    clearExistingInterval();
                });
        
                function extractYouTubeVideoID(url) {
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|youtube.com\/shorts\/)([^#&?]*).*/;
                    const match = url.match(regExp);
                    return (match && match[2].length === 11) ? match[2] : null;
                }
        
                function clearExistingInterval() {
                    if (window.progressInterval) {
                        clearInterval(window.progressInterval);
                        window.progressInterval = null;
                    }
                }
        
                function formatTime(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                }
        
            });
        </script>

    </body>
</html>
