<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikuMiku | Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <canvas id="techCanvas"></canvas>

    <div class="page-container">
        <!-- Title Bar with Dropdown -->
        <div class="title-bar">
            <div class="container">
                <!-- Left Section: Empty for Spacing -->
                <div class="left-section">
                    <!-- Reserved for future use or keep empty -->
                </div>

                <!-- Center Section: Logo and Title -->
                <div class="center-section">
                    <div class="logo-title-wrapper">
                        <img src="/logo.webp" alt="Logo" class="logo">
                        <h1 class="site-title" id="dynamicTitle">MikuMiku</h1>
                    </div>
                </div>

                <!-- Right Section: Personality Circle and Dropdown -->
                <div class="right-section">
                    <div class="personality-section">
                        <div id="personalityCircle" class="personality-circle"></div>

                        <!-- Speech Bubble Positioned Under the Circle -->
                        <div id="personalityTextBox" class="personality-text-box">
                            <div id="personalityPhrase" class="personality-text-wrapper"></div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="dropdown-button">Menu</button>
                        <div class="dropdown-content">
                            <a href="/admin-login.html">Admin Login</a>
                            <!-- Add more dropdown links here if needed -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="main-content">
            <!-- Now Playing Section -->
            <div id="now-playing-container" class="now-playing-container">
                <div id="now-playing" class="now-playing">
                    <div class="now-playing-sidebar">
                        <div class="sidebar-item">
                            <span>Channel:</span> <span id="channelName">Loading...</span>
                        </div>
                        <div class="sidebar-item">
                            <span>Views:</span> <span id="viewCount">Loading...</span>
                        </div>
                        <div class="sidebar-item">
                            <span>Uploaded:</span> <span id="publishedDate">Loading...</span>
                        </div>
                    </div>

                    <div class="video-section">
                        <div class="video-title-container">
                            <h2>Currently Playing on YouTube</h2>
                            <p id="videoTitle">Loading...</p>
                        </div>

                        <div class="progress-bar-wrapper">
                            <span id="pausedIcon" class="paused-icon" aria-label="Video Paused" title="Video Paused">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                    <rect x="6" y="5" width="4" height="14"></rect>
                                    <rect x="14" y="5" width="4" height="14"></rect>
                                </svg>
                            </span>

                            <div id="progress-bar" class="progress-bar"></div>
                        </div>

                        <img id="videoThumbnail" src="" alt="Thumbnail of currently playing video" class="video-thumbnail">

                        <div class="progress-times-container">
                            <p id="time-elapsed" class="progress-time">Time Elapsed: --:--</p>
                            <p id="total-duration" class="progress-time">Total Duration: --:--</p>
                            <p id="time-remaining" class="progress-time" style="display: none;">Browsing for: --:--</p>
                        </div>

                        <div id="offline-indicator" class="offline-indicator" style="display: none;">
                            I’m not on YouTube at the moment, soz :(
                        </div>
                    </div>
                </div>
            </div>
            <!-- Widgets Section -->
            <div class="widgets-container">
                <div class="live-clock box-container">
                    <h3>My Current Time</h3>
                    <div class="clock-container">
                        <div class="clock">
                            <p id="local-time">--:--:--</p>
                            <p id="current-date">24 Sep 2024</p>
                        </div>
                    </div>
                </div>

                <div class="weather-widget box-container">
                    <h3>My Current Weather</h3>
                    <div class="weather-info">
                        <img id="weather-icon" src="" alt="Weather Icon">
                        <p id="weather-description">Loading...</p>
                        <p id="temperature">--°C</p>
                        <p id="humidity">Humidity: --%</p>
                        <p id="wind-speed">Wind: -- m/s</p>
                    </div>
                </div>
            </div>

            <!-- Recently Watched Videos Section -->
            <div class="content-wrapper">
                <div class="now-playing-about-wrapper">
                    <div class="recent-videos-wrapper box-container">
                        <h3>Recently Watched Videos</h3>
                        <div id="recent-videos-container" class="recent-videos-container"></div>
                    </div>

                    <div class="about box-container" id="aboutMe">
                        <h2>About Me</h2>
                        <p>Hey there, I'm Hystoriya, a 24-year-old developer. This is my personal website that I made for no apparent reason. If you find yourself here randomly, then hi :)</p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <p>&copy; 2024 MikuMiku. All rights reserved.</p>
            </div>
        </footer>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

    <script src="haru.js"></script>

    <script>
        // Time of Day Dynamic Title
        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour < 12) {
                return "Good Morning";
            } else if (hour >= 12 && hour < 18) {
                return "Good Afternoon";
            } else {
                return "Good Evening";
            }
        }

        function setDynamicTitle() {
            const originalTitle = document.title;
            const timeOfDayMessage = getTimeOfDay();

            document.title = timeOfDayMessage;

            const dynamicTitleElement = document.getElementById('dynamicTitle');
            if (dynamicTitleElement) {
                dynamicTitleElement.innerText = timeOfDayMessage;
            }

            setTimeout(() => {
                document.title = originalTitle;
                if (dynamicTitleElement) {
                    dynamicTitleElement.innerText = "MikuMiku"; 
                }
            }, 5000);
        }

        setDynamicTitle();

        document.addEventListener("visibilitychange", function () {
            if (!document.hidden) {
                setDynamicTitle();
            }
        });
    </script>

    <script>

    document.addEventListener('DOMContentLoaded', function () {
        let intervalID = null;
        let videoStartTime = null;
        let videoDuration = 0;
        let isVideoPaused = true;
        let isBrowsing = false;
        const MAX_RECENT_VIDEOS = 3;
        let previousVideoData = null;

        const YOUTUBE_API_URL = '/api/youtube';
        const WEATHER_API_URL = '/api/weather';
        const CITY_NAME = 'Leeds';

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function clearExistingInterval() {
            if (intervalID) {
                clearInterval(intervalID);
                intervalID = null;
            }
        }

        async function fetchYouTubeVideoDetails(videoID) {
            try {
                const response = await fetch(`${YOUTUBE_API_URL}?videoId=${videoID}`);
                const data = await response.json();

                if (data.error) {
                    console.error(data.error);
                    return 0;
                }

                if (data && data.items && data.items.length > 0) {
                    const video = data.items[0];
                    const snippet = video.snippet;
                    const stats = video.statistics;
                    const durationISO = video.contentDetails.duration;

                    videoDuration = moment.duration(durationISO).asSeconds();
                    const formattedDuration = formatTime(videoDuration);

                    document.getElementById('videoTitle').innerText = snippet.title;
                    document.getElementById('channelName').innerText = snippet.channelTitle;
                    document.getElementById('publishedDate').innerText = new Date(snippet.publishedAt).toLocaleDateString();

                    const viewsFormatted = Number(stats.viewCount).toLocaleString();
                    document.getElementById('viewCount').innerText = `${viewsFormatted} views`;

                    document.getElementById('videoThumbnail').src = snippet.thumbnails.high.url;
                    document.getElementById('total-duration').innerText = `Total Duration: ${formattedDuration}`;

                    return videoDuration;
                } else {
                    console.error('No video data found for the provided videoId.');
                    return 0;
                }
            } catch (error) {
                console.error('Error fetching video details:', error);
            }
            return 0;
        }

        function updateRecentVideosUI(recentVideos) {
            const recentVideosContainer = document.getElementById('recent-videos-container');
            recentVideosContainer.innerHTML = '';
            recentVideos.forEach((video, index) => {
                const videoElement = document.createElement('div');
                videoElement.className = 'recent-video-item advanced-video-card';
                videoElement.style.animationDelay = `${index * 0.1}s`;
                videoElement.innerHTML = `
                    <a href="${video.url}" target="_blank">
                        <div class="card-content">
                            <img src="${video.thumbnail}" class="recent-video-thumbnail" alt="Thumbnail of ${video.title}">
                            <p class="recent-video-title">${video.title}</p>
                        </div>
                    </a>`;
                recentVideosContainer.appendChild(videoElement);
            });
        }

        function addVideoToRecent(title, url, thumbnail) {
            let recentVideos = JSON.parse(localStorage.getItem('recentVideos')) || [];
            if (!recentVideos.find(video => video.url === url)) {
                recentVideos.unshift({ title, url, thumbnail });
                if (recentVideos.length > MAX_RECENT_VIDEOS) {
                    recentVideos = recentVideos.slice(0, MAX_RECENT_VIDEOS);
                }
                localStorage.setItem('recentVideos', JSON.stringify(recentVideos));
                updateRecentVideosUI(recentVideos);
            }
        }

        const recentVideos = JSON.parse(localStorage.getItem('recentVideos')) || [];
        updateRecentVideosUI(recentVideos);

        // Initialize Socket.io
        const socket = io();

        socket.on('connect', () => {
            console.log('Frontend connected to server via Socket.io');
        });

        socket.on('disconnect', () => {
            console.log('Frontend disconnected from server');
        });

        socket.on('nowPlayingUpdate', (data) => {
            const { isOffline, videoUrl, title, currentTime, isPaused } = data;

            const videoTitleElement = document.getElementById('videoTitle');
            const videoThumbnailElement = document.getElementById('videoThumbnail');
            const nowPlayingElement = document.querySelector('.now-playing');
            const offlineIndicator = document.getElementById('offline-indicator');
            const pausedIcon = document.getElementById('pausedIcon');

            if (isOffline) {
                videoTitleElement.innerText = 'YouTube Tab Closed';
                nowPlayingElement.classList.add('offline');
                videoThumbnailElement.classList.add('offline-thumbnail');
                clearExistingInterval();
                updateProgressBar(0); // Reset progress bar
                document.getElementById('time-elapsed').innerText = `Time Elapsed: --:--`;
                document.getElementById('total-duration').innerText = `Total Duration: --:--`;
                pausedIcon.style.display = 'none';
                const timeRemaining = document.getElementById('time-remaining');
                if (timeRemaining) {
                    timeRemaining.style.display = 'none';
                }
                offlineIndicator.style.display = 'block';
            } else {
                nowPlayingElement.classList.remove('offline');
                videoThumbnailElement.classList.remove('offline-thumbnail');
                offlineIndicator.style.display = 'none';

                const videoID = extractYouTubeVideoID(videoUrl);
                if (!videoID) {
                    return;
                }

                if (previousVideoData && previousVideoData.url !== videoUrl) {
                    addVideoToRecent(previousVideoData.title, previousVideoData.url, previousVideoData.thumbnail);
                }

                previousVideoData = {
                    title: title || 'No video playing',
                    url: videoUrl,
                    thumbnail: `https://img.youtube.com/vi/${videoID}/hqdefault.jpg`
                };

                videoTitleElement.innerText = previousVideoData.title;
                videoThumbnailElement.src = previousVideoData.thumbnail;
                videoThumbnailElement.alt = previousVideoData.title;

                if (videoUrl.includes("youtube.com/") && !videoUrl.includes("/watch")) {
                    clearExistingInterval();
                    isBrowsing = true;
                    updateProgressBar(0); // Reset progress bar
                    document.getElementById('time-elapsed').innerText = `Time Elapsed: --:--`;
                    document.getElementById('total-duration').innerText = `Total Duration: --:--`;
                    pausedIcon.style.display = 'none';
                    const timeRemaining = document.getElementById('time-remaining');
                    if (timeRemaining) {
                        timeRemaining.style.display = 'none';
                    }
                } else {
                    isBrowsing = false;
                    fetchYouTubeVideoDetails(videoID).then((duration) => {
                        if (duration) {
                            videoDuration = duration;
                            videoStartTime = Date.now() - (currentTime * 1000);
                            clearExistingInterval();
                            isVideoPaused = isPaused;
                            if (!isVideoPaused) {
                                intervalID = setInterval(updateProgressBar, 1000);
                            }
                            document.getElementById('total-duration').innerText = `Total Duration: ${formatTime(videoDuration)}`;
                            const timeRemaining = document.getElementById('time-remaining');
                            if (timeRemaining) {
                                timeRemaining.style.display = 'none';
                            }
                        }
                    });
                }

                if (isPaused) {
                    pausedIcon.style.display = 'inline';
                } else {
                    pausedIcon.style.display = 'none';
                }
            }
        });

        function extractYouTubeVideoID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|youtube\.com\/shorts\/)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Live Clock
        function updateClocks() {
            const now = new Date();
            const localTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('local-time').textContent = localTime;
            const currentDate = now.toLocaleDateString(undefined, { day: '2-digit', month: 'short', year: 'numeric' });
            document.getElementById('current-date').textContent = currentDate;
        }

        setInterval(updateClocks, 1000);
        updateClocks();

        // Weather Fetching
        async function fetchWeather() {
            try {
                const response = await fetch(`${WEATHER_API_URL}?city=${encodeURIComponent(CITY_NAME)}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                displayWeather(data);
            } catch (error) {
                console.error('Error fetching weather data:', error);
                document.getElementById('weather-description').innerText = 'Unable to fetch weather data.';
                document.getElementById('temperature').innerText = '';
                document.getElementById('humidity').innerText = '';
                document.getElementById('wind-speed').innerText = '';
            }
        }

        function displayWeather(data) {
            if (!data || !data.weather) {
                document.getElementById('weather-description').innerText = 'Weather data unavailable.';
                return;
            }

            const description = data.weather[0].description;
            const temperature = Math.round(data.main.temp);
            const humidity = data.main.humidity;
            const windSpeed = data.wind.speed;
            const iconCode = data.weather[0].icon;
            const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
            const weatherMain = data.weather[0].main.toLowerCase();

            document.getElementById('weather-description').innerText = `Condition: ${description}`;
            document.getElementById('temperature').innerText = `Temperature: ${temperature}°C`;
            document.getElementById('humidity').innerText = `Humidity: ${humidity}%`;
            document.getElementById('wind-speed').innerText = `Wind: ${windSpeed} m/s`;

            let iconElement = document.getElementById('weather-icon');
            if (!iconElement) {
                iconElement = document.createElement('img');
                iconElement.id = 'weather-icon';
                iconElement.alt = 'Weather Icon';
                document.querySelector('.weather-info').prepend(iconElement);
            }
            iconElement.src = iconUrl;
            iconElement.style.display = 'block';
        }

        fetchWeather();
        setInterval(fetchWeather, 3600000); // Refresh weather every hour


        // Function to update the progress bar and time elapsed
        function updateProgressBarAndTime() {
            const videoPlayer = document.querySelector('video');
            const progressBar = document.getElementById('progress-bar');
            const timeElapsed = document.getElementById('time-elapsed');

            if (videoPlayer && progressBar && timeElapsed) {
                const currentTime = videoPlayer.currentTime;
                const duration = videoPlayer.duration;

                if (duration > 0) {
                    const progressPercent = (currentTime / duration) * 100;
                    progressBar.style.width = `${progressPercent}%`;
                    timeElapsed.innerText = `Time Elapsed: ${formatTime(currentTime)}`;
                    console.log(`Updated progress bar. Current time: ${currentTime}, Progress: ${progressPercent}%`);
                } else {
                    console.warn('Video duration is zero or undefined.');
                }
            } else {
                console.warn('Progress bar or time elements not found.');
            }
        }

        // Animation Loop for Video Progress
        function updateProgressBar() {
            if (!isVideoPaused && !isBrowsing && videoDuration > 0) {
                const currentTimestamp = Date.now();
                const elapsedTime = (currentTimestamp - videoStartTime) / 1000;
                if (elapsedTime >= 0 && elapsedTime <= videoDuration) {
                    const progressPercent = (elapsedTime / videoDuration) * 100;
                    // Update the progress bar width
                    const progressBar = document.getElementById('progress-bar');
                    if (progressBar) {
                        progressBar.style.width = `${progressPercent}%`;
                    }
                    // Update the time elapsed text
                    const timeElapsed = document.getElementById('time-elapsed');
                    if (timeElapsed) {
                        timeElapsed.innerText = `Time Elapsed: ${formatTime(elapsedTime)}`;
                    }
                } else {
                    clearExistingInterval();
                    // Set progress bar to 100%
                    const progressBar = document.getElementById('progress-bar');
                    if (progressBar) {
                        progressBar.style.width = `100%`;
                    }
                    const timeElapsed = document.getElementById('time-elapsed');
                    if (timeElapsed) {
                        timeElapsed.innerText = `Time Elapsed: ${formatTime(videoDuration)}`;
                    }
                }
            }
        }

        // Handle Dynamic Prompts from Server
        socket.on('dynamicPrompt', (data) => {
            const promptContainer = document.getElementById('dynamic-prompt-container');
            const promptText = document.getElementById('dynamic-prompt-text');

            promptText.innerText = data.message || "A new prompt has arrived!";
            promptContainer.style.display = 'block';

            setTimeout(() => {
                promptContainer.style.display = 'none';
            }, 5000);

            document.getElementById('close-prompt').addEventListener('click', () => {
                promptContainer.style.display = 'none';
            });
        });

        // Log All Socket Events (Optional for Debugging)
        socket.onAny((event, data) => {
            console.log(`Received event: ${event}, Data:`, data);
        });
    });
</script>

</body>
</html>

