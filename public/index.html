<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikuMiku | Home</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <canvas id="techCanvas"></canvas>

    <div class="page-container">
        <div class="title-bar">
            <div class="container">
                <img src="/logo.webp" alt="Logo" class="logo">
                <h1 class="site-title" id="dynamicTitle">MikuMiku</h1>
            </div>
        </div>

        <div id="main-content" class="main-content">
            <div id="now-playing" class="now-playing">
                <div class="now-playing-sidebar">
                    <div class="sidebar-item">
                        <span>Channel:</span> <span id="channelName">Loading...</span>
                    </div>
                    <div class="sidebar-item">
                        <span>Views:</span> <span id="viewCount">Loading...</span>
                    </div>
                    <div class="sidebar-item">
                        <span>Uploaded:</span> <span id="publishedDate">Loading...</span>
                    </div>
                </div>
            
                <div class="video-section">
                    <div class="video-title-container">
                        <h2>Currently Playing on YouTube</h2>
                        <p id="videoTitle">Loading...</p>
                    </div>
                    
                    <!-- Paused Icon and Progress Bar Container -->
                    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
                        <span id="pausedIcon" style="display: none; width: 24px; height: 24px;" aria-label="Video Paused" title="Video Paused">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="6" y="5" width="4" height="14"></rect>
                                <rect x="14" y="5" width="4" height="14"></rect>
                            </svg>
                        </span>
                        
                        <!-- Liquid Progress Bar -->
                        <div id="progress-bar-container" style="flex-grow: 1;">
                            <canvas id="liquidProgressBar" width="400" height="50"></canvas>
                        </div>
                    </div>
                    
                    <img id="videoThumbnail" src="" alt="Thumbnail of currently playing video" class="video-thumbnail">
                    
                    <div class="progress-times-container">
                        <p id="time-elapsed" class="progress-time">Time Elapsed: --:--</p>
                        <p id="total-duration" class="progress-time">Total Duration: --:--</p>
                    </div>

                    <div id="offline-indicator" style="display: none; color: red; font-weight: bold; margin-top: 1rem;">
                        YouTube is currently offline.
                    </div>
                </div>

                <div class="widgets-container">
                    <div class="live-clock">
                        <h3>My Current Time</h3>
                        <div class="clock-container">
                            <div class="clock">
                                <p id="local-time">--:--:--</p>
                                <p id="current-date">24 Sep 2024</p>
                            </div>
                        </div>
                    </div>

                    <div class="weather-widget">
                        <h3>My Current Weather</h3>
                        <div class="weather-info">
                            <img id="weather-icon" src="" alt="Weather Icon">
                            <p id="weather-description">Loading...</p>
                            <p id="temperature">--°C</p>
                            <p id="humidity">Humidity: --%</p>
                            <p id="wind-speed">Wind: -- m/s</p>
                        </div>
                    </div>
                </div>

                <div class="content-wrapper">
                    <div class="now-playing-about-wrapper">
                        <div class="recent-videos-wrapper">
                            <div class="recent-videos-title">
                                <h3>Recently Watched Videos</h3>
                            </div>
                            <div id="recent-videos-container" class="recent-videos-container"></div>
                        </div>

                        <div class="about" id="aboutMe">
                            <div class="container">
                                <h2>About Me</h2>
                                <p>Hey there, I'm Hystoriya, a 24-year-old developer. This is my personal website that I made for no apparent reason. If you find yourself here randomly, then hi :)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div class="container">
                    <p>&copy; 2024 MikuMiku. All rights reserved.</p>
                    <p><a href="/admin-login.html">Admin Login</a></p>
                </div>
            </footer>
        </div>

        <!-- Socket.io and Moment.js Libraries -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

        <!-- Canvas Background Animation Script -->
        <script>
            const canvas = document.getElementById('techCanvas');
            const ctx = canvas.getContext('2d');

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            const techBlue = '#00e5ff';
            const techPurple = '#7e57ff';
            const techPink = '#ff4081';
            const techCyan = '#00ffff';
            const techGray = '#4b4b4b';

            const mouse = {
                x: null,
                y: null,
                radius: 100
            };

            window.addEventListener('mousemove', function(event) {
                mouse.x = event.clientX;
                mouse.y = event.clientY;
            });

            class Node {
                constructor(x, y, radius, color) {
                    this.x = x;
                    this.y = y;
                    this.radius = radius;
                    this.color = color;
                    this.alpha = Math.random() * 0.5 + 0.5;
                    this.speedX = (Math.random() - 0.5) * 0.2;
                    this.speedY = (Math.random() - 0.5) * 0.2;
                }

                update() {
                    const dx = this.x - mouse.x;
                    const dy = this.y - mouse.y;
                    const distance = Math.hypot(dx, dy);

                    if (distance < mouse.radius && mouse.x && mouse.y) {
                        const angle = Math.atan2(dy, dx);
                        const force = (mouse.radius - distance) / mouse.radius;
                        const forceX = Math.cos(angle) * force * 2;
                        const forceY = Math.sin(angle) * force * 2;

                        this.x += this.speedX + forceX;
                        this.y += this.speedY + forceY;
                    } else {
                        this.x += this.speedX;
                        this.y += this.speedY;
                    }

                    // Wrap around the canvas edges
                    if (this.x > canvas.width) this.x = 0;
                    if (this.x < 0) this.x = canvas.width;
                    if (this.y > canvas.height) this.y = 0;
                    if (this.y < 0) this.y = canvas.height;
                }

                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${hexToRgb(this.color)}, ${this.alpha})`;
                    ctx.fill();
                }
            }

            function hexToRgb(hex) {
                const bigint = parseInt(hex.replace('#',''), 16);
                const r = (bigint >> 16) & 255;
                const g = (bigint >> 8) & 255;
                const b = bigint & 255;
                return `${r}, ${g}, ${b}`;
            }

            const nodes = [];
            const nodeCount = 150;

            for (let i = 0; i < nodeCount; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const radius = Math.random() * 2 + 1;
                const colorOptions = [techBlue, techPurple, techPink, techCyan, techGray];
                const color = colorOptions[Math.floor(Math.random() * colorOptions.length)];
                nodes.push(new Node(x, y, radius, color));
            }

            function connectNodes() {
                const maxDistance = 120;
                for (let i = 0; i < nodes.length; i++) {
                    for (let j = i + 1; j < nodes.length; j++) {
                        const dx = nodes[i].x - nodes[j].x;
                        const dy = nodes[i].y - nodes[j].y;
                        const distance = Math.hypot(dx, dy);
                        if (distance < maxDistance) {
                            ctx.beginPath();
                            ctx.strokeStyle = `rgba(${hexToRgb('#00e5ff')}, ${1 - distance / maxDistance})`;
                            ctx.lineWidth = 0.5;
                            ctx.moveTo(nodes[i].x, nodes[i].y);
                            ctx.lineTo(nodes[j].x, nodes[j].y);
                            ctx.stroke();
                        }
                    }
                }
            }

            function animateBackground() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                nodes.forEach(node => {
                    node.update();
                    node.draw();
                });
                connectNodes();
                requestAnimationFrame(animateBackground);
            }

            animateBackground();
        </script>

        <!-- Dynamic Title Script -->
        <script>
            function getTimeOfDay() {
                const hour = new Date().getHours();
                if (hour < 12) {
                    return "Good Morning";
                } else if (hour >= 12 && hour < 18) {
                    return "Good Afternoon";
                } else {
                    return "Good Evening";
                }
            }

            function setDynamicTitle() {
                const originalTitle = document.title;
                const timeOfDayMessage = getTimeOfDay();

                document.title = timeOfDayMessage;

                const dynamicTitleElement = document.getElementById('dynamicTitle');
                if (dynamicTitleElement) {
                    dynamicTitleElement.innerText = timeOfDayMessage;
                }

                setTimeout(() => {
                    document.title = originalTitle;
                    if (dynamicTitleElement) {
                        dynamicTitleElement.innerText = "MikuMiku"; 
                    }
                }, 5000);
            }

            setDynamicTitle();

            document.addEventListener("visibilitychange", function () {
                if (!document.hidden) {
                    setDynamicTitle();
                }
            });
        </script>

        <!-- Video and Socket.io Integration Script -->
        <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // Fetch API keys from the server
            let apiKeys = {};

            try {
                const response = await fetch('/api/keys');
                apiKeys = await response.json();
            } catch (error) {
                console.error('Error fetching API keys:', error);
            }

            const YOUTUBE_API_KEY = apiKeys.YOUTUBE_API_KEY;
            const OPENWEATHERMAP_API_KEY = apiKeys.OPENWEATHER_API_KEY;
            const CITY_NAME = 'Leeds';

            // Socket.io integration
            const socket = io('https://mikumiku.dev');

            const videoTitleElement = document.getElementById('videoTitle');
            const videoThumbnailElement = document.getElementById('videoThumbnail');
            const channelNameElement = document.getElementById('channelName');
            const viewCountElement = document.getElementById('viewCount');
            const publishedDateElement = document.getElementById('publishedDate');
            const offlineIndicator = document.getElementById('offline-indicator');
            const pausedIcon = document.getElementById('pausedIcon');
            const timeElapsedElement = document.getElementById('time-elapsed');
            const totalDurationElement = document.getElementById('total-duration');

            socket.on('nowPlayingUpdate', (data) => {
                const { isOffline, videoUrl, title, currentTime, isPaused } = data;
                if (isOffline) {
                    offlineIndicator.style.display = 'block';
                    videoTitleElement.innerText = 'YouTube Tab Closed';
                } else {
                    offlineIndicator.style.display = 'none';
                    videoTitleElement.innerText = title;
                    videoThumbnailElement.src = `https://img.youtube.com/vi/${extractYouTubeVideoID(videoUrl)}/hqdefault.jpg`;
                    pausedIcon.style.display = isPaused ? 'inline' : 'none';
                }
            });

            // Fetch YouTube video details using the API key from backend
            async function fetchYouTubeVideoDetails(videoID) {
                const apiUrl = `https://www.googleapis.com/youtube/v3/videos?id=${videoID}&part=snippet,contentDetails,statistics&key=${YOUTUBE_API_KEY}`;
                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    if (data.items.length > 0) {
                        const videoData = data.items[0];
                        const snippet = videoData.snippet;
                        const stats = videoData.statistics;
                        videoTitleElement.innerText = snippet.title;
                        channelNameElement.innerText = snippet.channelTitle;
                        viewCountElement.innerText = `${Number(stats.viewCount).toLocaleString()} views`;
                        publishedDateElement.innerText = new Date(snippet.publishedAt).toLocaleDateString();
                    }
                } catch (error) {
                    console.error('Error fetching YouTube video details:', error);
                }
            }

            function extractYouTubeVideoID(url) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|youtube.com\/shorts\/)([^#&?]*).*/;
                const match = url.match(regExp);
                return match && match[2].length === 11 ? match[2] : null;
            }

            // Fetch weather using OpenWeather API key from backend
            async function fetchWeather() {
                const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${CITY_NAME}&units=metric&appid=${OPENWEATHERMAP_API_KEY}`;
                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    displayWeather(data);
                } catch (error) {
                    console.error('Error fetching weather data:', error);
                }
            }

            function displayWeather(data) {
                if (data && data.weather) {
                    const description = data.weather[0].description;
                    const temperature = Math.round(data.main.temp);
                    document.getElementById('weather-description').innerText = `Condition: ${description}`;
                    document.getElementById('temperature').innerText = `Temperature: ${temperature}°C`;
                }
            }

            fetchWeather();
            setInterval(fetchWeather, 3600000); // Update weather every hour
        });
        </script>
    </body>
</html>
