      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Miku.dev | Home</title>
      
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
        <link rel="stylesheet" href="/styles.css"/>
      
        <style>
          .status-box{position:relative}
          .status-box.live.active::before{left:50%}
          .weather-ambient{display:none}
      
          #loadingScreen{
            position:fixed;
            inset:0;
            z-index:9999;
            display:grid;
            place-items:center;
            background:linear-gradient(to right top,#F27121,#E94057,#8A2387);
            animation:fadeOut .6s ease forwards;
            animation-delay:3s;
          }
      
          #siteContent{
            opacity:0;
            animation:fadeIn .6s ease forwards;
            animation-delay:3s;
          }
      
          @keyframes fadeOut{
            to{opacity:0;pointer-events:none}
          }
      
          @keyframes fadeIn{
            to{opacity:1}
          }
        </style>
      </head>
      
      <body>
      
        <div id="loadingScreen">
          <i class="loader loader--8"></i>
        </div>

      
        <div id="siteContent">
      
          <canvas id="soundWaveCanvas" aria-hidden="true"></canvas>
      
          <div class="weather-ambient" aria-hidden="true">
            <div class="ambient-layer" id="ambientLayer"></div>
          </div>
      
          <div class="idle-overlay" id="idleOverlay">
            <div class="idle-orbs" id="idleOrbs"></div>
          </div>
      
          <div class="konami" id="konamiBox">ミクはいつもここにいるよ ♪</div>
      
          <div class="page-container" id="pageContainer">
      
            <header class="title-bar" id="titleBar">
              <div class="container">
      
                <div class="left-section"></div>
      
                <div class="title-wrapper">
                  <a href="/" aria-label="Home" class="logo-link">
                    <span class="site-title">Miku.dev</span>
      
                    <div class="visualizer-wrapper">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 100" class="visualizer">
                        <g>
                          <rect x="10" y="70" width="15" height="30" fill="#00c6ff">
                            <animate attributeName="height" values="30;60;30" dur="0.8s" repeatCount="indefinite"/>
                            <animate attributeName="y" values="70;40;70" dur="0.8s" repeatCount="indefinite"/>
                          </rect>
                          <rect x="35" y="60" width="15" height="40" fill="#ff4081">
                            <animate attributeName="height" values="40;80;40" dur="1s" repeatCount="indefinite"/>
                            <animate attributeName="y" values="60;20;60" dur="1s" repeatCount="indefinite"/>
                          </rect>
                          <rect x="60" y="80" width="15" height="20" fill="#00c6ff">
                            <animate attributeName="height" values="20;50;20" dur="0.6s" repeatCount="indefinite"/>
                            <animate attributeName="y" values="80;50;80" dur="0.6s" repeatCount="indefinite"/>
                          </rect>
                          <rect x="85" y="50" width="15" height="50" fill="#ff4081">
                            <animate attributeName="height" values="50;90;50" dur="1.2s" repeatCount="indefinite"/>
                            <animate attributeName="y" values="50;10;50" dur="1.2s" repeatCount="indefinite"/>
                          </rect>
                          <rect x="110" y="70" width="15" height="30" fill="#00c6ff">
                            <animate attributeName="height" values="30;60;30" dur="0.9s" repeatCount="indefinite"/>
                            <animate attributeName="y" values="70;40;70" dur="0.9s" repeatCount="indefinite"/>
                          </rect>
                          <rect x="135" y="60" width="15" height="40" fill="#ff4081">
                            <animate attributeName="height" values="40;80;40" dur="1.1s" repeatCount="indefinite"/>
                            <animate attributeName="y" values="60;20;60" dur="1.1s" repeatCount="indefinite"/>
                          </rect>
                        </g>
                      </svg>
                    </div>
                  </a>
                </div>
      
                <div class="right-section">
                  <button class="menu-button" id="menuButton" aria-label="Open Menu">
                    <i class="fas fa-music"></i>
                  </button>
                </div>
      
              </div>
            </header>
      
          </div>
        </div>
      
        <script>
          setTimeout(()=>{
            document.getElementById("loadingScreen").remove()
          },3000)
        </script>
      
      </body>
      </html>


      <nav class="overlay-menu" id="overlayMenu">
        <button class="close-overlay" id="closeOverlay" aria-label="Close Menu">
          <i class="fas fa-times"></i>
        </button>
        <div class="overlay-content">
          <a href="/auth" aria-label="Admin Login"><i class="fas fa-user-lock"></i> Admin Login</a>
          <a href="#aboutMe" aria-label="About Me"><i class="fas fa-info-circle"></i> About Me</a>
          <div class="personality-options">
            <button id="personalityOption1" class="personality-button"><i class="fas fa-music"></i> Melody</button>
            <button id="personalityOption2" class="personality-button"><i class="fas fa-headphones"></i> Harmony</button>
            <button id="personalityOption3" class="personality-button"><i class="fas fa-microphone"></i> Rhythm</button>
          </div>
        </div>
      </nav>

      <section class="now-playing-container">
        <div class="now-playing-card" id="nowPlayingCard">
          <div class="now-playing-grid">
            <div class="video-info">
              <div class="info-item"><i class="fas fa-tv"></i><span id="channelName">Loading…</span></div>
              <div class="info-item"><i class="fas fa-eye"></i><span id="viewCount">Loading…</span></div>
              <div class="info-item"><i class="fas fa-thumbs-up"></i><span id="likeCount">Loading…</span></div>
              <div class="info-item"><i class="fas fa-calendar-day"></i><span id="publishedDate">Loading…</span></div>
              <div class="info-item"><i class="fas fa-tag"></i><span id="videoCategory">Loading…</span></div>
            </div>

            <div class="time-info">
              <div class="greeting-container">
                <p class="greeting"><i class="fas fa-sun"></i> <span id="greeting-text">Good Morning!</span></p>
              </div>
              <div class="clock-container">
                <div class="digital-clock">
                  <p id="local-time"><i class="fas fa-clock"></i> 00:00:00</p>
                  <p id="current-date"><i class="fas fa-calendar-alt"></i> 1 January 2025</p>
                  <p id="day-of-week"><i class="fas fa-calendar-day"></i> Wednesday</p>
                  <p id="time-zone"><i class="fas fa-globe"></i> UTC</p>
                </div>
              </div>
            </div>

            <div class="youtube-section" id="youtubeSection" style="position: relative;">
              <div class="transition-layer" id="ytTransition"></div>
              <div class="video-thumb">
                <img id="videoThumbnailImage" class="thumb-img" src="" alt="Thumbnail" loading="lazy"/>
                <div id="thumbSkeleton" class="skeleton" style="position:absolute;inset:0;display:none;"></div>
              </div>
              <div class="video-details">
                <h3 class="animate-in">Currently Playing</h3>
                <p id="videoTitle" class="animate-in delay-1">Loading…</p>
                <div class="progress-bar animate-in delay-2">
                  <div id="progressBar"></div>
                  <div class="progress-hover" id="progressHover" style="position:absolute;inset:0"></div>
                </div>
                <div class="animate-in delay-3">
                  <button id="toggleDescriptionButton"><i class="fas fa-info-circle"></i> Show Description</button>
                  <button id="openStats" class="btn-stats" style="margin-left:.5rem"><i class="fas fa-chart-line"></i><span class="label">Stats</span></button>
                </div>

                <div id="backdrop" class="backdrop" aria-hidden="true"></div>
                <div id="descriptionModal" class="modal-description" role="dialog" aria-modal="true" aria-labelledby="descriptionModalTitle" aria-describedby="descriptionModalDescription">
                  <h4 id="descriptionModalTitle">Description</h4>
                  <p id="descriptionModalDescription">Loading description…</p>
                </div>

                <div id="statsModal" class="modal-description" role="dialog" aria-modal="true" aria-labelledby="statsModalTitle">
                  <h4 id="statsModalTitle">Listening Stats</h4>
                  <div class="stats-grid">
                    <div class="stat-card"><div>Total Plays</div><div id="statTotal" style="font-size:1.6rem;font-weight:800">0</div></div>
                    <div class="stat-card"><div>Total Time</div><div id="statTime" style="font-size:1.2rem;font-weight:800">0m</div></div>
                    <div class="stat-card"><div>Unique Channels</div><div id="statChannels" style="font-size:1.6rem;font-weight:800">0</div></div>
                  </div>
                  <h5 style="margin-top:.8rem">Top Channels</h5>
                  <div id="topChannels" class="top-list"></div>
                  <h5 style="margin-top:.8rem">Top Videos</h5>
                  <div id="topVideos" class="top-list"></div>
                </div>

                <div id="titleSkeleton" class="skeleton title" style="margin-top:.5rem;display:none;"></div>
                <div id="lineSkeleton" class="skeleton line" style="margin-top:.5rem;display:none;"></div>
              </div>

              <div class="status-boxes">
                <div id="liveIndicator" class="status-box live">Live</div>
                <div id="pauseIndicator" class="status-box paused">Paused</div>
              </div>
            </div>

            <aside class="weather-info" style="grid-area: weatherSection;">
              <img id="weather-icon" src="" alt="Weather Icon" loading="lazy"/>
              <p id="weather-description">Loading…</p>
              <p id="temperature">--°C</p>
              <p id="humidity">Humidity: --%</p>
              <p id="wind-speed">Wind: -- m/s</p>
            </aside>

            <div class="history-wrap">
              <div class="history-header">
                <div><i class="fas fa-clock"></i> Recent</div>
                <div class="history-actions">
                  <button id="historyMoreBtn" class="history-more"><i class="fas fa-list"></i> More</button>
                </div>
              </div>
              <div id="historyScroller" class="history-scroller"></div>
            </div>
          </div>

          <div id="offline-indicator" class="offline-indicator"><i class="fas fa-signal-slash"></i> Offline</div>
        </div>
      </section>

      <footer class="footer">
        <div class="container">
          <p>&copy; 2024 MikuMiku. All rights reserved.</p>
          <button id="manageConsentFooter" class="manage-consent-button"><i class="fas fa-cookie-bite"></i> Manage Cookie Preferences</button>
        </div>
      </footer>

      <div id="consentModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="consentModalTitle" aria-describedby="consentModalDescription">
        <div class="modal-content">
          <button class="close-button" id="closeConsentModal" aria-label="Close Consent Modal"><i class="fas fa-times"></i></button>
          <h2 id="consentModalTitle"><i class="fas a-cookie"></i> Cookie Consent</h2>
          <p id="consentModalDescription">I use cookies stored in your browser to enhance your experience on my personal website. These cookies are essential for the website's functionality. By clicking "Accept," you consent to their use. You can also manage your cookie preferences in the "Manage Cookie Preferences" section.</p>
          <div class="consent-buttons">
            <button id="acceptConsent" class="consent-button"><i class="fas fa-check"></i> Accept</button>
            <button id="declineConsent" class="consent-button"><i class="fas fa-times"></i> Decline</button>
          </div>
        </div>
      </div>

      <div id="historyBackdrop" class="backdrop" aria-hidden="true"></div>
      <div id="historyModal" class="modal-description" role="dialog" aria-modal="true" aria-labelledby="historyModalTitle">
        <button id="closeHistoryModal" class="history-modal-close" aria-label="Close"><i class="fas fa-times"></i></button>
        <h4 id="historyModalTitle">More Recently Played</h4>
        <div id="historyModalGrid" class="history-modal-grid"></div>
      </div>

      <div class="mini-player" id="miniPlayer" aria-live="polite">
        <img id="miniThumb" class="mini-thumb" src="" alt=""/>
        <div class="mini-body">
          <div style="flex:1;min-width:0">
            <div id="miniTitle" class="mini-title">Loading…</div>
            <div class="mp-bar"><div id="miniProg" class="mp-prog"></div></div>
          </div>
          <div class="mini-ctrls">
            <button id="mpPlay" title="Play/Pause"><i class="fas fa-play"></i></button>
            <button id="mpClose" title="Close"><i class="fas fa-xmark"></i></button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.1/socket.io.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="haru.js"></script>
    <script src="clockwork.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("pageContainer");if(e)e.classList.add("loaded");const t=document.getElementById("titleBar");if(t)window.addEventListener("scroll",function(){t.classList.toggle("scrolled",window.scrollY>50)});const n=document.getElementById("menuButton"),o=document.getElementById("overlayMenu"),a=document.getElementById("closeOverlay");if(n&&o)n.addEventListener("click",function(e){e.stopPropagation(),o.classList.add("active"),document.body.classList.add("overlay-active")});if(a&&o)a.addEventListener("click",function(e){e.stopPropagation(),o.classList.remove("active"),document.body.classList.remove("overlay-active")});window.addEventListener("click",function(e){if(e.target===o){o.classList.remove("active"),document.body.classList.remove("overlay-active")}});const i=document.querySelectorAll(".personality-button"),d=document.querySelector(".site-title");if(i.length&&d)i.forEach(e=>{e.addEventListener("click",function(){const t=e.textContent.trim();if(t==="Melody")d.style.color="#ff4081";else if(t==="Harmony")d.style.color="#00c6ff";else if(t==="Rhythm")d.style.color="#ffffff";else d.style.color="#00c6ff";i.forEach(e=>e.classList.remove("active")),e.classList.add("active")})})});
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){
        const key="lastVisitTimestamp"
        const now=Date.now()
        const lastVisit=localStorage.getItem(key)
        let message
        if(lastVisit){
          const diffMs=now-parseInt(lastVisit,10)
          const diffMin=Math.floor(diffMs/60000)
          const diffHr=Math.floor(diffMin/60)
          const diffDay=Math.floor(diffHr/24)
          if(diffDay>0)message=`Last visited ${diffDay} day${diffDay>1?'s':''} ago`
          else if(diffHr>0)message=`Last visited ${diffHr} hour${diffHr>1?'s':''} ago`
          else if(diffMin>0)message=`Last visited ${diffMin} minute${diffMin>1?'s':''} ago`
          else message="Last visited just now"
        }else{
          message="This is your first visit!"
        }
        localStorage.setItem(key,now.toString())
        const footerContainer=document.querySelector(".footer .container")
        if(footerContainer){
          const span=document.createElement("span")
          span.style.display="block"
          span.style.marginTop="4px"
          span.style.opacity="0.8"
          span.textContent=message
          footerContainer.appendChild(span)
        }
      })
    </script>

    <script>
      (function(){
        const cfg={name:"cookieConsent",days:365,path:"/",modalId:"consentModal",acceptId:"acceptConsent",declineId:"declineConsent",manageIds:["manageConsentFooter"],closeId:"closeConsentModal"}
        const modal=document.getElementById(cfg.modalId)
        const btnAccept=document.getElementById(cfg.acceptId)
        const btnDecline=document.getElementById(cfg.declineId)
        const btnClose=document.getElementById(cfg.closeId)
        const manageBtns=cfg.manageIds.map(id=>document.getElementById(id)).filter(Boolean)
        function setCookie(name,value,days,path){let exp="";if(typeof days==="number"&&isFinite(days)){const d=new Date();d.setTime(d.getTime()+days*24*60*60*1000);exp="; expires="+d.toUTCString()}const sec=location.protocol==="https:"?"; Secure":"";document.cookie=name+"="+encodeURIComponent(value)+exp+"; path="+(path||"/")+"; SameSite=Lax"+sec}
        function getCookie(name){const n=name+"=";const arr=document.cookie.split(";");for(let i=0;i<arr.length;i++){let c=arr[i].trim();if(c.indexOf(n)===0)return decodeURIComponent(c.substring(n.length))}return null}
        function openModal(){if(!modal)return;modal.classList.add("active");document.body.classList.add("modal-active");modal.setAttribute("aria-hidden","false")}
        function closeModal(){if(!modal)return;modal.classList.remove("active");document.body.classList.remove("modal-active");modal.setAttribute("aria-hidden","true")}
        function init(){const existing=getCookie(cfg.name);if(!existing){openModal()}manageBtns.forEach(b=>b.addEventListener("click",e=>{e.preventDefault();openModal()}))
          if(btnAccept)btnAccept.addEventListener("click",function(){setCookie(cfg.name,JSON.stringify({necessary:true}),cfg.days,cfg.path);closeModal()})
          if(btnDecline)btnDecline.addEventListener("click",function(){setCookie(cfg.name,JSON.stringify({necessary:false}),cfg.days,cfg.path);closeModal()})
          if(btnClose)btnClose.addEventListener("click",function(){closeModal()})
          window.addEventListener("click",function(e){if(e.target===modal)closeModal()})
          document.addEventListener("keydown",function(e){if(e.key==="Escape"&&modal.classList.contains("active"))closeModal()})
        }
        document.addEventListener("DOMContentLoaded",init)
      })();
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){
        const t=localStorage.getItem("currentVideoTitle")
        const th=localStorage.getItem("currentVideoThumbnail")
        if(t){const el=document.getElementById("videoTitle");if(el)el.textContent=t}
        if(th){const im=document.getElementById("videoThumbnailImage");if(im){im.src=th;im.style.display="block"}}
        const n=localStorage.getItem("currentVideoChannel")
        const o=localStorage.getItem("currentVideoViews")
        const a=localStorage.getItem("currentVideoLikes")
        const i=localStorage.getItem("currentVideoPublished")
        const d=localStorage.getItem("currentVideoCategory")
        const l=localStorage.getItem("currentVideoDescription")
        const c=document.getElementById("channelName")
        const s=document.getElementById("viewCount")
        const r=document.getElementById("likeCount")
        const m=document.getElementById("publishedDate")
        const g=document.getElementById("videoCategory")
        const f=document.getElementById("descriptionModalDescription")
        if(c&&n)c.textContent=n
        if(s&&o)s.textContent=o
        if(r&&a)r.textContent=a
        if(m&&i)m.textContent=i
        if(g&&d)g.textContent=d
        if(f&&l)f.textContent=l
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){
        const e=document.getElementById("toggleDescriptionButton")
        const t=document.getElementById("descriptionModal")
        const n=document.getElementById("backdrop")
        function open(){t.classList.add("active");n.classList.add("active");document.body.classList.add("modal-open");localStorage.setItem("descriptionModalOpen","true")}
        function close(){t.classList.remove("active");n.classList.remove("active");document.body.classList.remove("modal-open");localStorage.setItem("descriptionModalOpen","false")}
        localStorage.getItem("descriptionModalOpen")==="true"?open():close()
        e.addEventListener("click",function(){t.classList.contains("active")?close():open()})
        n.addEventListener("click",close)
        document.addEventListener("keydown",function(ev){if(ev.key==="Escape"&&t.classList.contains("active"))close()})
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){
        function tick(){
          const d=new Date
          const time=d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})
          const el=document.getElementById("local-time");if(el)el.textContent=time
          const date=d.toLocaleDateString(undefined,{day:"2-digit",month:"long",year:"numeric"})
          const ed=document.getElementById("current-date");if(ed)ed.textContent=date
          const wd=d.toLocaleDateString(undefined,{weekday:"long"})
          const ew=document.getElementById("day-of-week");if(ew)ew.textContent=wd
        }
        setInterval(tick,1000);tick()
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        async function loadWeather() {
          try {
            const res = await fetch("/api/weather?city=" + encodeURIComponent("Leeds"));
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            renderWeather(data);
          } catch (err) {
            const iconEl = document.getElementById("weather-icon");
            if (iconEl) iconEl.style.display = "none";
            const descEl = document.getElementById("weather-description");
            if (descEl) descEl.innerText = "Unable to fetch weather data.";
          }
        }
      
        function renderWeather(d) {
          document.getElementById("weather-description").innerText = "Condition: " + d.condition;
          document.getElementById("temperature").innerText = "Temperature: " + Math.round(d.temperature) + "°C";
          document.getElementById("humidity").innerText = "Humidity: " + d.humidity + "%";
          document.getElementById("wind-speed").innerText = "Wind: " + d.wind_speed + " m/s";
          const iconEl = document.getElementById("weather-icon");
          if (iconEl) {
            const iconUrl = "https://openweathermap.org/img/wn/" + (d.conditionIcon || "01d") + "@2x.png";
            iconEl.src = iconUrl;
            iconEl.style.display = "block";
          }
        }
      
        setInterval(loadWeather, 3600000);
        loadWeather();
      });
    </script>



    <script>
      document.addEventListener("DOMContentLoaded",function(){
        const card=document.getElementById("nowPlayingCard")
        const section=document.getElementById("youtubeSection")
        const offline=document.getElementById("offline-indicator")
        const titleEl=document.getElementById("videoTitle")
        const thumb=document.getElementById("videoThumbnailImage")
        const skThumb=document.getElementById("thumbSkeleton")
        const skTitle=document.getElementById("titleSkeleton")
        const skLine=document.getElementById("lineSkeleton")
        const channelEl=document.getElementById("channelName")
        const viewsEl=document.getElementById("viewCount")
        const likesEl=document.getElementById("likeCount")
        const pubEl=document.getElementById("publishedDate")
        const catEl=document.getElementById("videoCategory")
        const bar=document.getElementById("progressBar")
        const liveEl=document.getElementById("liveIndicator")
        const pauseEl=document.getElementById("pauseIndicator")
        const descEl=document.getElementById("descriptionModalDescription")
        const btnDesc=document.getElementById("toggleDescriptionButton")
        const trans=document.getElementById("ytTransition")
        const scroller=document.getElementById("historyScroller")
        const moreBtn=document.getElementById("historyMoreBtn")
        const backdrop=document.getElementById("historyBackdrop")
        const histModal=document.getElementById("historyModal")
        const histGrid=document.getElementById("historyModalGrid")
        const closeHist=document.getElementById("closeHistoryModal")
        const MP=document.getElementById("miniPlayer")
        const MPt=document.getElementById("miniTitle")
        const MPth=document.getElementById("miniThumb")
        const MPp=document.getElementById("miniProg")
        const MPplay=document.getElementById("mpPlay")
        const MPclose=document.getElementById("mpClose")
        const hoverArea=document.getElementById("progressHover")
        const openStats=document.getElementById("openStats")
        const statsModal=document.getElementById("statsModal")
        const idleOverlay=document.getElementById("idleOverlay")
        const idleOrbs=document.getElementById("idleOrbs")
        const konami=document.getElementById("konamiBox")

        let currentVideoId=null
        let countedVideoId=null
        let statsTickTimer=null
        let offlineTimer=null
        let lastPresenceTs=Date.now()
        let isPaused=false
        let isLiveNow=false
        let currentDuration=0
        let currentTime=0
        let isPlaying=false
        const OFFLINE_DELAY=2000
        const IDLE_AFTER=20000
        const PLAY_COOLDOWN_MS=300000

        function ensureStats(){if(!localStorage.getItem("stats")){localStorage.setItem("stats",'{"totalPlays":0,"totalSeconds":0,"channels":{},"videos":{}}')}}
        function num(v){return v==null?null:Number(v)}
        function truthy(v){return v===true||v==="true"||v===1||v==="1"}

        function renderProgress(e){
          if(!bar)return
          const live=truthy(e.isLive)
          if(live){bar.style.width="100%";MPp.style.width="100%";currentDuration=0;currentTime=0;return}
          const d=num(e.duration), ct=num(e.currentTime), pct=num(e.percent)
          if(typeof d==="number"&&d>0&&typeof ct==="number"&&ct>=0){
            const w=Math.max(0,Math.min(100,(ct/d)*100))
            bar.style.width=w+"%";MPp.style.width=w+"%";currentDuration=d;currentTime=ct
          }else if(typeof pct==="number"&&!isNaN(pct)){
            const w=Math.max(0,Math.min(100,pct))
            bar.style.width=w+"%";MPp.style.width=w+"%"}
        }

        function renderState(e){
          const live=truthy(e.isLive)
          const paused=truthy(e.isPaused)
          liveEl.classList.toggle("active",live)
          pauseEl.classList.toggle("active",paused)
          isPaused=paused
          isLiveNow=live
          isPlaying=!paused
        }

        function goOnline(){if(offline)offline.classList.remove("visible");if(card)card.classList.remove("offline");if(section)section.style.display="block"}
        function goOffline(){if(offline)offline.classList.add("visible");if(card)card.classList.add("offline")}
        function scheduleOffline(){clearTimeout(offlineTimer);offlineTimer=setTimeout(goOffline,OFFLINE_DELAY)}
        function cancelOffline(){clearTimeout(offlineTimer);offlineTimer=null;goOnline()}

        function numberFmt(e){if(typeof e==="string")e=e.replace(/,/g,"");const n=Number(e);return isNaN(n)?"N/A":n.toLocaleString()}

        function fill(e){
          currentVideoId=e.videoId||null
          if(titleEl)titleEl.textContent=e.title||""
          if(channelEl)channelEl.textContent=e.channelTitle||""
          if(viewsEl)viewsEl.textContent=numberFmt(e.viewCount)
          if(likesEl)likesEl.textContent=numberFmt(e.likeCount)
          if(pubEl)pubEl.textContent=e.publishedAt?new Date(e.publishedAt).toLocaleDateString():pubEl.textContent
          if(catEl)catEl.textContent=e.category||""
          if(descEl)descEl.textContent=e.description||""
          if(thumb){if(e.thumbnail){thumb.removeAttribute("loading");thumb.src=e.thumbnail;thumb.style.display="block"}else thumb.style.display=""}
          MPt.textContent=e.title||""
          if(e.thumbnail)MPth.src=e.thumbnail
          goOnline()
          renderProgress(e)
          renderState(e)
          if(btnDesc)btnDesc.style.display="block"
          localStorage.setItem("currentVideoTitle",titleEl?titleEl.textContent:"")
          localStorage.setItem("currentVideoThumbnail",thumb&&thumb.src?thumb.src:"")
          localStorage.setItem("currentVideoChannel",channelEl?channelEl.textContent:"")
          localStorage.setItem("currentVideoViews",viewsEl?viewsEl.textContent:"")
          localStorage.setItem("currentVideoLikes",likesEl?likesEl.textContent:"")
          localStorage.setItem("currentVideoPublished",pubEl?pubEl.textContent:"")
          localStorage.setItem("currentVideoCategory",catEl?catEl.textContent:"")
          localStorage.setItem("currentVideoDescription",descEl?descEl.textContent:"")
          animateDetails()
          saveHistory(e)
        }

        function animateDetails(){const els=document.querySelectorAll(".video-details .animate-in");els.forEach(x=>{x.classList.remove("active");void x.offsetWidth;x.classList.add("fade-enter","active")})}

        function showIncoming(e){
          section.classList.add("entering")
          trans.classList.add("active")
          skThumb.style.display="block"
          skTitle.style.display="block"
          skLine.style.display="block"
          const img=new Image
          const p1=new Promise(res=>{img.onload=()=>res(true);img.onerror=()=>res(false);if(e.thumbnail)img.src=e.thumbnail})
          const p2=new Promise(res=>setTimeout(()=>res(false),800))
          Promise.race([p1,p2]).then(()=>{fill(e);setTimeout(()=>{trans.classList.remove("active");section.classList.remove("entering");skThumb.style.display="none";skTitle.style.display="none";skLine.style.display="none"},180)})
        }

        function readHist(){const raw=localStorage.getItem("npHistory");try{return raw?JSON.parse(raw):[]}catch{return[]}}
        function saveHistory(e){
          const arr=readHist().filter(x=>x.videoId!==e.videoId)
          arr.unshift({videoId:e.videoId||"",title:e.title||"",thumbnail:e.thumbnail||"",channelTitle:e.channelTitle||"",publishedAt:e.publishedAt||"",category:e.category||""})
          const out=arr.slice(0,20)
          localStorage.setItem("npHistory",JSON.stringify(out))
          renderHist(out)
        }

        function histItem(e){
          const t=document.createElement("div");t.className="hist-item";t.dataset.videoId=e.videoId
          const n=document.createElement("img");n.className="hist-thumb";n.src=e.thumbnail||""
          const o=document.createElement("div");o.className="hist-title";o.textContent=e.title||""
          const a=document.createElement("div");a.className="hist-meta";a.textContent=e.channelTitle||""
          t.appendChild(n);t.appendChild(o);t.appendChild(a)
          t.addEventListener("click",function(){
            if(n)n.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"})
            const d={videoId:e.videoId,title:e.title,thumbnail:e.thumbnail,channelTitle:e.channelTitle,viewCount:viewsEl?viewsEl.textContent:"",likeCount:likesEl?likesEl.textContent:"",publishedAt:e.publishedAt,category:e.category,description:descEl?descEl.textContent:"",duration:0,currentTime:0,isLive:false,isPaused:true}
            fill(d)
            toggleHist(false)
          })
          return t
        }

        function renderHist(arr){
          scroller.innerHTML=""
          const head=arr.slice(0,3);head.forEach(n=>scroller.appendChild(histItem(n)))
          moreBtn.disabled=arr.length<=3
          histGrid.innerHTML=""
          const rest=arr.slice(3);rest.forEach(o=>histGrid.appendChild(histItem(o)))
        }

        function initHist(){renderHist(readHist())}
        function toggleHist(open=true){
          if(open){backdrop.classList.add("active");histModal.classList.add("active");document.body.classList.add("modal-open")}
          else{backdrop.classList.remove("active");histModal.classList.remove("active");document.body.classList.remove("modal-open")}
        }

        async function refreshLiveCounts(){
          if(!currentVideoId)return
          if(!liveEl.classList.contains("active"))return
          try{
            const res=await fetch("/api/youtube/stats?videoId="+encodeURIComponent(currentVideoId))
            if(!res.ok)return
            const data=await res.json()
            if(typeof data.viewCount!=="undefined"&&viewsEl)viewsEl.textContent=numberFmt(data.viewCount)
            if(typeof data.likeCount!=="undefined"&&likesEl)likesEl.textContent=numberFmt(data.likeCount)
          }catch{}
        }

        function scheduleCounts(){if(statsTickTimer){clearInterval(statsTickTimer);statsTickTimer=null}if(liveEl.classList.contains("active")){statsTickTimer=setInterval(refreshLiveCounts,10000)}}

        function shouldCountPlay(e){
          const id=e.videoId||e.title||""
          if(!id)return false
          const map=JSON.parse(localStorage.getItem("playSeen")||"{}")
          const last=map[id]||0
          const now=Date.now()
          const ok=now-last>PLAY_COOLDOWN_MS
          if(ok){map[id]=now;localStorage.setItem("playSeen",JSON.stringify(map))}
          return ok
        }

        const socket=io()
        socket.on("connect",function(){cancelOffline()})
        socket.on("disconnect",function(){scheduleOffline();isPlaying=false})
        socket.on("presenceUpdate",function(e){
          lastPresenceTs=Date.now()
          if(e.presenceType==="offline"){scheduleOffline();isPlaying=false;return}
          cancelOffline()
          if(e.presenceType==="video"){
            const live=e.isLive!==undefined?truthy(e.isLive):false
            const paused=e.isPaused!==undefined?truthy(e.isPaused):false
            if(e.videoId&&e.videoId!==countedVideoId&&shouldCountPlay(e)){bumpPlay(e);countedVideoId=e.videoId}
            if(e.videoId===currentVideoId){
              renderProgress({...e,isLive:live})
              renderState({isLive:live,isPaused:paused})
            }else{
              showIncoming({...e,isLive:live,isPaused:paused})
              scheduleCounts()
            }
            isPlaying=!paused
          }else if(e.presenceType==="browsing"){
            isPlaying=false
            if(titleEl)titleEl.textContent=e.title||titleEl.textContent
            if(thumb){if(e.thumbnail){thumb.src=e.thumbnail;thumb.style.display="block"}else thumb.style.display=""}
            renderState({isLive:false,isPaused:false})
          }
        })

        setTimeout(function(){if(!titleEl||!titleEl.textContent||titleEl.textContent==="Loading…"){const t=localStorage.getItem("currentVideoTitle");if(t&&titleEl)titleEl.textContent=t}},0)

        initHist()
        moreBtn.addEventListener("click",function(){toggleHist(true)})
        backdrop.addEventListener("click",function(){toggleHist(false)})
        closeHist.addEventListener("click",function(){toggleHist(false)})
        document.addEventListener("keydown",function(e){if(e.key==="Escape"&&histModal.classList.contains("active"))toggleHist(false)})

        setInterval(function(){
          if(isPlaying){
            ensureStats()
            const key="stats"
            const st=JSON.parse(localStorage.getItem(key))
            st.totalSeconds+=1
            localStorage.setItem(key,JSON.stringify(st))
          }
        },1000)

        function bumpPlay(e){
          ensureStats()
          const key="stats"
          const st=JSON.parse(localStorage.getItem(key))
          st.totalPlays+=1
          const ch=e.channelTitle||"Unknown"
          st.channels[ch]=(st.channels[ch]||0)+1
          const vid=e.videoId||e.title||Math.random().toString(36).slice(2)
          st.videos[vid]=(st.videos[vid]||{title:e.title||"Untitled",count:0})
          st.videos[vid].count+=1
          localStorage.setItem(key,JSON.stringify(st))
        }

        function renderStats(){
          ensureStats()
          const key="stats"
          const st=JSON.parse(localStorage.getItem(key))
          document.getElementById("statTotal").textContent=st.totalPlays.toLocaleString()
          const mins=Math.floor(st.totalSeconds/60)
          const hrs=Math.floor(mins/60)
          const rem=mins%60
          document.getElementById("statTime").textContent=(hrs>0?hrs+"h ":"")+rem+"m"
          document.getElementById("statChannels").textContent=Object.keys(st.channels).length.toString()
          const topC=Object.entries(st.channels).sort((a,b)=>b[1]-a[1]).slice(0,5)
          const tc=document.getElementById("topChannels")
          tc.innerHTML=""
          topC.forEach(([name,count])=>{const it=document.createElement("div");it.className="top-item";const l=document.createElement("div");l.textContent=name;const r=document.createElement("div");r.textContent=count;it.appendChild(l);it.appendChild(r);tc.appendChild(it)})
          const topV=Object.entries(st.videos).sort((a,b)=>b[1].count-a[1].count).slice(0,5)
          const tv=document.getElementById("topVideos")
          tv.innerHTML=""
          topV.forEach(([id,obj])=>{const it=document.createElement("div");it.className="top-item";const l=document.createElement("div");l.textContent=obj.title;const r=document.createElement("div");r.textContent=obj.count;it.appendChild(l);it.appendChild(r);tv.appendChild(it)})
        }

        openStats.addEventListener("click",function(){statsModal.classList.add("active");document.getElementById("backdrop").classList.add("active");document.body.classList.add("modal-open");renderStats()})
        document.getElementById("backdrop").addEventListener("click",function(){statsModal.classList.remove("active");document.getElementById("backdrop").classList.remove("active");document.body.classList.remove("modal-open")})

        const obs=new IntersectionObserver(entries=>{entries.forEach(ent=>{MP.classList.toggle("active",!ent.isIntersecting)})},{threshold:0})
        obs.observe(section)
        MPclose.addEventListener("click",()=>{MP.classList.remove("active")})
        MPplay.addEventListener("click",()=>{isPaused=!isPaused;pauseEl.classList.toggle("active",isPaused);MPplay.innerHTML=isPaused?'<i class="fas fa-play"></i>':'<i class="fas fa-pause"></i>';isPlaying=!isPaused})

        function fmt(sec){sec=Math.max(0,Math.floor(sec));const m=Math.floor(sec/60);const s=sec%60;return m+":"+(s<10?"0":"")+s}

        let hoverTip=null
        function ensureHoverTip(){
          if(hoverTip)return hoverTip
          const tip=document.createElement("div")
          tip.style.position="fixed"
          tip.style.display="none"
          tip.style.zIndex="6000"
          tip.style.pointerEvents="none"
          tip.style.background="#000"
          tip.style.border="1px solid rgba(255,255,255,.15)"
          tip.style.borderRadius="10px"
          tip.style.boxShadow="0 10px 24px rgba(0,0,0,.45)"
          const img=document.createElement("img");img.style.display="block";img.style.width="200px";img.style.height="112px";img.style.objectFit="cover"
          const time=document.createElement("div");time.style.fontSize=".75rem";time.style.padding=".25rem .5rem";time.style.textAlign="center";time.style.color="#fff"
          tip.appendChild(img);tip.appendChild(time)
          document.body.appendChild(tip)
          hoverTip={wrap:tip,img,time}
          return hoverTip
        }

        function onSeekMove(ev){
          if(!currentDuration||currentDuration<=0){if(hoverTip)hoverTip.wrap.style.display="none";return}
          const rect=hoverArea.getBoundingClientRect()
          const x=Math.min(Math.max(0,ev.clientX-rect.left),rect.width)
          const ratio=x/rect.width
          const t=ratio*currentDuration
          const tip=ensureHoverTip()
          const pageX=ev.clientX
          const pageY=rect.top-130
          tip.wrap.style.left=pageX+"px"
          tip.wrap.style.top=(pageY>10?pageY:10)+"px"
          tip.wrap.style.transform="translateX(-50%)"
          tip.wrap.style.display="block"
          if(thumb&&thumb.src)tip.img.src=thumb.src
          tip.time.textContent=fmt(t)
        }

        function onSeekLeave(){if(hoverTip)hoverTip.wrap.style.display="none"}

        hoverArea.addEventListener("mousemove",onSeekMove)
        hoverArea.addEventListener("mouseleave",onSeekLeave)

        setInterval(function(){
          const idle=Date.now()-lastPresenceTs>IDLE_AFTER && !liveEl.classList.contains("active") && !thumb.src
          idleOverlay.classList.toggle("active",idle)
        },1000)

        function seedOrbs(){
          idleOrbs.innerHTML=""
          for(let i=0;i<24;i++){
            const s=document.createElement("span")
            const x=Math.random()*100
            const y=Math.random()*100
            const delay=(Math.random()*8).toFixed(2)
            const dur=(10+Math.random()*10).toFixed(2)
            s.style.left=x+"%";s.style.top=y+"%";s.style.animationDuration=dur+"s";s.style.animationDelay="-"+delay+"s"
            idleOrbs.appendChild(s)
          }
        }
        seedOrbs()

        const code=[38,38,40,40,37,39,37,39,66,65];let pos=0
        window.addEventListener("keydown",function(e){
          if(e.keyCode===code[pos]){pos++;if(pos===code.length){konami.classList.add("active");setTimeout(()=>konami.classList.remove("active"),3000);pos=0}}
          else{pos=0}
        })
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){
        const canvas=document.getElementById("soundWaveCanvas");if(!canvas)return
        const ctx=canvas.getContext("2d")
        const cell=20
        const glyphs=["0","1"]
        const words=["Hatsune Miku","Digital Diva","CV01","39"]
        let cols=0;let y=[],speed=[],hold=[],last=[]
        function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;cols=Math.floor(canvas.width/cell);y=new Array(cols).fill(0);speed=Array.from({length:cols},()=>Math.random()*0.5+0.5);hold=new Array(cols).fill(0);last=new Array(cols).fill("0")}
        function rgba(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgba(${r}, ${g}, ${b}, ${a})`}
        resize();window.addEventListener("resize",resize)
        const palette=["#00C6FF","#FF4081"]
        function draw(){
          ctx.fillStyle="rgba(0,0,0,0.05)";ctx.fillRect(0,0,canvas.width,canvas.height)
          ctx.font=`${cell}px monospace`
          ctx.shadowColor="rgba(0,0,0,0.8)";ctx.shadowBlur=4
          const trail=6
          for(let c=0;c<cols;c++){
            let ch
            if(hold[c]>0){ch=last[c];hold[c]--}
            else if(Math.random()<0.02){ch=words[Math.floor(Math.random()*words.length)];hold[c]=Math.max(2,Math.ceil(ch.length*3));last[c]=ch}
            else{ch=glyphs[Math.floor(Math.random()*glyphs.length)];last[c]=ch}
            const x=c*cell
            const py=Math.floor(y[c])*cell
            ctx.fillStyle=palette[c%palette.length];ctx.fillText(ch,x,py)
            for(let t=1;t<=trail;t++){
              const ty=py-t*cell;if(ty<0)break
              const fade=1-t/(trail+1)
              ctx.fillStyle=rgba(palette[c%palette.length],fade*0.9)
              ctx.fillText(glyphs[Math.floor(Math.random()*glyphs.length)],x,ty)
            }
            if(py>canvas.height&&Math.random()>0.975){y[c]=0;speed[c]=Math.random()*0.1+0.1;hold[c]=0;last[c]="0"}
            y[c]+=speed[c]
          }
          requestAnimationFrame(draw)
        }
        requestAnimationFrame(draw)
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){
        function send(){fetch("/track-visitor",{method:"POST",keepalive:true}).catch(()=>{})}
        send()
        document.addEventListener("visibilitychange",function(){if(document.visibilityState==="hidden"){if(navigator.sendBeacon)navigator.sendBeacon("/track-visitor")}})
      });
    </script>
  </body>
</html>




