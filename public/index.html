<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Miku.dev | Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="stylesheet" href="/styles.css"/>
  </head>
  <body>
    <canvas id="soundWaveCanvas" aria-hidden="true"></canvas>
    <div class="weather-ambient" aria-hidden="true">
      <div class="ambient-layer" id="ambientLayer"></div>
    </div>
    <div class="idle-overlay" id="idleOverlay">
      <div class="idle-orbs" id="idleOrbs"></div>
    </div>
    <div class="konami" id="konamiBox">ミクはいつもここにいるよ ♪</div>
    <div class="page-container" id="pageContainer">
      <header class="title-bar" id="titleBar">
        <div class="container">
          <div class="left-section"></div>
          <div class="title-wrapper">
            <a href="/" aria-label="Home" class="logo-link">
              <span class="site-title">Miku.dev</span>
              <div class="visualizer-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 100" class="visualizer">
                  <g>
                    <rect x="10" y="70" width="15" height="30" fill="#00c6ff">
                      <animate attributeName="height" values="30;60;30" dur="0.8s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="70;40;70" dur="0.8s" repeatCount="indefinite"/>
                    </rect>
                    <rect x="35" y="60" width="15" height="40" fill="#ff4081">
                      <animate attributeName="height" values="40;80;40" dur="1s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="60;20;60" dur="1s" repeatCount="indefinite"/>
                    </rect>
                    <rect x="60" y="80" width="15" height="20" fill="#00c6ff">
                      <animate attributeName="height" values="20;50;20" dur="0.6s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="80;50;80" dur="0.6s" repeatCount="indefinite"/>
                    </rect>
                    <rect x="85" y="50" width="15" height="50" fill="#ff4081">
                      <animate attributeName="height" values="50;90;50" dur="1.2s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="50;10;50" dur="1.2s" repeatCount="indefinite"/>
                    </rect>
                    <rect x="110" y="70" width="15" height="30" fill="#00c6ff">
                      <animate attributeName="height" values="30;60;30" dur="0.9s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="70;40;70" dur="0.9s" repeatCount="indefinite"/>
                    </rect>
                    <rect x="135" y="60" width="15" height="40" fill="#ff4081">
                      <animate attributeName="height" values="40;80;40" dur="1.1s" repeatCount="indefinite"/>
                      <animate attributeName="y" values="60;20;60" dur="1.1s" repeatCount="indefinite"/>
                    </rect>
                  </g>
                </svg>
              </div>
            </a>
          </div>
          <div class="right-section">
            <button class="menu-button" id="menuButton" aria-label="Open Menu">
              <i class="fas fa-music"></i>
            </button>
          </div>
        </div>
      </header>
      <nav class="overlay-menu" id="overlayMenu">
        <button class="close-overlay" id="closeOverlay" aria-label="Close Menu">
          <i class="fas fa-times"></i>
        </button>
        <div class="overlay-content">
          <a href="/auth" aria-label="Admin Login"><i class="fas fa-user-lock"></i> Admin Login</a>
          <a href="#aboutMe" aria-label="About Me"><i class="fas fa-info-circle"></i> About Me</a>
          <div class="personality-options">
            <button id="personalityOption1" class="personality-button"><i class="fas fa-music"></i> Melody</button>
            <button id="personalityOption2" class="personality-button"><i class="fas fa-headphones"></i> Harmony</button>
            <button id="personalityOption3" class="personality-button"><i class="fas fa-microphone"></i> Rhythm</button>
          </div>
        </div>
      </nav>
      <section class="now-playing-container">
        <div class="now-playing-card" id="nowPlayingCard">
          <div class="now-playing-grid">
            <div class="video-info">
              <div class="info-item"><i class="fas fa-tv"></i><span id="channelName">Loading…</span></div>
              <div class="info-item"><i class="fas fa-eye"></i><span id="viewCount">Loading…</span></div>
              <div class="info-item"><i class="fas fa-thumbs-up"></i><span id="likeCount">Loading…</span></div>
              <div class="info-item"><i class="fas fa-calendar-day"></i><span id="publishedDate">Loading…</span></div>
              <div class="info-item"><i class="fas fa-tag"></i><span id="videoCategory">Loading…</span></div>
            </div>
            <div class="time-info">
              <div class="greeting-container">
                <p class="greeting"><i class="fas fa-sun"></i> <span id="greeting-text">Good Morning!</span></p>
              </div>
              <div class="clock-container">
                <div class="digital-clock">
                  <p id="local-time"><i class="fas fa-clock"></i> 00:00:00</p>
                  <p id="current-date"><i class="fas fa-calendar-alt"></i> 1 January 2025</p>
                  <p id="day-of-week"><i class="fas fa-calendar-day"></i> Wednesday</p>
                  <p id="time-zone"><i class="fas fa-globe"></i> UTC</p>
                </div>
              </div>
            </div>
            <div class="youtube-section" id="youtubeSection" style="position: relative;">
              <div class="transition-layer" id="ytTransition"></div>
              <div class="video-thumb">
                <img id="videoThumbnailImage" class="thumb-img" src="" alt="Thumbnail" loading="lazy"/>
                <div id="thumbSkeleton" class="skeleton" style="position:absolute;inset:0;display:none;"></div>
              </div>
              <div class="video-details">
                <h3 class="animate-in">Currently Playing</h3>
                <p id="videoTitle" class="animate-in delay-1">Loading…</p>
                <div class="progress-bar animate-in delay-2">
                  <div id="progressBar"></div>
                  <div class="progress-hover" id="progressHover"></div>
                  <div class="progress-preview" id="progressPreview">
                    <img id="previewImg" src="" alt="Preview"/>
                    <div class="progress-time" id="previewTime">0:00</div>
                  </div>
                  <div class="seek-time" id="seekTime">0:00</div>
                </div>
                <div class="animate-in delay-3">
                  <button id="toggleDescriptionButton"><i class="fas fa-info-circle"></i> Show Description</button>
                  <button id="openStats" class="btn-stats" style="margin-left:.5rem"><i class="fas fa-chart-line"></i><span class="label">Stats</span></button>
                </div>
                <div id="backdrop" class="backdrop" aria-hidden="true"></div>
                <div id="descriptionModal" class="modal-description" role="dialog" aria-modal="true" aria-labelledby="descriptionModalTitle" aria-describedby="descriptionModalDescription">
                  <h4 id="descriptionModalTitle">Description</h4>
                  <p id="descriptionModalDescription">Loading description…</p>
                </div>
                <div id="statsModal" class="modal-description" role="dialog" aria-modal="true" aria-labelledby="statsModalTitle">
                  <h4 id="statsModalTitle">Listening Stats</h4>
                  <div class="stats-grid">
                    <div class="stat-card"><div>Total Plays</div><div id="statTotal" style="font-size:1.6rem;font-weight:800">0</div></div>
                    <div class="stat-card"><div>Total Time</div><div id="statTime" style="font-size:1.2rem;font-weight:800">0m</div></div>
                    <div class="stat-card"><div>Unique Channels</div><div id="statChannels" style="font-size:1.6rem;font-weight:800">0</div></div>
                  </div>
                  <h5 style="margin-top:.8rem">Top Channels</h5>
                  <div id="topChannels" class="top-list"></div>
                  <h5 style="margin-top:.8rem">Top Videos</h5>
                  <div id="topVideos" class="top-list"></div>
                </div>
                <div id="titleSkeleton" class="skeleton title" style="margin-top:.5rem;display:none;"></div>
                <div id="lineSkeleton" class="skeleton line" style="margin-top:.5rem;display:none;"></div>
              </div>
              <div class="status-boxes">
                <div id="liveIndicator" class="status-box live">Live</div>
                <div id="pauseIndicator" class="status-box paused">Paused</div>
              </div>
            </div>
            <aside class="weather-info" style="grid-area: weatherSection;">
              <img id="weather-icon" src="" alt="Weather Icon" loading="lazy"/>
              <p id="weather-description">Loading…</p>
              <p id="temperature">--°C</p>
              <p id="humidity">Humidity: --%</p>
              <p id="wind-speed">Wind: -- m/s</p>
            </aside>
            <div class="history-wrap">
              <div class="history-header">
                <div><i class="fas fa-clock"></i> Recent</div>
                <div class="history-actions">
                  <button id="historyMoreBtn" class="history-more"><i class="fas fa-list"></i> More</button>
                </div>
              </div>
              <div id="historyScroller" class="history-scroller"></div>
            </div>
          </div>
          <div id="offline-indicator" class="offline-indicator"><i class="fas fa-signal-slash"></i> Offline</div>
        </div>
      </section>
      <footer class="footer">
        <div class="container">
          <p>&copy; 2024 MikuMiku. All rights reserved.</p>
          <button id="manageConsentFooter" class="manage-consent-button"><i class="fas fa-cookie-bite"></i> Manage Cookie Preferences</button>
        </div>
      </footer>
      <div id="consentModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="consentModalTitle" aria-describedby="consentModalDescription">
        <div class="modal-content">
          <button class="close-button" id="closeConsentModal" aria-label="Close Consent Modal"><i class="fas fa-times"></i></button>
          <h2 id="consentModalTitle"><i class="fas a-cookie"></i> Cookie Consent</h2>
          <p id="consentModalDescription">I use cookies stored in your browser to enhance your experience on my personal website. These cookies are essential for the website's functionality. By clicking "Accept," you consent to their use. You can also manage your cookie preferences in the "Manage Cookie Preferences" section.</p>
          <div class="consent-buttons">
            <button id="acceptConsent" class="consent-button"><i class="fas fa-check"></i> Accept</button>
            <button id="declineConsent" class="consent-button"><i class="fas fa-times"></i> Decline</button>
          </div>
        </div>
      </div>
      <div id="historyBackdrop" class="backdrop" aria-hidden="true"></div>
      <div id="historyModal" class="modal-description" role="dialog" aria-modal="true" aria-labelledby="historyModalTitle">
        <button id="closeHistoryModal" class="history-modal-close" aria-label="Close"><i class="fas fa-times"></i></button>
        <h4 id="historyModalTitle">More Recently Played</h4>
        <div id="historyModalGrid" class="history-modal-grid"></div>
      </div>
      <div class="mini-player" id="miniPlayer" aria-live="polite">
        <img id="miniThumb" class="mini-thumb" src="" alt=""/>
        <div class="mini-body">
          <div style="flex:1;min-width:0">
            <div id="miniTitle" class="mini-title">Loading…</div>
            <div class="mp-bar"><div id="miniProg" class="mp-prog"></div></div>
          </div>
          <div class="mini-ctrls">
            <button id="mpPlay" title="Play/Pause"><i class="fas fa-play"></i></button>
            <button id="mpClose" title="Close"><i class="fas fa-xmark"></i></button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.1/socket.io.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="haru.js"></script>
    <script src="clockwork.js"></script>



    <script>
      document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("pageContainer");e&&e.classList.add("loaded");const t=document.getElementById("titleBar");t&&window.addEventListener("scroll",function(){t.classList.toggle("scrolled",window.scrollY>50)});const n=document.getElementById("menuButton"),o=document.getElementById("overlayMenu"),a=document.getElementById("closeOverlay");n&&o&&n.addEventListener("click",function(e){e.stopPropagation(),o.classList.add("active"),document.body.classList.add("overlay-active")}),a&&o&&a.addEventListener("click",function(e){e.stopPropagation(),o.classList.remove("active"),document.body.classList.remove("overlay-active")}),window.addEventListener("click",function(e){e.target===o&&(o.classList.remove("active"),document.body.classList.remove("overlay-active"))});const i=document.querySelectorAll(".personality-button"),d=document.querySelector(".site-title");i.length&&d&&i.forEach(e=>{e.addEventListener("click",function(){const t=e.textContent.trim();"Melody"===t?d.style.color="#ff4081":"Harmony"===t?d.style.color="#00c6ff":"Rhythm"===t?d.style.color="#ffffff":d.style.color="#00c6ff",i.forEach(e=>e.classList.remove("active")),e.classList.add("active")})})});
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function(){
        const key = "lastVisitTimestamp"
        const now = Date.now()
        const lastVisit = localStorage.getItem(key)
        let message
        if (lastVisit) {
          const diffMs = now - parseInt(lastVisit, 10)
          const diffMin = Math.floor(diffMs / 60000)
          const diffHr = Math.floor(diffMin / 60)
          const diffDay = Math.floor(diffHr / 24)
          if (diffDay > 0) {
            message = `Last visited ${diffDay} day${diffDay>1?'s':''} ago`
          } else if (diffHr > 0) {
            message = `Last visited ${diffHr} hour${diffHr>1?'s':''} ago`
          } else if (diffMin > 0) {
            message = `Last visited ${diffMin} minute${diffMin>1?'s':''} ago`
          } else {
            message = `Last visited just now`
          }
        } else {
          message = "This is your first visit!"
        }
        localStorage.setItem(key, now.toString())
        const footerContainer = document.querySelector(".footer .container")
        if (footerContainer) {
          const span = document.createElement("span")
          span.style.display = "block"
          span.style.marginTop = "4px"
          span.style.opacity = "0.8"
          span.textContent = message
          footerContainer.appendChild(span)
        }
      })
    </script>

    <script>
      (function(){
        const cfg={name:"cookieConsent",days:365,path:"/",modalId:"consentModal",acceptId:"acceptConsent",declineId:"declineConsent",manageIds:["manageConsentFooter"],closeId:"closeConsentModal"}
        const modal=document.getElementById(cfg.modalId)
        const btnAccept=document.getElementById(cfg.acceptId)
        const btnDecline=document.getElementById(cfg.declineId)
        const btnClose=document.getElementById(cfg.closeId)
        const manageBtns=cfg.manageIds.map(id=>document.getElementById(id)).filter(Boolean)
        function setCookie(name,value,days,path){let exp="";if(typeof days==="number"&&isFinite(days)){const d=new Date();d.setTime(d.getTime()+days*24*60*60*1000);exp="; expires="+d.toUTCString()}const sec=location.protocol==="https:"?"; Secure":"";document.cookie=name+"="+encodeURIComponent(value)+exp+"; path="+(path||"/")+"; SameSite=Lax"+sec}
        function openModal(){if(!modal)return;modal.classList.add("active");document.body.classList.add("modal-active");modal.setAttribute("aria-hidden","false")}
        function closeModal(){if(!modal)return;modal.classList.remove("active");document.body.classList.remove("modal-active");modal.setAttribute("aria-hidden","true")}
        function init(){const existing=document.cookie.includes(cfg.name+"=");if(!existing){openModal()}manageBtns.forEach(b=>b.addEventListener("click",e=>{e.preventDefault();openModal()}))
          if(btnAccept)btnAccept.addEventListener("click",function(){setCookie(cfg.name,JSON.stringify({necessary:true}),cfg.days,cfg.path);closeModal()})
          if(btnDecline)btnDecline.addEventListener("click",function(){setCookie(cfg.name,JSON.stringify({necessary:false}),cfg.days,cfg.path);closeModal()})
          if(btnClose)btnClose.addEventListener("click",function(){closeModal()})
          window.addEventListener("click",function(e){if(e.target===modal)closeModal()})
          document.addEventListener("keydown",function(e){if(e.key==="Escape"&&modal.classList.contains("active"))closeModal()})
        }
        document.addEventListener("DOMContentLoaded",init)
      })();
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("currentVideoTitle"),t=localStorage.getItem("currentVideoThumbnail");if(e){const t=document.getElementById("videoTitle");t&&(t.textContent=e)}if(t){const e=document.getElementById("videoThumbnailImage");e&&(e.src=t,e.style.display="block")}const n=localStorage.getItem("currentVideoChannel"),o=localStorage.getItem("currentVideoViews"),a=localStorage.getItem("currentVideoLikes"),i=localStorage.getItem("currentVideoPublished"),d=localStorage.getItem("currentVideoCategory"),l=localStorage.getItem("currentVideoDescription"),c=document.getElementById("channelName"),s=document.getElementById("viewCount"),r=document.getElementById("likeCount"),m=document.getElementById("publishedDate"),g=document.getElementById("videoCategory"),f=document.getElementById("descriptionModalDescription");c&&n&&(c.textContent=n),s&&o&&(s.textContent=o),r&&a&&(r.textContent=a),m&&i&&(m.textContent=i),g&&d&&(g.textContent=d),f&&l&&(f.textContent=l)});
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("toggleDescriptionButton"),t=document.getElementById("descriptionModal"),n=document.getElementById("backdrop");function o(){t.classList.add("active"),n.classList.add("active"),document.body.classList.add("modal-open"),localStorage.setItem("descriptionModalOpen","true")}function a(){t.classList.remove("active"),n.classList.remove("active"),document.body.classList.remove("modal-open"),localStorage.setItem("descriptionModalOpen","false")}localStorage.getItem("descriptionModalOpen")==="true"?o():a(),e.addEventListener("click",function(){t.classList.contains("active")?a():o()}),n.addEventListener("click",a),document.addEventListener("keydown",function(e){if(e.key==="Escape"&&t.classList.contains("active"))a()})});
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){function e(){const e=new Date,t=e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),n=document.getElementById("local-time");n&&(n.textContent=t);const o=e.toLocaleDateString(void 0,{day:"2-digit",month:"long",year:"numeric"}),a=document.getElementById("current-date");a&&(a.textContent=o);const i=e.toLocaleDateString(void 0,{weekday:"long"}),d=document.getElementById("day-of-week");d&&(d.textContent=i)}setInterval(e,1e3),e()});
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){async function e(){try{const e=await fetch("/api/weather?city="+encodeURIComponent("Leeds")),t=await e.json();if(t.error)throw new Error(t.error);n(t)}catch(e){const t=document.getElementById("weather-icon");t&&(t.style.display="none");const n=document.getElementById("weather-description");n&&(n.innerText="Unable to fetch weather data.")}}function n(e){const n=e.weather[0].description,o=Math.round(e.main.temp),a=e.main.humidity,i=e.wind.speed,d=e.weather[0].icon,l="https://openweathermap.org/img/wn/"+d+"@2x.png";document.getElementById("weather-description").innerText="Condition: "+n,document.getElementById("temperature").innerText="Temperature: "+o+"°C",document.getElementById("humidity").innerText="Humidity: "+a+"%",document.getElementById("wind-speed").innerText="Wind: "+i+" m/s";const c=document.getElementById("weather-icon");c&&(c.src=l,c.style.display="block");u(d)}function u(i){const a=document.getElementById("ambientLayer");let c1="#00c6ff";if(i.startsWith("01"))c1="#ffd166";else if(i.startsWith("02")||i.startsWith("03"))c1="#8ecae6";else if(i.startsWith("04"))c1="#577590";else if(i.startsWith("09")||i.startsWith("10"))c1="#4dabf7";else if(i.startsWith("11"))c1="#7209b7";else if(i.startsWith("13"))c1="#bde0fe";else if(i.startsWith("50"))c1="#adb5bd";a.style.setProperty("--c1",c1);a.style.setProperty("--x","50%");a.style.setProperty("--y","50%")}setInterval(e,3600000),e()});
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){
      const e=document.getElementById("nowPlayingCard"),t=document.getElementById("youtubeSection"),n=document.getElementById("offline-indicator"),o=document.getElementById("videoTitle"),a=document.getElementById("videoThumbnailImage"),i=document.getElementById("thumbSkeleton"),d=document.getElementById("titleSkeleton"),l=document.getElementById("lineSkeleton"),c=document.getElementById("channelName"),s=document.getElementById("viewCount"),r=document.getElementById("likeCount"),m=document.getElementById("publishedDate"),g=document.getElementById("videoCategory"),f=document.getElementById("progressBar"),v=document.getElementById("liveIndicator"),h=document.getElementById("pauseIndicator"),p=document.getElementById("descriptionModalDescription"),y=document.getElementById("toggleDescriptionButton"),u=document.getElementById("ytTransition"),S=document.getElementById("historyScroller"),E=document.getElementById("historyMoreBtn"),Y=document.getElementById("historyBackdrop"),K=document.getElementById("historyModal"),Z=document.getElementById("historyModalGrid"),X=document.getElementById("closeHistoryModal"),MP=document.getElementById("miniPlayer"),MPt=document.getElementById("miniTitle"),MPth=document.getElementById("miniThumb"),MPp=document.getElementById("miniProg"),MPplay=document.getElementById("mpPlay"),MPclose=document.getElementById("mpClose"),ph=document.getElementById("progressHover"),pp=document.getElementById("progressPreview"),ppImg=document.getElementById("previewImg"),ppTime=document.getElementById("previewTime"),seekTime=document.getElementById("seekTime"),openStats=document.getElementById("openStats"),statsModal=document.getElementById("statsModal"),backdrop=document.getElementById("backdrop"),idleOverlay=document.getElementById("idleOverlay"),idleOrbs=document.getElementById("idleOrbs"),konami=document.getElementById("konamiBox");
      let w=null;let T=null;let A=null;let offlineTimer=null;let lastPresenceTs=Date.now();let isPaused=false;let currentDuration=0;let currentTime=0;let statsEnabled=false;let lastCountedVideoId=null;const OFFLINE_DELAY=2000;const IDLE_AFTER=20000;
      function C(e){return e==null?null:Number(e)}
      function L(e){return e===true||e==="true"||e===1||e==="1"}
      function N(e){if(!f)return;const t=L(e.isLive);if(t){f.style.width="100%";MPp.style.width="100%";currentDuration=0;currentTime=0;return}const n=C(e.duration),o=C(e.currentTime),a=C(e.percent);if(typeof n==="number"&&n>0&&typeof o==="number"&&o>=0){const t=Math.max(0,Math.min(100,(o/n)*100));f.style.width=t+"%";MPp.style.width=t+"%";T=t;currentDuration=n;currentTime=o}else if(typeof a==="number"&&!isNaN(a)){const t=Math.max(0,Math.min(100,a));f.style.width=t+"%";MPp.style.width=t+"%";T=t}}
      function O(e){const t=L(e.isLive),n=L(e.isPaused);v&&v.classList.toggle("active",t),h&&h.classList.toggle("active",n);isPaused=n}
      function D(){n&&n.classList.remove("visible"),e&&e.classList.remove("offline"),t&&(t.style.display="block")}
      function R(e){w=e.videoId||null;o&&(o.textContent=e.title||""),c&&(c.textContent=e.channelTitle||""),s&&(s.textContent=P(e.viewCount)),r&&(r.textContent=P(e.likeCount)),m&&(m.textContent=e.publishedAt?new Date(e.publishedAt).toLocaleDateString():m.textContent),g&&(g.textContent=e.category||""),p&&(p.textContent=e.description||""),a&&(e.thumbnail?(a.removeAttribute("loading"),a.src=e.thumbnail,a.style.display="block"):a.style.display="");MPt.textContent=e.title||"";if(e.thumbnail)MPth.src=e.thumbnail;D(),N(e),O(e),y&&(y.style.display="block"),localStorage.setItem("currentVideoTitle",o?o.textContent:""),localStorage.setItem("currentVideoThumbnail",a&&a.src?a.src:""),localStorage.setItem("currentVideoChannel",c?c.textContent:""),localStorage.setItem("currentVideoViews",s?s.textContent:""),localStorage.setItem("currentVideoLikes",r?r.textContent:""),localStorage.setItem("currentVideoPublished",m?m.textContent:""),localStorage.setItem("currentVideoCategory",g?g.textContent:""),localStorage.setItem("currentVideoDescription",p?p.textContent:""),a.classList.remove("thumb-img"),void a.offsetWidth,a.classList.add("thumb-img");const q=document.querySelectorAll(".video-details .animate-in");q.forEach(x=>{x.classList.remove("active");void x.offsetWidth;x.classList.add("fade-enter","active")});I(e)}
      function P(e){if(typeof e==="string")e=e.replace(/,/g,"");const t=Number(e);return isNaN(t)?"N/A":t.toLocaleString()}
      function M(){n&&n.classList.add("visible"),e&&e.classList.add("offline")}
      function scheduleOffline(){clearTimeout(offlineTimer);offlineTimer=setTimeout(()=>{M()},OFFLINE_DELAY)}
      function cancelOffline(){clearTimeout(offlineTimer);offlineTimer=null;D()}
      function H(e){t.classList.add("entering");u.classList.add("active");i.style.display="block";d.style.display="block";l.style.display="block";const n=new Image;const s=new Promise(r=>{n.onload=()=>r(true);n.onerror=()=>r(false);if(e.thumbnail)n.src=e.thumbnail});const o=new Promise(r=>setTimeout(()=>r(false),800));Promise.race([s,o]).then(()=>{R(e);if(L(e.isLive)){statsEnabled=true;if(e.videoId!==lastCountedVideoId){bumpPlay(e);lastCountedVideoId=e.videoId}}else{statsEnabled=false}setTimeout(()=>{u.classList.remove("active");t.classList.remove("entering");i.style.display="none";d.style.display="none";l.style.display="none"},180)})}
      function B(){const e=localStorage.getItem("npHistory");try{return e?JSON.parse(e):[]}catch{return[]}}
      function I(e){const t=B().filter(x=>x.videoId!==e.videoId);t.unshift({videoId:e.videoId||"",title:e.title||"",thumbnail:e.thumbnail||"",channelTitle:e.channelTitle||"",publishedAt:e.publishedAt||"",category:e.category||""});const n=t.slice(0,20);localStorage.setItem("npHistory",JSON.stringify(n));W(n)}
      function U(e){const t=document.createElement("div");t.className="hist-item";t.dataset.videoId=e.videoId;const n=document.createElement("img");n.className="hist-thumb";n.src=e.thumbnail||"";const o=document.createElement("div");o.className="hist-title";o.textContent=e.title||"";const a=document.createElement("div");a.className="hist-meta";a.textContent=e.channelTitle||"";t.appendChild(n);t.appendChild(o);t.appendChild(a);t.addEventListener("click",function(){n&&n.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"});const d={videoId:e.videoId,title:e.title,thumbnail:e.thumbnail,channelTitle:e.channelTitle,viewCount:s?s.textContent:"",likeCount:r?r.textContent:"",publishedAt:e.publishedAt,category:e.category,description:p?p.textContent:"",duration:0,currentTime:0,isLive:false,isPaused:true};statsEnabled=false;R(d);G(false)});return t}
      function W(e){S.innerHTML="";const t=e.slice(0,3);t.forEach(n=>S.appendChild(U(n)));E.disabled=e.length<=3;Z.innerHTML="";const n=e.slice(3);n.forEach(o=>Z.appendChild(U(o)))}
      function F(){W(B())}
      function G(e=true){if(e){Y.classList.add("active");K.classList.add("active");document.body.classList.add("modal-open")}else{Y.classList.remove("active");K.classList.remove("active");document.body.classList.remove("modal-open")}}
      async function J(){if(!w)return;const e=v&&v.classList.contains("active");if(!e)return;try{const t=await fetch("/api/youtube/stats?videoId="+encodeURIComponent(w));if(!t.ok)return;const n=await t.json();if(typeof n.viewCount!=="undefined"&&s)s.textContent=P(n.viewCount);if(typeof n.likeCount!=="undefined"&&r)r.textContent=P(n.likeCount)}catch{}}
      function Q(){if(A){clearInterval(A);A=null}const e=v&&v.classList.contains("active");if(e){A=setInterval(J,10000)}}
      const z=io();
      z.on("connect",function(){cancelOffline()})
      z.on("disconnect",function(){scheduleOffline()})
      z.on("presenceUpdate",function(e){
        lastPresenceTs=Date.now()
        if(e.presenceType==="offline"){scheduleOffline();return}
        cancelOffline()
        if(e.presenceType==="video"){
          const isNew=e.videoId!==w
          if(isNew){H(e),Q()}else{N(e),O(e)}
          if(L(e.isLive)){statsEnabled=true;if(isNew && e.videoId!==lastCountedVideoId){bumpPlay(e);lastCountedVideoId=e.videoId}}else{statsEnabled=false}
        }
        else if(e.presenceType==="browsing"){o&&(o.textContent=e.title||o.textContent);a&&(e.thumbnail?(a.src=e.thumbnail,a.style.display="block"):a.style.display="");O({isLive:false,isPaused:false});statsEnabled=false}
      })
      setTimeout(function(){if(!o||!o.textContent||o.textContent==="Loading…"){const e=localStorage.getItem("currentVideoTitle");if(e&&o)o.textContent=e}},0);
      F();
      E.addEventListener("click",function(){G(true)});
      Y.addEventListener("click",function(){G(false)});
      X.addEventListener("click",function(){G(false)});
      document.addEventListener("keydown",function(e){if(e.key==="Escape"&&K.classList.contains("active"))G(false)});
      setInterval(Q,5000)
      const ioObserver=new IntersectionObserver(entries=>{entries.forEach(ent=>{MP.classList.toggle("active",!ent.isIntersecting)})},{threshold:0})
      ioObserver.observe(t)
      MPclose.addEventListener("click",()=>{MP.classList.remove("active")})
      MPplay.addEventListener("click",()=>{isPaused=!isPaused;h.classList.toggle("active",isPaused);MPplay.innerHTML=isPaused?'<i class="fas fa-play"></i>':'<i class="fas fa-pause"></i>'})
      function fmtTime(sec){sec=Math.max(0,Math.floor(sec));const m=Math.floor(sec/60);const s=sec%60;return m+":"+(s<10?"0":"")+s}
      function handleSeek(e){if(!currentDuration||currentDuration<=0){seekTime.style.display="none";pp.style.display="none";return}const rect=e.currentTarget.getBoundingClientRect();const x=Math.min(Math.max(0,e.clientX-rect.left),rect.width);const ratio=x/rect.width;const t=ratio*currentDuration;seekTime.style.left=x+"px";seekTime.style.display="block";seekTime.textContent=fmtTime(t);pp.style.left=x+"px";if(a&&a.src){ppImg.src=a.src;pp.style.display="block";ppTime.textContent=fmtTime(t)}}
      ph.addEventListener("mousemove",handleSeek)
      ph.addEventListener("mouseleave",()=>{seekTime.style.display="none";pp.style.display="none"})
      let idleInt=setInterval(function(){const idle=Date.now()-lastPresenceTs>IDLE_AFTER && !v.classList.contains("active") && !a.src;idleOverlay.classList.toggle("active",idle)},1000)
      function seedOrbs(){idleOrbs.innerHTML="";for(let i=0;i<24;i++){const s=document.createElement("span");const x=Math.random()*100;const y=Math.random()*100;const delay=(Math.random()*8).toFixed(2);const dur=(10+Math.random()*10).toFixed(2);s.style.left=x+"%";s.style.top=y+"%";s.style.animationDuration=dur+"s";s.style.animationDelay="-"+delay+"s";idleOrbs.appendChild(s)}}
      seedOrbs()
      openStats.addEventListener("click",function(){statsModal.classList.add("active");document.getElementById("backdrop").classList.add("active");document.body.classList.add("modal-open");renderStats()})
      document.getElementById("backdrop").addEventListener("click",function(){statsModal.classList.remove("active");document.getElementById("backdrop").classList.remove("active");document.body.classList.remove("modal-open")})
      function getStats(){return JSON.parse(localStorage.getItem("stats")||'{"totalPlays":0,"totalSeconds":0,"channels":{},"videos":{}}')}
      function setStats(s){localStorage.setItem("stats",JSON.stringify(s))}
      function bumpPlay(e){const st=getStats();st.totalPlays+=1;const ch=e.channelTitle||"Unknown";st.channels[ch]=(st.channels[ch]||0)+1;const vid=e.videoId||e.title||Math.random().toString(36).slice(2);st.videos[vid]=(st.videos[vid]||{title:e.title||"Untitled",count:0});st.videos[vid].count+=1;setStats(st)}
      setInterval(function(){if(!statsEnabled||isPaused)return;const st=getStats();st.totalSeconds+=1;setStats(st)},1000)
      function renderStats(){const st=getStats();document.getElementById("statTotal").textContent=st.totalPlays.toLocaleString();const mins=Math.floor(st.totalSeconds/60);const hrs=Math.floor(mins/60);const rem=mins%60;document.getElementById("statTime").textContent=(hrs>0?hrs+"h ":"")+rem+"m";document.getElementById("statChannels").textContent=Object.keys(st.channels).length.toString();const topC=Object.entries(st.channels).sort((a,b)=>b[1]-a[1]).slice(0,10);const tc=document.getElementById("topChannels");tc.innerHTML="";topC.forEach(([name,count])=>{const it=document.createElement("div");it.className="top-item";const l=document.createElement("div");l.textContent=name;const r=document.createElement("div");r.textContent=count;it.appendChild(l);it.appendChild(r);tc.appendChild(it)});const topV=Object.entries(st.videos).sort((a,b)=>b[1].count-a[1].count).slice(0,10);const tv=document.getElementById("topVideos");tv.innerHTML="";topV.forEach(([id,obj])=>{const it=document.createElement("div");it.className="top-item";const l=document.createElement("div");l.textContent=obj.title;const r=document.createElement("div");r.textContent=obj.count;it.appendChild(l);it.appendChild(r);tv.appendChild(it)})}
      const code=[38,38,40,40,37,39,37,39,66,65];let pos=0;window.addEventListener("keydown",function(e){if(e.keyCode===code[pos]){pos++;if(pos===code.length){konami.classList.add("active");setTimeout(()=>konami.classList.remove("active"),3000);pos=0}}else{pos=0}})
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){const canvas=document.getElementById("soundWaveCanvas");if(!canvas)return;const ctx=canvas.getContext("2d");const cell=20;const glyphs=["0","1"];const words=["Hatsune Miku","Digital Diva","CV01","39"];let cols=0;let y=[],speed=[],hold=[],last=[];function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;cols=Math.floor(canvas.width/cell);y=new Array(cols).fill(0);speed=Array.from({length:cols},()=>Math.random()*0.5+0.5);hold=new Array(cols).fill(0);last=new Array(cols).fill("0")}function rgba(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgba(${r}, ${g}, ${b}, ${a})`}resize();window.addEventListener("resize",resize);const palette=["#00C6FF","#FF4081"];function draw(){ctx.fillStyle="rgba(0,0,0,0.05)";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.font=`${cell}px monospace`;ctx.shadowColor="rgba(0,0,0,0.8)";ctx.shadowBlur=4;const trail=6;for(let c=0;c<cols;c++){let ch;if(hold[c]>0){ch=last[c];hold[c]--}else if(Math.random()<0.02){ch=words[Math.floor(Math.random()*words.length)];hold[c]=Math.max(2,Math.ceil(ch.length*3));last[c]=ch}else{ch=glyphs[Math.floor(Math.random()*glyphs.length)];last[c]=ch}const x=c*cell;const py=Math.floor(y[c])*cell;ctx.fillStyle=palette[c%palette.length];ctx.fillText(ch,x,py);for(let t=1;t<=trail;t++){const ty=py-t*cell;if(ty<0)break;const fade=1-t/(trail+1);ctx.fillStyle=rgba(palette[c%palette.length],fade*0.9);ctx.fillText(glyphs[Math.floor(Math.random()*glyphs.length)],x,ty)}if(py>canvas.height&&Math.random()>0.975){y[c]=0;speed[c]=Math.random()*0.1+0.1;hold[c]=0;last[c]="0"}y[c]+=speed[c]}requestAnimationFrame(draw)}requestAnimationFrame(draw)});
    </script>

    <script>
      document.addEventListener("DOMContentLoaded",function(){function send(){fetch("/track-visitor",{method:"POST",keepalive:true}).catch(()=>{})}send();document.addEventListener("visibilitychange",function(){if(document.visibilityState==="hidden"){navigator.sendBeacon&&navigator.sendBeacon("/track-visitor")}})});
    </script>
  </body>
</html>

